{"config":{"lang":["es"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"index.html","title":"Welcome to MkDocs","text":""},{"location":"index.html#welcome-to-mkdocs","title":"Welcome to MkDocs","text":"<p>For full documentation visit mkdocs.org.</p>"},{"location":"index.html#commands","title":"Commands","text":"<ul> <li><code>mkdocs new [dir-name]</code> - Create a new project.</li> <li><code>mkdocs serve</code> - Start the live-reloading docs server.</li> <li><code>mkdocs build</code> - Build the documentation site.</li> <li><code>mkdocs -h</code> - Print help message and exit.</li> </ul>"},{"location":"index.html#project-layout","title":"Project layout","text":"<pre><code>mkdocs.yml    # The configuration file.\ndocs/\n    index.md  # The documentation homepage.\n    ...       # Other markdown pages, images and other files.\n</code></pre>"},{"location":"0_Modelo_Capas.html","title":"Modelo Capas","text":""},{"location":"0_Modelo_Capas.html#modelo-de-capas","title":"Modelo de Capas.","text":""},{"location":"0_Modelo_Capas.html#por-que-el-modelo-de-capas","title":"\u00bfPor qu\u00e9 el modelo de capas?","text":"<p>La comunicaci\u00f3n mediante las redes es posible gracias a los diferentes protocolos que han sido programados en los dispositivos. No obstante, si cada fabricante programara su propio protocolo (protocolo propietario), sin seguir ning\u00fan est\u00e1ndar universal, ser\u00eda pr\u00e1cticamente imposible que dispositivos de diferentes fabricantes pudieran comunicarse entre si.</p> <p>Para solventar esta problem\u00e1tica se implementa/propone el modelo de capas, donde se especificaban diferentes niveles, cada nivel acog\u00eda m\u00faltiples protocolos, pero dichos protocolos ten\u00edan que cumplir unas normas b\u00e1sicas dependiendo a la capa a la que pertenecieran. </p>"},{"location":"0_Modelo_Capas.html#que-es-un-protocolo","title":"\u00bfQu\u00e9 es un protocolo?","text":"<p>Un protocolo son una serie de normas/reglas que cada dispositivo debe cumplir para poder hacer cierta tarea (dependiendo del protocolo implementado).</p> <ul> <li> <p>Podemos aprovechar mejor el hardware de la m\u00e1quina anfitriona, ya que estamos ejecutando varios \"ordenadores\" en uno mismo, aprovechando recursos que de otra forma es posible que no se llegaran a usar.</p> </li> <li> <p>Permite ejecutar software que quiz\u00e1 sea incompatible con tu sistema operativo anfitri\u00f3n, ya sea por un motivo de versiones o porque son sistemas operativos diferentes (Windows, Linux, MAC).</p> </li> </ul> <p>Ejemplos de protocolos:</p> <p>\ud83d\udca5 Protocolo ARP: Protocolo que permite a partir de una direcci\u00f3n IP encontrar su direcci\u00f3n f\u00edsica o MAC (capa 2~3).</p> <p>\ud83d\udca5Protocolo IP: Sirve para llevar a cabo la comunicaci\u00f3n a trav\u00e9s de paquetes IP (capa 3).</p> <p>\ud83d\udca5Protocolo TCP/UDP: Protocolos de comunicaci\u00f3n mediante segmentos (capa 4).</p> <p>\ud83d\udca5Protocolo HTTP: Protocolo de aplicaci\u00f3n que permite a partir de un texto plano representar una p\u00e1gina web a trav\u00e9s de un navegador (capa 5)</p> <p>En el mundo de las redes cada protocolo va ligada a una capa o nivel. Es decir, que si hubiera un problema con el protocolo IP (capa 3), solo debemos de centrarnos en las tareas que se realizan en la capa 3, y la soluci\u00f3n a dicho problema lo encontraremos con herramientas o conocimientos que afecten a ese nivel.\u00e7</p> <p>Como hemos dicho cada capa se encarga de sus propios protocolos, aisl\u00e1ndose de los protocolos del resto de capas. No obstante una capa siempre se comunicar\u00e1 con su capa inmediatamente superior o inferior, dependiendo de la direcci\u00f3n de la comunicaci\u00f3n. Por ejemplo, la capa 4, \u00fanicamente podr\u00e1 comunicarse con la capa 3 o con la capa 5.</p> <p>Modelo de referencia OSI.</p> <p>En un primer lugar se crea un modelo de 7 capas, totalmente te\u00f3rico, que nunca lleg\u00f3 a ponerse en pr\u00e1ctica, pero que s\u00ed sirvi\u00f3 de base a otros modelos.</p> <p>Modelo de facto TCP/IP.</p> <p>Este modelo es el que se usa actualmente en la pr\u00e1ctica, se basa en el modelo OSI pero tiene 4 capas.</p> <p>En el modelo TCP/IP se agrupan en una misma capa el nivel  f\u00edsico y de enlace de datos. No obstantes nosotros s\u00ed las dividiremos y hablaremos de capa 1 (capa f\u00edsica) y capa 2 (enlace de datos o acceso a la red).</p> <p>NOTA</p> <p></p> A partir de ahora se har\u00e1 referencia a este modelo (TCP/IP con 5 capas)."},{"location":"0_Modelo_Capas.html#encapsulamiento","title":"Encapsulamiento.","text":"<p>Hemos dicho que un protocolo pertenece a una capa, pero tambi\u00e9n se ha comentado que cada capa se comunica con su capa inmediatamente superior o inferior, dependiendo de si est\u00e1 recibiendo el mensaje o envi\u00e1ndolo.</p> <p>Env\u00edo de informaci\u00f3n.</p> <ul> <li> <p>Cuando enviamos informaci\u00f3n habitualmente se genera en una aplicaci\u00f3n (capa 5), y dichos datos van bajando por la pila de red, es decir, pasa a la capa 4, luego la 3, luego la 2, etc\u2026</p> </li> <li> <p>En cada capa habr\u00e1 un protocolo encargado de hacer algo que permita la comunicaci\u00f3n.</p> </li> <li> <p>Por ejemplo, alguna vez leer\u00e9is que HTTP (capa 5) es un protocolo que funciona mediante TCP (capa 4), haciendo uso de IP (capa 3) y a su vez de Ethernet (capa 2). </p> </li> <li> <p>Cada vez que se env\u00eda informaci\u00f3n, a medida que baja de capa en capa, se va a\u00f1adiendo informaci\u00f3n de cada protocolo, por tanto se van encapsulando cabeceras.</p> </li> </ul> <p>Recepci\u00f3n de informaci\u00f3n.</p> <ul> <li> <p>Cuando recibimos informaci\u00f3n se produce el caso contrario, no lo recibe una aplicaci\u00f3n, si no que dicha informaci\u00f3n primero llega a trav\u00e9s de un medio (cable, fibra, aire) a nuestra tarjeta de red (capa 1), haciendo uso de ciertos protocolos como Ethernet (capa 2), IP (capa 3) y TCP (capa 4) llega finalmente al protocolo que s\u00ed puede comunicarse con la aplicaci\u00f3n, en el caso de HTTP un navegador.</p> </li> <li> <p>En este caso de recibir informaci\u00f3n, en el paso de las capas, de la 1 a la 5, se va aligerando el tama\u00f1o de los datos, es decir, se van desencapsulando las cabeceras.</p> </li> </ul> <p>NOTA</p> <p></p> Obviamente dependiendo del protocolo usado, las cabeceras que se a\u00f1aden a los datos son diferentes, pero siempre en cada nivel se a\u00f1ade o quita una cabecera."},{"location":"0_Modelo_Capas.html#pdu-protocol-data-unit","title":"PDU (Protocol Data Unit).","text":"<p>A nivel de nomenclatura, cada vez que los datos pasan por una capa con sus susodichas cabeceras van recibiendo nombres diferentes. Es decir, cuando a los datos se le a\u00f1ade la cabecera IP en la capa 3, se le pasa a llamar paquete, en caso de que estar en la capa 4 ser\u00e1 un segmento (TCP) o datagrama (UDP), etc.</p>"},{"location":"10_LACP.html","title":"STACK & LACP","text":""},{"location":"10_LACP.html#stack-lacp","title":"STACK &amp; LACP.","text":""},{"location":"10_LACP.html#stacking","title":"STACKING.","text":"<p>La posibilidad de hacer stack con ciertos switches permite que m\u00faltiples equipamientos puedan interconectarse entre s\u00ed, siendo gestionados y funcionando como un mismo equipo. </p> <p>Para hacer un stack debemos contar con switches del mismo fabricante y cuyos modelos sean compatibles entre s\u00ed para hacer el stack. Tambi\u00e9n deben tener la misma versi\u00f3n de sistema operativo (IOS en Cisco).</p> <p>Cada switch tiene un rol:</p> <ul> <li> <p>Activo: Es el switch que se encarga de manejar la configuraci\u00f3n y hacerla efectiva en el resto de switches.</p> </li> <li> <p>Standby: Es el siguiente switch en la cadena de mando, es decir, si el switch Activo cae, \u00e9l se convertir\u00e1 en el activo.</p> </li> <li> <p>Member: Es un switch del stack.</p> </li> </ul> <p>Los switches se suelen conectar por unos puertos especiales para ello, la interconexi\u00f3n entre estos puertos puede ser la que queramos. No obstante, es muy recomendado seguir el siguiente formato de interconexi\u00f3n para tener la mayor redundancia y disponibilidad.</p>"},{"location":"10_LACP.html#lacp-link-aggregation-control-protocol-ieee-8023ad","title":"LACP (Link Aggregation Control Protocol - IEEE 802.3ad).","text":"<ul> <li> <p>El principal objetivo de este protocol es la creaci\u00f3n y gesti\u00f3n de un LAG (Link Aggregation Group). Un LAG permite que varias interfaces de red funcionen como uno solo, de forma que incrementamos el ancho de banda y la redundancia, pues si un enlace cae, el grupo sigue funcionando (pese a que perder\u00e1 ancho de banda). </p> </li> <li> <p>Las interfaces LAG tienen nombres diversos como Portchannel o Etherchannel.</p> </li> <li> <p>Habitualmente el m\u00e1ximo n\u00famero de interfaces que pueden meterse en un mismo equipo es de 8.</p> </li> <li> <p>Cada cierto tiempo (1s-30s) se mandan paquetes \u201cHello\u201d para comprobar que ning\u00fan enlace no se ha ca\u00eddo y seguir mandando tr\u00e1fico por ah\u00ed.</p> </li> <li> <p>LACP permite varias formas de balanceo de carga, bas\u00e1ndose en el flujo, en el origen o destino de la IP, en la MAC, etc. El n\u00famero de opciones implementables depende de fabricante.</p> </li> </ul> <ul> <li> <p>Para que funcione todas las interfaces deben funcionar a la misma velocidad (10M/100M/1G/10G\u2026) y se full d\u00faplex. Si no es as\u00ed se producir\u00e1 un aggregation mismatch.</p> </li> <li> <p>Las interfaces que conforman el LAG deben ir conectadas al mismo equipo l\u00f3gico, es decir, no pueden ir conectados a equipos totalmente independientes f\u00edsica y l\u00f3gicamente (por ejemplo que no est\u00e9n en stack).</p> </li> <li> <p>Cada interfaz, en cada extremo puede configurarse de un modo:</p> <p>\ud83d\udca5   Activo: Env\u00eda paquetes LACP para establecer el portchannel.</p> <p>\ud83d\udca5 Pasivo: Espera la recepci\u00f3n de un paquete LACP para integrar dicha interfaz dentro del portchannel.</p> </li> </ul> <p>Note</p> <p></p>Al menos debe haber una interfaz entre los dos extremos en modo activo."},{"location":"10_LACP.html#ejercicios","title":"Ejercicios.","text":"<p>1)  Explica el proceso que seguir\u00edas para poner en stack 2 switches cisco.</p> <p>2)  Indica la configuraci\u00f3n de un Portchannel en Cisco.</p> <p>3)  Indica la configuraci\u00f3n de un Portchannel en Juniper.</p> <p>4)  Comando en Cisco para determinar una IP destino por cu\u00e1l de las interfaces de un portchannel viajar\u00e1.</p> <p>5)  Comando en Cisco y en Juniper para comprobar el estado de una interfaz portchannel.</p> <p>6)  Dada una red con un servidor con mucho tr\u00e1fico, qu\u00e9 suceder\u00eda si creamos el portchannel balanceando por MAC destino.</p> <p>7)  Busca informaci\u00f3n sobre el protocolo PAgP y MLAG</p>"},{"location":"11_VLANs.html","title":"VLANs","text":""},{"location":"11_VLANs.html#vlans","title":"VLANS.","text":""},{"location":"11_VLANs.html#ventajas-de-usar-vlans","title":"Ventajas de usar VLANs:","text":"<ul> <li> <p>Al segmentar la red por vlans podemos aplicar reglas de seguridad por redes, pudiendo evitar que ciertos equipos asociados a ciertas vlans no tengan acceso a algunos recursos o servicios.</p> </li> <li> <p>Al crear una vlan tambi\u00e9n segmentamos el dominio de broadcast por lo que muchos de los problemas solo afectar\u00e1 a la vlan en la que ocurran, lo que adem\u00e1s nos permitir\u00e1 acotar el problema antes.</p> </li> <li> <p>Combinado con los protocolos de enrutamiento din\u00e1mico las vlans nos permiten crear rutas de backup.</p> </li> <li> <p>Nos permite crear m\u00faltiples redes usando una \u00fanica interfaz de router. En caso de crear redes f\u00edsicas en vez de VLANs, necesitar\u00edamos un puerto en el router por cada red.</p> </li> <li> <p>Podemos aplciar QoS (pol\u00edticas de calidad de servicio) por VLAN.</p> </li> </ul>"},{"location":"11_VLANs.html#conceptos-basicos","title":"Conceptos B\u00e1sicos:","text":"<ul> <li> <p>Las vlans se crean en los switches y se asocian a las interfaces de \u00e9stos.</p> </li> <li> <p>Si una interfaz va a pasar una \u00fanica vlan, como por ejemplo las interfaces que conectan con un PC, se pondr\u00e1n en modo Access.</p> </li> <li> <p>Si las interfaces pasan m\u00e1s de una vlan se pondr\u00e1 el puerto en modo trunk, dicho modo a\u00f1ade una etiqueta a la cabecera con el n\u00famero de la vlan. </p> </li> <li> <p>Existen dos tipos de cabecera (encapsulamiento) </p> <p>\ud83d\udca5 dot1q o ISL. Habitualmente se usa dot1q, pero al menos en cisco, debemos especificarlo.</p> </li> </ul> <ul> <li>De forma opcional en la interfaces trunk se puede indicar una \u00fanica vlan nativa. Esto asociar\u00e1 todo el tr\u00e1fico que venga sin taggear/etiquetar a dicha vlan. Principalmente es usa para equipos que pueden pasar datos en trunk por el plano de datos, pero que para su gesti\u00f3n solo entienden tr\u00e1fico sin etiquetar (ejemplo: puntos de acceso).</li> </ul>"},{"location":"12_VRRP.html","title":"VRRP","text":""},{"location":"12_VRRP.html#alta-disponibilidad-hsrp-vrrp-y-glbp","title":"Alta disponibilidad: HSRP, VRRP y GLBP.","text":"<p>Se trata de una serie de protocolos que tienen como principal finalidad dotar a los equipos de capa 3 (routers o switch multicapa) de una redundancia y permitir una alta disponibilidad. Esto se consigue al comunicar estos equipos de forma que uno haga de maestro/activo y otro/s de respaldo/pasivo. </p> <p>Habitualmente para ello se configura a todos los equipos (activo y pasivos) en un mismo grupo (0-255) y adem\u00e1s se har\u00e1 uso de una IP virtual/f\u00edsica, que ser\u00e1 la que ver\u00e1n los clientes, y la cual siempre que haya al menos un equipo del grupo activo se encontrar\u00e1 disponible. </p> <p>Es importante tener en cuenta, que aunque todos los equipos del grupo tengan la misma IP virtual, a parte tendr\u00e1n su propia IP f\u00edsica de interfaz.</p>"},{"location":"12_VRRP.html#hsrp-hot-standby-router-protocol","title":"HSRP (Hot Standby Router Protocol).","text":"<ul> <li> <p>Es un protocolo propietario de Cisco y es el m\u00e1s antiguo de los 3.</p> </li> <li> <p>Los equipos dentro del grupo HSRP se intercambian paquetes cada cierto tiempo (por defecto 3 segundos) para detectar alguna ca\u00edda. Estos mensajes se mandan mediante multicast 224.0.0.2 al puerto 1985 UDP. Adem\u00e1s se suele especificar un tiempo de espera (holdtime) tras el cual se da por inactivo un router. Este tiempo suele ser por defecto 10 segundos.</p> </li> <li> <p>Para saber qu\u00e9 equipo act\u00faa como maestro se asigna unas prioridades (0-255), siendo 100 el valor por defecto. Aquel equipo con prioridad m\u00e1s alta ser\u00e1 el maestro. En caso de tener la misma prioridad, el equipo con IP f\u00edsica de la interfaz m\u00e1s alta ser\u00e1 el maestro. </p> </li> <li> <p>Cuando el equipo maestro cae, su prioridad baja a 0 y otro equipo le sustituye. Una vez vuelva el maestro, ser\u00e1 de nuevo el router activo.</p> </li> <li> <p>La IP para la gesti\u00f3n del protocolo debe ser una IP virtual. A la IP virtual se le asocia una MAC virtual 0000.5e00.01XX, donde XX es el n\u00famero de grupo VRRP en hexadecimal.</p> </li> </ul>"},{"location":"12_VRRP.html#vrrp-virtual-router-redundancy-protocol","title":"VRRP (Virtual Router Redundancy Protocol).","text":"<ul> <li> <p>Es un protocolo pr\u00e1cticamente id\u00e9ntico a HSRP pero se trata de un protocolo no propietario, por lo que es m\u00e1s habitual su uso.</p> </li> <li> <p>Usa la IP multicast 224.0.0.18 y n\u00famero de protocolo IP 112.</p> </li> <li> <p>Una de las principales diferencias es que la IP del grupo, puede ser virtual o f\u00edsica, mientras que en HSRP debe ser virtual.</p> </li> <li> <p>La MAC asociada a la IP VRRP es  0000.5e00.01XX y los mensajes \u201chello\u201d se mandan con un intervalo de 1 segundo por defecto.</p> </li> <li> <p>No soporta balanceo de carga, aunque se podr\u00eda crear varios grupos y asignar diferentes equipos a diferentes grupos para conseguir un balanceo. No obstante, esto no est\u00e1 recomendado.</p> </li> </ul>"},{"location":"12_VRRP.html#glbp-gateway-load-balancing-protocol","title":"GLBP (Gateway Load Balancing Protocol).","text":"<ul> <li> <p>Protocolo propietario de Cisco que mejora el funcionamiento de HSRP, su principal diferencia frente a HSRP es que puede haber m\u00e1s de un router activos a la vez de tal forma que se pueda realizar un balanceo de carga.</p> </li> <li> <p>Permite configurar pesos para indicar el ancho de banda o tr\u00e1fico que debe llevar cada interfaz.</p> </li> <li> <p>La prioridad por defecto es 100, igual que en VRRP.</p> </li> <li> <p>Permite hasta 1024 grupos por interfaz y hasta 4 IPs virtuales por grupo.</p> </li> <li> <p>Permite autentificaci\u00f3n por contrase\u00f1a.</p> </li> <li> <p>AVG es el router activo como principal: Active Virtual Gateway.</p> </li> <li> <p>AVF son los routers que conforman el grupo GLBP: Active Virtual Forwarder.</p> </li> <li> <p>Las configuraciones se realizan dentro de la interfaz.</p> </li> <li> <p>El balanceo de cargar funciona de la siguiente forma:</p> <p>\ud83d\udca5 El AVG re\u00fane todos las MACs de los AVF y cuando un host pregunta por la MAC de su Gateway le da una MAC de un AVF, al siguiente que pregunta le da otra MAC, etc.</p> </li> </ul>"},{"location":"12_VRRP.html#configuracion-ejemplo","title":"Configuraci\u00f3n Ejemplo.","text":"<p>Warning</p> <p>Todo se configura dentro de la interfaz donde activaremos el protocolo.</p> <p>Configuraci\u00f3n ejemplo en ambos routers:</p> <pre><code>int Gi0/0\nglbp 10 ip 10.0.0.1\nglbp 10 authentication text ochoa\nglbp 10 priority 200\nglbp preempt delay 30\nglbp 10 load-balancing host-dependent\n</code></pre> <ul> <li> <p>El 10 de los ejemplos es el identificador del grupo GLBP, es como un nombre.</p> </li> <li> <p>Configurar la IP virtual (Ej: 10.0.0.1). Se usa una IP libre de la misma red f\u00edsica.</p> </li> <li> <p>Establecer una contrase\u00f1a para unirse al grupo (ochoa).</p> </li> <li> <p>Configurar una prioridad (Ej: 200).</p> </li> <li> <p>Si un router con m\u00e1s prioridad levanta, no tira al otro con menor prioridad que est\u00e1 como maestro hasta que hay una ca\u00edda. No obstante, podemos forzar que el router con mayor prioridad siempre sea el maestro con la opci\u00f3n de \"preempt\". Esto tendr\u00e1 sentido si hay una diferencia de calidad entre el equipamiento que tenemos como maestro/esclavo. Se le puede a\u00f1adir un temporizador de espera, esto es recomendable por si el router o cable est\u00e1 cayendo y levantando continuamente que no haya un cambio de maestro cada pocos segundos.</p> </li> <li> <p>Crear balanceo de carga. Por defecto es Round Robin.</p> </li> </ul>"},{"location":"13_VPN.html","title":"Conceptos B\u00e1sicos","text":""},{"location":"13_VPN.html#vpn-virtual-private-network","title":"VPN (Virtual Private Network).","text":""},{"location":"13_VPN.html#que-es-una-vpn","title":"\u00bfQu\u00e9 es una VPN?","text":"<p>Es una conexi\u00f3n cifrada entre dos extremos, generando por tanto una red virtual y privada entre ellos.</p> <p>Al crear una red virtual, todos los nodos dentro de dicha VPN tendr\u00e1n asignada una IP y puerta de enlace virtual.</p> <p>Es importante comprender que la VPN cifra la conexi\u00f3n pero no evita que se transfieran malwares a trav\u00e9s de \u00e9sta.</p> <p>Al encriptar los datos se produce una carga computacional y un aumento del tama\u00f1o de los paquetes (overhead). Normalmente a mayor seguridad, mayor es el coste computacional de encriptar y desencriptar los paquetes.</p>"},{"location":"13_VPN.html#que-es-una-vpn-site-to-site","title":"\u00bfQu\u00e9 es una VPN site-to-site?","text":"<p>Se usa para interconectar dos redes independientes, normalmente para interconectar dos oficinas para que trabajen de forma segura como si estuvieran ambas en la misma red local.</p> <p>Los equipos que se encargan de establecer esta conexi\u00f3n suele ser el router o firewall en cada oficina.</p> <p>Las redes LAN f\u00edsicas de cada extremo deben ser diferentes de la red virtual de la VPN que se crear\u00e1.</p>"},{"location":"13_VPN.html#que-es-una-vpn-mobile-o-de-acceso-remoto","title":"\u00bfQu\u00e9 es una VPN mobile o de acceso remoto?","text":"<p>Habitualmente se usa cuando uno de los extremos es el servidor VPN que se encarga de gestionar la interconexi\u00f3n (autentificaci\u00f3n, cifrado, ...) y el otro extremo es un dispositivo (port\u00e1til, m\u00f3vil, ...).</p> <p>La autentificaci\u00f3n se realiza a trav\u00e9s de usuario/contrase\u00f1a o certificados digitales.</p> <p>La palabra mobile dentro de \"VPN mobile\" hace referencia a que el cliente puede estar en constante movimiento, independientemente de la red en la que est\u00e9 conectada (calle, biblioteca, casa, ...) podr\u00eda establecer la conexi\u00f3n con la VPN y trabajar como si estuviera dentro de la propia empresa.</p> <p>Se puede usar para navegar por Internet haciendo uso de una conexi\u00f3n cifrada.</p> <p>Si el servidor lo tenemos en nuestra empresa tambi\u00e9n se puede usar para acceder a la LAN de la empresa desde casa, por ejemplo.</p>"},{"location":"13_VPN.html#protocolos-vpn","title":"Protocolos VPN:","text":"<p>Aunque m\u00e1s adelante entraremos en m\u00e1s detalle sobre las diferentes posibilidades de protocolos para implementar VPN vamos a ver un ligero resumen:</p> <ul> <li> <p>PPTP: PPTP es un protocolo muy extendido y compatible con gran cantidad de dispositivos pero [++NO es seguro++].</p> </li> <li> <p>L2TP/IPSec: Al igual que con PPTP es un protocolo bastante sencillo de configurar y ampliamente configurable. A diferencia de PPTP se puede configurar junto con IPSec para hacerlo seguro.</p> </li> <li> <p>IPSec IKEv2: Conexi\u00f3n segura y r\u00e1pida.</p> </li> <li> <p>OpenVPN: Seguro, compatible con bastantes dispositivos y de c\u00f3digo abierto.</p> </li> <li> <p>WireGuard: Seguro, conexi\u00f3n r\u00e1pida, c\u00f3digo abierto, usa pocos recursos.</p> </li> </ul>"},{"location":"13_VPN.html#que-es-split-tunneling-dentro-de-una-vpn","title":"\u00bfQu\u00e9 es Split Tunneling dentro de una VPN?","text":"<p>Por norma general cuando creamos una VPN, todo el tr\u00e1fico sale por la VPN cifrada.</p> <p>Con el Split Tunneling podemos indicar qu\u00e9 tr\u00e1fico viajar\u00e1 a trav\u00e9s de la VPN y cu\u00e1l no.</p> <p>En ciertas situaciones, especialmente en las site-to-site, no queremos que el tr\u00e1fico viaje por la VPN, pues estar\u00edamos ralentizando bastante la conexi\u00f3n.</p>"},{"location":"13_VPN.html#ejemplo","title":"Ejemplo","text":"<p>Si estamos en el site A y queremos acceder a una p\u00e1gina de Internet no tiene sentido viajar hasta el site B y desde ah\u00ed a la p\u00e1gina deseada. </p> <p>Por tanto lo habitual en una VPN site-to-site es importante comprobar que solo viaja por dicha conexi\u00f3n el tr\u00e1fico que vaya a acceder al la LAN del otro extremo.</p>"},{"location":"13_VPN.html#para-que-podemos-interconectar-un-servicio-radius-con-uno-vpn","title":"\u00bfPara qu\u00e9 podemos interconectar un servicio RADIUS con uno VPN?","text":""},{"location":"13_VPN.html#funcionalidades","title":"Funcionalidades.","text":"<ul> <li> <p>Autenticaci\u00f3n:  Hace referencia a comprobar que el usuario es quien dice ser a trav\u00e9s de una contrase\u00f1a o un certificado digital.</p> </li> <li> <p>Autorizaci\u00f3n: Puede gestionar a qu\u00e9 equipos puede acceder dicho usuario y qu\u00e9 comandos puede lanzar.</p> </li> <li> <p>Contabilidad: Puede almacenar en sus registros toda actividad de cada usuario en cada equipo gestionado por el RADIUS.</p> </li> </ul>"},{"location":"13_VPN.html#ventajas","title":"Ventajas:","text":"<ul> <li> <p>Centralizaci\u00f3n: En vez de gestionar X routers/firewalls, solo tendremos que gestionar un equipo para crear/modificar los usuarios y pol\u00edticas de seguridad.</p> </li> <li> <p>Seguridad: Se encarga de la seguridad en el inicio de sesi\u00f3n, de tal forma que si uno de nuestros firewalls es algo antiguo y no soporta ciertos protocolos de inicio de sesi\u00f3n m\u00e1s seguros no habr\u00eda problema.</p> </li> <li> <p>Auditor\u00eda: Permite guardar en los logs centralizados en el servidor cada usuario a qu\u00e9 equipos ha accedido y qu\u00e9 comandos ha lanzado. Tambi\u00e9n se puede impedir que ciertos usuarios accedan a equipos o tengan permisos limitados. De otra forma tendr\u00edamos que hacerlo equipo a equipo (router/firewall).</p> </li> </ul>"},{"location":"13_VPN.html#preguntas-frecuentes","title":"Preguntas Frecuentes","text":"\u00bfSi el firewall VPN (servidor) se encuentra detr\u00e1s de una red NAT qu\u00e9 debemos hacer? <p>Si el servidor VPN est\u00e1 detr\u00e1s de un servicio NAT deberemos abrir los puertos (depender\u00e1n del protocolo de cifrado que seleccionemos).</p> <p>Dichos puertos abiertos obviamente deben ir redirigidos a la IP LAN f\u00edsica que tenga asignada el firewall.</p> \u00bfUn mismo cliente puede conectarse a la vez con dos dispositivos diferentes? <p>Podr\u00eda, pero debemos tenerlo en cuenta en la configuraci\u00f3n del servidor VPN. En algunos fabricantes por defecto se impide esta  casu\u00edstica.</p> \u00bfQu\u00e9 es VPN Passthrough? <p>Es una caracter\u00edstica de los routers que normalmente viene activada por defecto, pero que si no est\u00e1 activada impide el paso del tr\u00e1fico cifrado por VPN.</p> \u00bfPueden varios dispositivos con varios usuarios diferentes, dentro de la misma red NAT (saliendo con la misma IP p\u00fablica), conectarse a la misma conexi\u00f3n VPN? <p>S\u00ed, no hay problema.</p> \u00bfQu\u00e9 sucede si nuestro equipo est\u00e1 infectado y nos conectamos con una VPN a nuestro puesto de trabajo? <p>El virus podr\u00eda transferirse a los equipos conectados a la red de la empresa.</p> \u00bfQu\u00e9 sucede si la red LAN (f\u00edsica) desde donde nos conectamos, es la misma que la parte LAN de la red VPN (virtual) a d\u00f3nde nos vamos a conectar? <p>Habr\u00eda incompatibilidad y ser\u00eda un problema. Por ello se sulene elegir redes poco comunes como parte de la red virtual de la VPN, es decir, se evitan los 192.168.0.0/24 o 192.168.1.0/24 que son habituales en lo hogares por ejemplo.</p>"},{"location":"14_PPTP.html","title":"PPTP","text":""},{"location":"14_PPTP.html#pptp-point-to-point-tunneling-protocolo","title":"PPTP (Point-To-Point Tunneling Protocolo).","text":"<p>PPTP  creado en 1999 es un protocolo VPN no seguro. </p> <p>Se intent\u00f3 hacer m\u00e1s robusta mediante el protocolo de seguridad MS-CHAPv2, no obstante por un problema de dise\u00f1o se pod\u00eda conseguir reducir la seguridad de \u00e9ste.</p> <p>Su uso sigue extendido en cierta forma debido a razones como:</p> <ul> <li> <p>Muy f\u00e1cil de configurar.</p> </li> <li> <p>Es compatible con la gran mayor\u00eda de dispositivos y sistemas operativos.</p> </li> <li> <p>Al llevar un cifrado m\u00e1s ligero no realiza tanto impacto en la navegaci\u00f3n descarga de ficheros a trav\u00e9s de una VPN.</p> </li> <li> <p>Al llevar un cifrado m\u00e1s ligero tampoco necesitas mucha potencia si debes mantener un servidor PPTP con muchas conexiones.</p> </li> </ul>"},{"location":"14_PPTP.html#caracteristicas","title":"Caracter\u00edsticas:","text":"<ul> <li> <p>Puerto 1723 TCP.</p> </li> <li> <p>Puede hacer uso de varios protocolos de seguridad:</p> <p>\ud83d\udca5   PAP (Texto Plano)</p> <p>\ud83d\udca5 CHAP (Challenge-Handshake Authentication Protocol)</p> <p>\ud83d\udca5 MS-CHAPv1 y MS-CHAPv2</p> </li> <li> <p>Hace uso del protocolo GRE para establecer el t\u00fanel:</p> <p>\ud83d\udca5   El protocolo GRE no cifra nada, lo \u00fanico que hace es a\u00f1adir una cabecera IP y una peque\u00f1a cabera con informaci\u00f3n del t\u00fanel GRE.</p> <p>\ud83d\udca5   El router, por defecto (sin aplicar reglas de firewall), solo va a ver la IP origen y destino (lilas) y lo ir\u00e1 enrutando.</p> <p>\ud83d\udca5   Cuando llegue al destino de la IP GRE (Lila) se desencapsula y entonces se mira la IP del t\u00fanel y se redirige a este segundo destino.</p> </li> </ul> \u00bfQu\u00e9 pasar\u00eda si con otro protocolo pudi\u00e9ramos cifrar los datos originales transportados mediante GRE, es decir, la parte amarilla? <p>Podr\u00edamos transportar tr\u00e1fico sin indicar quien es realmente el destinatario, sin exponer el puerto donde conecta ni los datos. Nos dar\u00eda pie a poner una mini capa nueva de seguridad.</p> \u00bfQu\u00e9 puedo hacer si necesito usar un protocolo de red diferente a IP entre dos routers en redes diferentes y los routers intermedio no entienden ese protocolo y por tanto no pueden enrutar dichos paquetes? <p>Una posibilidad, aunque no es la mejor soluci\u00f3n, ser\u00eda hacer un t\u00fanel GRE entre esos routers, de esta forma los routers intermedios estar\u00edan viendo el protocolo IP que s\u00ed entienden.</p>"},{"location":"14_PPTP.html#pptp-con-ms-chapv2","title":"PPTP con MS-CHAPv2.","text":"<p>MS-CHAPv2 es el protocolo de autentificaci\u00f3n, es decir los pasos que se deben seguir para asegurar la autentificaci\u00f3n de los dos extremos, en este caso entre el cliente y el servidor PPTP.</p> <ul> <li> <p>Para autentificar el usuario hace uso de usuario/contrase\u00f1a, pero el mensaje MS-CHAP puede comprobar esta contrase\u00f1a sin necesidad de que viaje por Internet.</p> </li> <li> <p>El nombre de usuario viaja en texto plano.</p> </li> <li> <p>Debido a que el algoritmo de Cifrado DES es inseguro implemente una especie de 3DES, es decir, cifra el mismo mensaje de autentificaci\u00f3n con 3 algortimos DES diferente. Cada algoritmo se encarga de cifrar una parte del mensaje, del byte 0 al 6 con un DES, del byte 7 al 13 con otro DES y del 14 al 20 con otro DES diferente. </p> </li> </ul>"},{"location":"14_PPTP.html#pasos-para-establecer-la-conexion","title":"Pasos para establecer la conexi\u00f3n:","text":"<ol> <li> <p>El servidor:</p> <ol> <li>Manda un Challenge (SC) (16 bits aleatorios).</li> </ol> </li> <li> <p>El cliente:</p> <ol> <li> <p>Genera su propio Challenge (CC) (16 bits aleatorios).</p> </li> <li> <p>Unifica en un mismo mensaje el Challenge del Servidor (SC) + Challenge Cliente (CC) + nombre usuario.</p> </li> <li> <p>Crea una cadena hash con MD5 sobre la contrase\u00f1a y genera una salida de 128 bits (16 bytes).</p> </li> <li> <p>Crea una cadena hash funci\u00f3n hash SHA1 que genera una salida de 160 bits (20 bytes).</p> </li> <li> <p>Esta cadena hash SHA1 de 20 bytes se cifra por trozos usando un total de 3 algoritmos DES.</p> <ol> <li> <p>Al estar usando 3 algoritmos DES independiente, necesitamos 3 claves DES diferente, por lo que usamos el MD5 (16 bytes) para ello.</p> </li> <li> <p>Cada clave usar\u00e1 7 bytes y necesitamos 3 claves, por tanto 21 bytes. Pero MD5 solo tiene 16 bytes, as\u00ed que a\u00f1adimos 5 bytes vac\u00edos (ceros) al final del MD5 y as\u00ed obtenemos 21 bytes. Del 1 \u2013 7 es la clave del primer DES, del 8 al 14 del segundo DES y del 15 al 21 byte del MD5 ser\u00e1 la tercera clave para el cifrado sim\u00e9trico.</p> </li> </ol> </li> <li> <p>Se env\u00eda al servidor tanto la salida SHA1, como la cadena SHA1 cifrada con 3DES, como el nombre de usuario en texto plano.</p> </li> </ol> </li> <li> <p>El servidor:</p> <ol> <li> <p>Conoce el SC (\u00e9l lo cre\u00f3 y lo envi\u00f3).</p> </li> <li> <p>Recibe el nombre del usuario en texto plano.</p> </li> <li> <p>Al saber el nombre del usuario tambi\u00e9n conoce su contrase\u00f1a pues puede mirarlo en su base de datos. Adem\u00e1s si aplica MD5 sobre dicha contrase\u00f1a obtendr\u00e1 la misma funci\u00f3n hash que ten\u00eda el cliente.</p> </li> <li> <p>Como las claves usadas en 3DES provienen del MD5, podemos obtener las claves, descifrar el mensaje y compararlo con el SHA1 recibido para ver si es el mismo. Si es el mismo el cliente est\u00e1 autentificado.</p> </li> </ol> </li> </ol>"},{"location":"14_PPTP.html#debilidades","title":"Debilidades:","text":"<ul> <li> <p>El nombre de usuario viaja en texto plano.</p> </li> <li> <p>La contrase\u00f1a que se usa con MD5 no lleva \u201csalt\u201d, es decir, si la contrase\u00f1a es \u201cCiberSeguridad\u201d esto genera siempre la misma clave hash de 128 bits. A\u00f1adir un salt quiere decir a\u00f1adir un texto aleatorio a la contrase\u00f1a para que el hash creado sea siempre diferente.</p> <p>\ud83d\udca5 Esta debilidad permitir\u00eda hacer un ataque por diccionario o de fuerza bruta si se consigue la contrase\u00f1a hasheada.</p> </li> <li> <p>En el caso de la implementaci\u00f3n \u201crara\u201d que se hace de 3DES el tercer tramo sabemos que ha sido autentificado con una clave DES cuyos \u00faltimos 5 bytes son 0, por lo que es f\u00e1cil de romper esta parte y de aqu\u00ed debilita los otros dos DES restantes.</p> <p>\ud83d\udca5 F\u00e1cil de romper.</p> <p>\ud83d\udca5 Si obtienes el MD5 puedes romper el cifrado.</p> </li> <li> <p>Haciendo un MITM podr\u00edas obtener el nombre de usuario, el SC (Server Challenge) y el Response Challenge (el hash SHA1 del SC+CC+User), por lo que probando combinaciones de 16 bits y luego creando la hash del SHA1  y compar\u00e1ndolo con el capturado podr\u00edas averiguar el CC.</p> </li> <li> <p>MD5 tiene la debilidad que dos entradas diferentes pueden generar el mismo output, es decir, que un hacker puede crear un fichero que genere un hash id\u00e9ntico al de otro fichero diferente.</p> <p>\ud83d\udca5 Esto hace que MD5 no permita cumplir la integridad.</p> </li> </ul>"},{"location":"15_Ataque_PPTP.html","title":"Ataque PPTP","text":""},{"location":"15_Ataque_PPTP.html#atacar-servidor-vpn-pptp-mschapv2","title":"Atacar servidor VPN PPTP MSCHAPv2.","text":""},{"location":"15_Ataque_PPTP.html#fingerprint","title":"Fingerprint.","text":"<p>En primer lugar vamos a recoger informaci\u00f3n del servidor (fingerprint).</p> <pre><code>nmap -Pn -sSV -p1723 [IP SERVIDOR]\n</code></pre> <p>Podemos ver el puerto que est\u00e1 abierto usando PPTP, adem\u00e1s de que es un Mikrotik con firmware 1.</p>"},{"location":"15_Ataque_PPTP.html#diccionarios","title":"Diccionarios.","text":"<p>Durante el ataque habr\u00e1 un momento que haremos un ataque por diccionario. </p> <p>Para ello tenemos varias opciones:</p> <p>En el directorio /usr/share/wordlists de nuestro Kali tenemos la lista de palabras de diccionario.</p> <ol> <li> <p>\u201crockyou\u201d es una de las m\u00e1s famosas, simplemente contiene palabras t\u00edpicas que se suelen usar como contrase\u00f1a. Se puede descomprimir con \u201cgunzip rock\u2026.\u201d.</p> <p></p> <p></p> </li> <li> <p>Tambi\u00e9n podemos hacer uso de la lista \u201cdarkc0de\u201d. u otros diccionarios de referencia.</p> <pre><code>wget https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/darkc0de.txt\n\nwget https://github.com/danielmiessler/SecLists/blob/master/Passwords/openwall.net-all.txt\n\nwget https://github.com/danielmiessler/SecLists/raw/master/Passwords/Software/john-the-ripper.txt\n</code></pre> </li> <li> <p>En caso de no existir la ruta /usr/share/wordlists podemos hacer:</p> <pre><code>sudo apt install wordlists \u2013-reinstall\n</code></pre> </li> </ol>"},{"location":"15_Ataque_PPTP.html#comandos","title":"Comandos.","text":"<p>Vamos a trabajar con 3 comandos:</p> <p>genkeys: Para generar e indexar claves hash a partir de una lista de palabras, que luego nos permitir\u00e1 comparar con las claves hash que capturemos.</p> <p>asleap: Permite, a partir de los c\u00f3digos \u201cchallenge\u201d y \u201cresponse\u201d del protocolo MSCHAP compararlos con los diferentes hash de nuestro \u00edndice, generados por genkeys a partir de las palabras de diccionario. Tambi\u00e9n te permite pasarle una captura de paquetes, por ejemplo de wireshark, y que \u00e9l te sustraiga los elementos necesarios.</p> <p>thc-pptp-bruter: Permite, a partir de la IP del firewall y del nombre de usuario, romper la clave por fuerza bruta en caso de que el ataque por diccionario no funcione, aunque tambi\u00e9n se le puede pasar una lista de palabras al comando.</p>"},{"location":"15_Ataque_PPTP.html#mitm-man-in-the-middle","title":"MITM (Man In The Middle)","text":"<ul> <li> <p>Para realizar el ataque MITM (Man In The Middle) ARP Poisoning haremos uso de la aplicaci\u00f3n \u201cEttercap\u201d (ver manual Ettercap). </p> </li> <li> <p>El ARP Poisoning nos permitir\u00e1 hacernos pasar por el servidor VPN y a su vez hacernos pasar por la v\u00edctima, interceptando as\u00ed todo el tr\u00e1fico entre ellos. </p> </li> <li> <p>Una vez capturado, el tr\u00e1fico se reenviar\u00e1 al destinatario (servidor/cliente) correcto para que siga habiendo comunicaci\u00f3n entre ellos y podamos seguir capturando el resto de la conversaci\u00f3n.</p> </li> </ul>"},{"location":"15_Ataque_PPTP.html#analizar-trafico-capturado","title":"Analizar tr\u00e1fico capturado.","text":"<p>Una vez realizado el MITM analizaremos con Wireshark el tr\u00e1fico capturado.</p>"},{"location":"15_Ataque_PPTP.html#nombre-de-usuario","title":"Nombre de usuario.","text":"<p>Primero filtraremos por el protocolo \u201cchap\u201d, que es el protocolo de seguridad que usa PPTP.</p> <p>Como se puede comprobar en la captura anterior, el nombre de usuario viaja en texto plano.</p> <p>Ataque Fuerza Bruta</p> <p>A partir de aqu\u00ed podemos intentar solventarlo sabiendo el usuario y la IP del servidor por fuerza bruta, pero es un proceso mucho m\u00e1s lento.</p> <pre><code>cat darkc0de.txt | thc-pptp-bruter \u2013u [Nombre_Usuario] [IP_Servidor]\n</code></pre> <p></p> <p>No obstante vamos, primero a probar un ataque por diccionario, para que en caso de que sea una contrase\u00f1a \u201csencilla\u201d podamos romperla de forma r\u00e1pida.</p>"},{"location":"15_Ataque_PPTP.html#challenge-y-response","title":"Challenge y Response.","text":"<p>A parte del usuario, podemos sacar informaci\u00f3n del c\u00f3digo hash del \u201cChallenge\u201d y del \u201cResponse\u201d del protocolo MSCHAPv2.</p> <p>Para copiar datos dentro de wireshark es preferible darle a bot\u00f3n derecho \u2013 Copiar \u2013 Hex Stream.</p>"},{"location":"15_Ataque_PPTP.html#ataque-por-diccionario","title":"Ataque por diccionario.","text":"<p>A continuaci\u00f3n nos bajamos el script \"chap2asleap\" que har\u00e1 uso de los comandos \u201casleap\u201d y \u201cgenkeys\u201d para romper la seguridad.</p> <p>chap2asleap</p> <p>Se deber\u00eda de encontrar en el Escritorio del Kali o se puede descargar.</p> <pre><code>git clone https://github.com/xiao106347/chap2asleap.git\n</code></pre> <p>Ejecutamos el script  de python con la siguiente informaci\u00f3n:</p> Comando  Funci\u00f3n  <code>\u2013u</code> Usuario <code>\u2013c Challenge</code> Sacado del wireshark en hexadecimal. <code>\u2013r Response</code> Sacado del wireshark en hexadecimal. <code>-x</code> Para que ejecute todo el proceso. <code>\u2013p</code> La ruta donde se encuentra el comando asleap. <code>-d</code> La ruta donde se encuentra la lista de diccionario. El propio script se ocupa de indexarlo en claves hash mediante genkeys. <code>-v</code> Para que te vaya sacando informaci\u00f3n del proceso que va realizando. <p>Contrase\u00f1a Robusta</p> <p>En el caso de que la contrase\u00f1a fuese m\u00e1s compleja, por ejemplo, \u201cA#i4-\u2026\u201d, el ataque por diccionario no funcionar\u00eda y deber\u00edamos usar el ataque por fuerza bruta.</p>"},{"location":"16_OpenVPN.html","title":"OpenVPN & Wireguard","text":""},{"location":"16_OpenVPN.html#openvpn-wireguard","title":"OpenVPN &amp; Wireguard.","text":""},{"location":"16_OpenVPN.html#openvpn","title":"OpenVPN","text":"<ul> <li> <p>Software de c\u00f3digo abierto para establecer VPNs.</p> </li> <li> <p>Al ser de c\u00f3digo abierto cualquiera pueda ver si hay parte del c\u00f3digo malintencionado o alguna vulnerabilidad que se pueda corregir. Esto da mayor confianza en su uso, tiene licencia GPL.   </p> </li> <li> <p>Se basa en encriptaci\u00f3n SSL (usado tambi\u00e9n en HTTPS) que usa algoritmos asim\u00e9tricos para el handshake y sim\u00e9trico para el cifrado de los datos.</p> </li> <li> <p>Tiene dos vertientes:</p> <p>\ud83d\udca5   OpenVPN UDP: M\u00e1s eficaz y r\u00e1pido que el modo TCP. Configuraci\u00f3n por defecto.</p> <p>\ud83d\udca5   OpenVPN TCP: Mayor control ante de la p\u00e9rdida de paquetes. M\u00e1s lento.</p> </li> <li> <p>Funciona en todas las plataformas (Windows, Linux y MAC)</p> </li> </ul>"},{"location":"16_OpenVPN.html#wireguard-vpn","title":"Wireguard VPN.","text":"<ul> <li> <p>Es f\u00e1cil de configurar.</p> </li> <li> <p>Su c\u00f3digo es peque\u00f1o, lo que lo hace m\u00e1s eficiente y f\u00e1cil de revisar.</p> </li> <li> <p>Junto con el eficiente c\u00f3digo y el uso de UDP le otorga mayor velocidad de transmisi\u00f3n y una latencia m\u00e1s baja que OpenVPN</p> </li> <li> <p>Permite mantener la VPN incluso cuando cambiamos de IP, por ejemplo al pasar de una cafeter\u00eda a datos m\u00f3viles.</p> </li> <li> <p>Usa cifrados Curve25519 (cifrado asim\u00e9trico \u2013 DH), ChaCha20 (Cifrado sim\u00e9trico), Poly1305 (Hash) entre otros.</p> </li> <li> <p>Se encuentra programado dentro del kernel Linux, lo que lo hace muy r\u00e1pido para m\u00f3viles, servidores, routers\u2026</p> </li> <li> <p>WireGuard est\u00e1 escrito en los lenguajes C y Go y es compatible con Windows, macOS, BSD, iOS y Android.</p> </li> <li> <p>Cuando el usuario no est\u00e1 enviando datos a trav\u00e9s del t\u00fanel, WireGuard se mantiene en stand-by. De esta forma se ahorra energ\u00eda y se alarga la autonom\u00eda de la bater\u00eda. Es decir, no se env\u00edan tramas de control de la conexi\u00f3n.</p> </li> </ul>"},{"location":"16_OpenVPN.html#ejemplo-de-configuracion-en-el-servidor","title":"Ejemplo de configuraci\u00f3n en el servidor.","text":""},{"location":"16_OpenVPN.html#ejemplo-de-configuracion-en-el-cliente","title":"Ejemplo de configuraci\u00f3n en el cliente.","text":""},{"location":"16_OpenVPN.html#comparativa","title":"Comparativa","text":""},{"location":"17_IPSec.html","title":"IPSec","text":""},{"location":"17_IPSec.html#l2tpipsec","title":"L2TP/IPSec.","text":""},{"location":"17_IPSec.html#l2tp","title":"L2TP","text":"<p>El protocolo L2TP se encarga de crear un t\u00fanel entre los dos extremos (cliente \u2013 servidor), dentro del t\u00fanel viajar\u00e1n los datos de la VPN. No obstante L2TP no encripta los datos, por lo que usar L2TP sin IPSec no tiene sentido, pues para ello ya podr\u00edamos optar por PPTP (el cual hemos visto que tampoco es seguro).</p> <p>L2TP es a grandes rasgos muy parecido a PPTP y sufre de los mismos problemas, solo lo vamos a usar para establecer la conexi\u00f3n.</p> <p>Tambi\u00e9n cabr\u00eda la posibilida de usar \u00fanicamente IPSec.</p>"},{"location":"17_IPSec.html#ipsec","title":"IPSec","text":"<p>El protocolo IPSec se ocupa de encriptar los datos que se transfieren en el t\u00fanel L2TP entre el cliente y el servidor VPN. </p> <p>Su finalidad es la de dotar a la comunicaci\u00f3n de:</p> <ul> <li> <p>Confidencialidad: Nadie pueda leer el contenido al estar cifrado.</p> </li> <li> <p>Integridad: Nadie pueda modificar el contenido. Esto se consigue al comparar un hash del tr\u00e1fico enviado.</p> </li> <li> <p>Autenticaci\u00f3n: A trav\u00e9s de usuarios/contrase\u00f1as/contrase\u00f1as compartidas/certificados se garantiza la autenticidad de los extremos.</p> </li> <li> <p>Evitar ataques Replay: A trav\u00e9s del uso de n\u00fameros de secuencia IPSec no permite el reenv\u00edo de paquetes duplicados.</p> </li> </ul> <p>Dentro del proceso de IPSec se sigue el protocolo IKE (Internet Key Exchange) / ISAKMP (Internet Security Association and Key Management Protocol) para acordar entre el cliente y el servidor VPN en el tipo de algoritmos de cifrado que se van a implementar en las comunicaciones. </p> <p>ISAKMP es un framework, establece el formato de los paquetes y el tipo de mensajes disponibles para establecer/modificar/romper una SA (Asociaci\u00f3n de Seguridad). Un SA es establecido entre dos extremos cuando han llegado a un acuerdo de qu\u00e9 tipo de seguridad (qu\u00e9 tipo de cifrado sim\u00e9trico, qu\u00e9 algoritmos de hash, si usaran cifrado asim\u00e9trico, etc) van a usar para intercambiarse la informaci\u00f3n y permitir por tanto establecer una seguridad.</p> <p>IKE es el protocolo que establece las comunicaciones seguras entre los extremos, para ello hace uso del framework ISAKMP para establecer los SA entre los extremos. Existen dos versiones del protocolo IKEv1 e IKEv2. Consta de 2 fases.</p>"},{"location":"17_IPSec.html#ike-fase-1","title":"IKE Fase 1.","text":"<p>Se negocia los protocolos/algoritmos de encriptaci\u00f3n, hashing, autenticaci\u00f3n que se van a usar. Una vez decidido se establece una sesi\u00f3n (t\u00fanel IKE PHASE 1) entre ambos usando dichos protocolos/algoritmos, creando una SA (Security Association) y procediendo a la autenticaci\u00f3n del usuario. </p> <p>El t\u00fanel de la fase 1 se puede establecer en modo agresivo o en modo normal. El modo agresivo env\u00eda menos mensajes y es m\u00e1s r\u00e1pido de conectar, es m\u00e1s inseguro y por tanto no se recomienda, al no ser que en una vpn site-to-site tengan IPs din\u00e1micas en alg\u00fan extremo.</p>"},{"location":"17_IPSec.html#mensajes-en-fase-1","title":"Mensajes en Fase 1:","text":"<p>Se env\u00eda una propuesta de los par\u00e1metros soportados para establecer una SA (ISAKMP):</p> <p>\ud83d\udca5 Tipo de autentificaci\u00f3n: PSK o Certificado Digital.</p> <p>\ud83d\udca5 Algoritmos Hash: md5, shaX.</p> <p>\ud83d\udca5 Algoritmo de Encriptaci\u00f3n Sim\u00e9trica: 3DES, AES\u2026</p> <p>\ud83d\udca5 Grupos DH soportado: Group 1, 2, 5, 14, 22 \u2026</p> <p>\ud83d\udca5 Lifetime, es decir, tiempo de vida que ser\u00e1 v\u00e1lido este t\u00fanel de seguridad.</p>"},{"location":"17_IPSec.html#key-generation-information","title":"Key Generation Information:","text":"<ul> <li> <p>En esta fase se usa DH para generar a partir de un valor p\u00fablico (n\u00famero primo), un nonce y la clave PSK (Ver apuntes de SSH para repasar el concepto matem\u00e1tico del algoritmo DH):</p> <p>\ud83d\udca5   Una clave que sirve para autentificar.</p> <p>\ud83d\udca5   Una clave que sirve para cifrar.</p> </li> </ul>"},{"location":"17_IPSec.html#identify-and-authentication-info","title":"Identify and Authentication Info.","text":"<p>\ud83d\udca5   Usando las claves del apartado anterior se autentifica al usuario viendo si tiene la clave precompartida correcta, o similar en el caso de usar certificados digitales.</p>"},{"location":"17_IPSec.html#ike-fase-2","title":"IKE Fase 2.","text":"<p>Una vez establecida la seguridad de la fase 1, se establece una segunda asociaci\u00f3n (SA) por cada servicio, en nuestro caso dicho servicio ser\u00e1 IPSec. Por tanto, se vuelve a negociar qu\u00e9 protocolos/algoritmos se va a utilizar para establecer la seguridad, en este caso del protocolo IPSec, una vez negociado se crea un segundo t\u00fanel que cifrar\u00e1 los datos del cliente.</p> <p>Entre los par\u00e1metros que se negocian est\u00e1n los siguientes:</p> <ul> <li> <p>IPsec Protocol: AH o ESP</p> </li> <li> <p>Modo de encapsulaci\u00f3n: Modo transporte o t\u00fanel.</p> </li> <li> <p>Encriptaci\u00f3n: DES, 3DES o AES.</p> </li> <li> <p>Autentificaci\u00f3n: MD5 or SHA.</p> </li> <li> <p>Lifetime: Durante cu\u00e1nto tiempo es v\u00e1lido el t\u00fanel, pasado el tiempo se debe renegociar y recrear el t\u00fanel de nuevo. </p> </li> <li> <p>DH: Grupo que se usar\u00e1 junto con la clave compartida PSK + \u201cnonce\u201d certificar  la autenticaci\u00f3n y para intercambiar la clave sim\u00e9trica.</p> </li> </ul>"},{"location":"17_IPSec.html#ah-o-esp","title":"AH o ESP:","text":"<p>Son los protocolos que proporcionan seguridad utilizando las algoritmos de cifrado/hash/claves, etc.</p> <ul> <li> <p>AH (Authentication Header): Proporciona Integridad y Autenticaci\u00f3n.</p> </li> <li> <p>ESP (Encapsulating Security Payload): Proporciona Integridad, Autenticaci\u00f3n y Confidencialidad.</p> </li> </ul> <p>AH</p> <p>Ambos soportan autentificaci\u00f3n e integridad, pero solo ESP permite encriptaci\u00f3n del paquete IP, por lo que suele ser el elegido de los dos.</p> <p>Existen dos modos de configurar estos protocolos, en modo transporte o modo t\u00fanel. </p> <ul> <li>Modo transporte: Se saben las IPs que establecen la conexi\u00f3n VPN. Se suele usar cuando queremos dotar de seguridad a un protocolo inseguro (telnet). Es m\u00e1s r\u00e1pido y tiene menos overhead.</li> </ul> <ul> <li>Modo t\u00fanel: Se enmascara las direcciones que realmente establecen el t\u00fanel. Es el modo que se suele usar, aunque al tener que a\u00f1adir el encabezado para el t\u00fanel estamos agregando overhead a nuestros paquetes.</li> </ul>"},{"location":"17_IPSec.html#ejemplo-ah","title":"Ejemplo AH:","text":""},{"location":"17_IPSec.html#ejemplo-esp","title":"Ejemplo ESP:","text":""},{"location":"17_IPSec.html#dh-exchange-key-cifrado-asimetrico","title":"DH Exchange Key (Cifrado Asim\u00e9trico):","text":"<p>Permite, a trav\u00e9s de cifrado asim\u00e9trico, transmitir informaci\u00f3n de modo seguro, como podr\u00eda ser la clave sim\u00e9trica (3DES/AES) que posteriormente cifrar\u00e1 los datos del usuario. </p> <p>Mediante las claves p\u00fablicas/privadas de cada extremo, la clave precompartida (PSK) y un \u201cnonce\u201d se genera una clave hash que permite autentificar a los usuarios.</p> <p>Una vez realizado este \u00faltimo paso ya se tendr\u00e1 un t\u00fanel en el cual se podr\u00e1 usar de forma segura un cifrado sim\u00e9trico y adem\u00e1s se ha comprobado que el otro extremo es parte del sistema al tener la clave precompartida. Por lo que el tr\u00e1fico ya va correctamente cifrado y podemos autentificar al usuario/contrase\u00f1a mediante L2TP (mschap2/chap) pero con IPSeC por encima.</p> <p>Cuanto m\u00e1s alto el grupo que se use, mayor seguridad a costa de mayor tiempo de computaci\u00f3n.</p> <p>DH Key Group</p> <p>\ud83d\udca5 No usar menos de DH 2048 bits.</p> <p>\ud83d\udca5 Evitar grupos 1, 2, 22, 23 y 24.</p> <p>En la fase 2 tenemos la opci\u00f3n de activar PFS (Perfect Forward Secrecy). Esto obligar\u00e1 a volver a computar otras claves asim\u00e9tricas de DH diferentes a la de la fase 1.</p>"},{"location":"17_IPSec.html#des-3des-o-aes","title":"DES, 3DES o AES:","text":"<p>El principal problema de los cifrados sim\u00e9tricos es como compartir la clave sim\u00e9trica. Para solventar este problema se ha usado criptograf\u00eda asim\u00e9trica (DH). Una vez compartida la clave sim\u00e9trica el resto de datos pueden ir cifrados con un algoritmo de cifrado sim\u00e9trico, esto tiene menor coste computacional y permite un mayor rendimiento. </p> <p>CIFRADO SIM\u00c9TRICO</p> <p>\ud83d\udca5 DES no es seguro.</p> <p>\ud83d\udca5 Se recomienda el uso de AES 256 bits como m\u00ednimo.</p>"},{"location":"17_IPSec.html#md5-o-sha","title":"MD5 o SHA:","text":"<p>Se usan dichos algoritmos hash para verificar la integridad de los paquetes, confirmar que no hayan sido modificados por nadie. Se recomienda SHA256 como m\u00ednimo. </p> <p>Son algoritmos one-way.</p> <p>Tambi\u00e9n es usado por AH o ESP para confirmar la autentificaci\u00f3n de los usuarios. </p> <p>MD5 o SHA1</p> <p>Tanto md5 o sha1 no son seguros.</p>"},{"location":"17_IPSec.html#servidor-vpn-detras-de-un-nat","title":"Servidor VPN detr\u00e1s de un NAT.","text":"<p>Es importante tener en cuenta que este tipo de protocolos pueden tener problemas si el servidor VPN se encuentra detr\u00e1s de un NAT. Para ello se tiene que:</p> <ul> <li> <p>Activar NAT-T (Traversal) en la parte del servidor.</p> </li> <li> <p>Permitir en el firewall el puerto UDP 4500 para el NAT-T</p> </li> <li> <p>El router del cliente debe tener activado VPN Passthrough, para que deje pasar el tr\u00e1fico VPN del cliente. En los routers dom\u00e9sticos actuales ya suele venir activado por defecto.</p> </li> </ul>"},{"location":"17_IPSec.html#puertos","title":"Puertos.","text":"<ul> <li> <p>1701: Tr\u00e1fico L2TP.</p> </li> <li> <p>500: ISAKMP.</p> </li> <li> <p>4500 UDP: NAT-T.</p> </li> </ul>"},{"location":"17_IPSec.html#ikev1-vs-ikev2","title":"IKEv1 vs IKEv2","text":"<p>Recordemos que existen dos versiones del protocolo IKE.</p> <p>Entre las principales ventajas de IKEv2 se encuentran las siguientes:</p> <ul> <li> <p>Se elimina el modo agresivo.</p> </li> <li> <p>Mantiene los m\u00e9todos de negociaci\u00f3n mediante PSK como Certificados Digitales (RSA).</p> </li> <li> <p>Usa NAT Transversal por defecto, mientras que en el caso de IKEv1 era una extensi\u00f3n.</p> </li> <li> <p>Permite el uso de EAP.</p> </li> <li> <p>Mayor protecci\u00f3n contra ataques de DDoS.</p> </li> <li> <p>Usa menos mensajes para establecer la SA.</p> </li> <li> <p>Mayor soporte a conexiones VPN m\u00f3viles, que vayan cambiando de lugar sin desconectarse.</p> </li> </ul> <p>COMPATIBILIDAD</p> <p>IKEv2 e IKEv1 no son compatibles, si configuramos un servidor VPN deber\u00e1 ser eligiendo una de las dos y nuestros clientes deber\u00e1n soportar dicha elecci\u00f3n.</p>"},{"location":"18_DMVPN.html","title":"DMVPN","text":""},{"location":"18_DMVPN.html#dmvpn-dynamic-multipoint-vpn","title":"DMVPN (Dynamic Multipoint VPN).","text":"<p>Es un protocolo creado por Cisco, no obstante se basa en 3 protocolos no propietarios, por lo que es factible la implementaci\u00f3n de un protocolo similar por otros fabricantes.</p> <p>La idea detr\u00e1s de DMVPN es generar conexiones seguras VPN de forma din\u00e1mica, habitualmente entre un concentrador (HUB) y varios nodos (SPOKE).</p>"},{"location":"18_DMVPN.html#protocolos","title":"Protocolos.","text":""},{"location":"18_DMVPN.html#nhrp","title":"NHRP","text":"<ul> <li> <p>Permite a los SPOKE descubrir el HUB. </p> </li> <li> <p>Permite transportar tr\u00e1fico multicast/broadcast a trav\u00e9s del t\u00fanel como si se encontraran en la misma red, lo que nos permite que protocolos de enrutamiento din\u00e1mico funcionen entre los SPOKE y el HUB.</p> </li> </ul>"},{"location":"18_DMVPN.html#protocolo-de-enrutamiento-dinamico-eigrpospf","title":"Protocolo de enrutamiento din\u00e1mico (EIGRP/OSPF\u2026).","text":"<ul> <li> <p>Transfieren sus tabla de rutas para alcanzar las redes conocidas.</p> </li> <li> <p>Permite configurar caminos alternativos ante ca\u00eddas de servicios/conexiones. </p> </li> <li> <p>Permite a los SPOKE comunicarse a trav\u00e9s de t\u00faneles independientes de forma directa.</p> </li> </ul>"},{"location":"18_DMVPN.html#multipoint-gre-mgre","title":"MultiPoint GRE (mGRE).","text":"<ul> <li> <p>Protocolo que establece los t\u00faneles entre los SPOKE y el HUB. </p> </li> <li> <p>Dentro de este t\u00fanel realiza sus tareas el NHRP para pasarse la informaci\u00f3n de configuraci\u00f3n de IPSec, de los protocolos de enrutamiento din\u00e1mico, etc.</p> </li> </ul>"},{"location":"18_DMVPN.html#proceso","title":"Proceso.","text":"1. Crear T\u00fanel Gre <p>Cuando levanta un SPOKE, tiene configurada la IP destino del HUB (IP fija) dentro de la interfaz t\u00fanel, mediante el protocolo NHRP (para informar al HUB de quien est\u00e1 intentando levantar un t\u00fanel) es capaz de levantar un t\u00fanel GRE con el HUB.</p> 2. Establecer IPSec <p>Con el t\u00fanel GRE ya levantado el HUB es capaz de enviar a trav\u00e9s de NHRP los datos para la configuraci\u00f3n del protocolo IPSec.</p> 3.    Establecer Protocolo de Enrutamiento Din\u00e1mico <p>Una vez establecido el t\u00fanel GRE junto con IPSec se manda, a trav\u00e9s de NHRP, el tr\u00e1fico multicast referente a los protocolos de enrutamiento din\u00e1mico. El tr\u00e1fico multicast debe enviarse por NHRP puesto que IPSec no soporta el cifrar este tipo de tr\u00e1fico.</p> <p>A trav\u00e9s de los protocolos de enrutamiento din\u00e1mico cada SPOKE sabr\u00e1 las redes LAN de cada una de ellas y se permitir\u00e1 comunicaci\u00f3n directa SPOKE-to-SPOKE, en caso de ser necesario.</p>"},{"location":"18_DMVPN.html#ventajas-dmvpn","title":"Ventajas DMVPN.","text":"Configuraci\u00f3n m\u00e1s sencilla y much\u00edsimo m\u00e1s escalable. <p>\ud83d\udca5 En caso de NO tener DMVPN, tendr\u00edamos que crear un t\u00fanel de forma est\u00e1tica en la configuraci\u00f3n para cada sede con la que queramos establecer una VPN, configurando dentro de este t\u00fanel todo lo relativo a IPSec para que sea seguro. </p> <p>\ud83d\udca5 Aproximadamente este tipo de configuraci\u00f3n en el HUB lleva al menos unas 13 l\u00edneas por SPOKE, por lo que si tuvi\u00e9ramos 300 SPOKES ser\u00edan 3900 l\u00edneas de c\u00f3digo de configuraci\u00f3n\u2026 \u27a1\ufe0f Si aplicamos DMVPN la configuraci\u00f3n total del HUB con 300 SPOKES ser\u00eda de aproximadamente unas 20 l\u00edneas.</p> Permite que los SPOKE tengan configurada una IP din\u00e1mica por su ISP. <p>\ud83d\udca5 Dependiendo de la configuraci\u00f3n se puede permitir que los SPOKE tengan asignada una IP din\u00e1mica. </p> <p>\ud83d\udca5 Para establecer el t\u00fanel el SPOKE buscar\u00eda la IP del HUB (\u00e9sta s\u00ed debe ser fija) y mediante NHRP le informar\u00eda de su nueva IP para establecer el t\u00fanel.</p> Permite la comunicaci\u00f3n directa entre SPOKES. <p>\ud83d\udca5 En caso de no usar DMVPN, tendr\u00edamos que establecer los t\u00faneles entre el HUB y el SPOKE a mano.</p> <p>\ud83d\udca5 En caso de que un SPOKE quisiera hablar con otro SPOKE tendr\u00eda que enviar el tr\u00e1fico al HUB, que \u00e9ste descifrara el tr\u00e1fico, lo procesara y lo volviera a cifrar para envi\u00e1rselo al SPOKE destino. Este proceso sobrecarga la CPU del HUB, que en caso de tener muchos t\u00faneles puede ser significativo, adem\u00e1s de que obviamente se a\u00f1adir\u00eda un poco de latencia.</p>"},{"location":"18_DMVPN.html#ejemplo-de-configuracion","title":"Ejemplo de Configuraci\u00f3n.","text":""},{"location":"18_DMVPN.html#configuracion-del-ipsec","title":"Configuraci\u00f3n del IPSec.","text":"<ul> <li> <p>Authentication pre-share \u27a1\ufe0f   Se utilizar\u00e1 clave compartida (PSK) en vez de por ejemplo certificados digitales (RSA).</p> </li> <li> <p>Crypto isakmp key XXXXX address 0.0.0.0 0.0.0.0 \u27a1\ufe0f Como los SPOKES tendr\u00e1n IPs din\u00e1micas, se permite establecer IPSec con cualquier IP (0.0.0.0).</p> </li> <li> <p>Crypto ipsec transform-set trans2 esp-des esp-md5-hmac mode transport \u27a1\ufe0f Se crea un perfil \u201ctrans2\u201d que usar\u00e1 \u201cESP\u201d + \u201cDES\u201d + \u201cmd5\u201d + modo transporte. En el caso de querer especificar un grupo de Diffie-Hellman tendr\u00edamos que especificarlo con el comando \u201cgroup X\u201d.</p> </li> </ul> <p>SEGURIDAD</p> <p>Esta configuraci\u00f3n de ejemplo NO ES SEGURA, ya que se debe evitar el uso de DES y md5 en especial.</p>"},{"location":"18_DMVPN.html#configuracion-del-tunel-gre","title":"Configuraci\u00f3n del T\u00fanel GRE.","text":"<p>Redes dentro del t\u00fanel</p> <p>En los t\u00faneles GRE se deben  de especificar 2 redes:</p> <p>\ud83d\udca5 La red que realmente crea el t\u00fanel y que debe estar configurada en alguna interfaz y ser alcanzable por el otro extremo (Cabecera IP lila en la imagen).</p> <p>\ud83d\udca5 La red que compone el t\u00fanel en si (Cabecera IP verde en la imagen).</p> <ul> <li> <p>tunnel mode gre multipoint \u27a1\ufe0f Generaremos el t\u00fanel GRE, aunque al no ser un t\u00fanel, si no varios (del HUB a muchos SPOKES), se usa el protocolo mGRE (multipoint GRE).</p> </li> <li> <p>tunnel source Ethernet0 \u27a1\ufe0f Es la IP de la red f\u00edsica a trav\u00e9s de la cual se establece el t\u00fanel. Tambi\u00e9n se podr\u00eda especificar una IP en vez de la interfaz.</p> </li> <li> <p>tunnel destination 172.17.0.1 \u27a1\ufe0f Es la IP f\u00edsica del destino contra el cual se establece el t\u00fanel. S\u00f3lo se configurar\u00e1 en los SPOKE.</p> </li> <li> <p>ip address IP M\u00c1SCARA \u27a1\ufe0f Son las IPs l\u00f3gicas que conformar\u00e1n el t\u00fanel.</p> </li> </ul> <p>Enrutamiento</p> <p>Si queremos que el tr\u00e1fico vaya por el t\u00fanel lo enrutaremos por las IPs l\u00f3gicas que conforman el t\u00fanel.</p> <p>Entendemos por interfaces l\u00f3gicas aquellas que son virtuales (no tienen una interfaz f\u00edsica en el equipo) y una IP l\u00f3gica ser\u00e1n aquellas redes asignadas a dichas interfaces.</p> <ul> <li> <p>ip hrp authentication XXXX \u27a1\ufe0f En caso de querer ponerle una contrase\u00f1a al protocolo NHRP. Es independiente del IPSec y debe coincidir en ambos extremos.</p> </li> <li> <p>ip nhrp multicast dynamic \u27a1\ufe0f Permite transportar tr\u00e1fico multicast, esto nos sirve para establecer protocolos de enrutamiento din\u00e1mico, los cuales usan direcciones multicast para comunicarse el enrutamiento.</p> </li> <li> <p>ip nhrp network-id XXXXX \u27a1\ufe0f Habilita NHRP en el t\u00fanel, le asigna un identificador.</p> </li> <li> <p>Tunnel key XXXX. \u27a1\ufe0f En el caso de DMVPN es necesario darle un identificador al t\u00fanel.</p> </li> <li> <p>Tunnel protection ipsec profile vpnprof \u27a1\ufe0f Asigna el perfil IPSec al t\u00fanel.</p> </li> </ul>"},{"location":"18_DMVPN.html#ejemplo-configuracion-hub","title":"Ejemplo configuraci\u00f3n HUB.","text":""},{"location":"18_DMVPN.html#video-de-ejemplo","title":"V\u00eddeo de Ejemplo.","text":""},{"location":"18_DMVPN.html#troubleshooting","title":"Troubleshooting.","text":"<p>A continuaci\u00f3n algunos comandos para depurar si tenemos todo correcto.</p> <ul> <li>Comprobar si el t\u00fanel y las interfaces f\u00edsicas est\u00e1n levantadas.</li> </ul> <ul> <li>Mirar si el IPSec est\u00e1 activo.</li> </ul> <ul> <li>Ver si el protocolo de enrutamiento din\u00e1mico est\u00e1 levantado.</li> </ul> <ul> <li>Averiguar qu\u00e9 rutas conozco por el protocolo de enrutamiento, en el caso del ejemplo EIGRP.</li> </ul>"},{"location":"19_RADIUS.html","title":"RADIUS","text":""},{"location":"19_RADIUS.html#radius-remote-authentication-dial-in-user-service","title":"RADIUS (Remote Authentication Dial-In User Service).","text":"<p>Es un protocolo de autenticaci\u00f3n, autorizaci\u00f3n y registro (AAA):</p> <ul> <li> <p>Autenticaci\u00f3n: El usuario certifica que es quien dice ser, habitualmente a trav\u00e9s de usuario/contrase\u00f1a o certificados digitales.</p> </li> <li> <p>Autorizaci\u00f3n: Una vez autenticado, qu\u00e9 permisos o privilegios tiene mi usuario, es decir, que puedo hacer dentro del sistema.</p> </li> <li> <p>Registro/Accounting: Dejar registrado que acciones ha realizado, d\u00f3nde ha accedido y por cuanto tiempo el usuario.</p> </li> </ul>"},{"location":"19_RADIUS.html#caracteristicas","title":"Caracter\u00edsticas.","text":"<ul> <li> <p>Usa el puerto 1812 UDP para establecer las conexiones y el 1813 para accounting (registro).</p> </li> <li> <p>El cliente, es decir el equipo al que se intenta ganar acceso (router, switch, firewall, etc) se le denomina NAS (Network Access Server).</p> </li> <li> <p>Se basan en el uso de una clave precompartida para el cifrado del tr\u00e1fico entre el NAS y el servidor RADIUS. Dicha clave nunca viaja por la red.</p> </li> <li> <p>Es compatible con pr\u00e1cticamente cualquier producto que permita AAA remota (autenticaci\u00f3n/autorizaci\u00f3n/accounting - registro).</p> </li> <li> <p>Existen servidores RADIUS tanto comerciales como de c\u00f3digo abierto.</p> </li> </ul>"},{"location":"19_RADIUS.html#proceso-de-autorizacion","title":"Proceso de Autorizaci\u00f3n.","text":"<ol> <li> <p>El usuario Pepe intenta registrarse en el router (NAS) con su usuario y contrase\u00f1a (pepe/1234).</p> </li> <li> <p>El NAS env\u00eda una solicitud (Access-Request) al servidor RADIUS con la informaci\u00f3n usuario, usando uno de los siguientes protocolos de autentificaci\u00f3n: PAP, CHAP, MSCHAP o EAP-TLS.</p> <ol> <li>Si el NAS no soporta ninguno de los protocolos de autentificaci\u00f3n se rechaza la conexi\u00f3n.</li> </ol> </li> <li> <p>El RADIUS le contesta aceptando o rechazando la conexi\u00f3n dependiendo de las credenciales. </p> <ol> <li> <p>La base de datos con las credenciales puede guardarse en local o en una base de datos en remoto.</p> </li> <li> <p>Si se le da acceso al usuario tambi\u00e9n se descarga al NAS una ACL para aplicar al usuario indicando qu\u00e9 comandos puede o no puede ejecutar (Autorizaci\u00f3n). Tambi\u00e9n se le asigna un TTL (Tiempo de Vida) a la sesi\u00f3n.</p> </li> </ol> </li> <li> <p>El NAS le va enviando al RADIUS un resumen sobre las tareas realizadas por ese usuario durante su conexi\u00f3n (Accounting).</p> </li> </ol>"},{"location":"1_ConocimientosBasicos.html","title":"Conocimientos B\u00e1sicos L2","text":""},{"location":"1_ConocimientosBasicos.html#conocimientos-basicos-l2-capa-2","title":"Conocimientos b\u00e1sicos L2 (Capa 2).","text":""},{"location":"1_ConocimientosBasicos.html#direccion-fisica-o-mac-media-access-control","title":"Direcci\u00f3n F\u00edsica o MAC (Media Access Control).","text":"<ul> <li> <p>Todo dispositivo que tenga una tarjeta de red (al\u00e1mbrica, inal\u00e1mbrica, bluetooth, etc.) tiene una direcci\u00f3n MAC.</p> </li> <li> <p>Cada direcci\u00f3n MAC es \u00fanica, es decir, dos dispositivos de mismo o diferente fabricante no pueden tener la misma direcci\u00f3n MAC.</p> </li> <li> <p>La direcci\u00f3n MAC de un adaptador de red no se puede modificar, aunque s\u00ed podemos enviar tramas modificando el campo que muestra nuestra direcci\u00f3n MAC. Es decir, que podemos enviar tramas modificando nuestra MAC, pero si alguien se hace f\u00edsicamente con nuestro equipo podr\u00e1 ver la MAC verdadera de nuestro adaptador.</p> </li> <li> <p>La MAC est\u00e1 representada por 48 bits, dispuestos mediante 12 d\u00edgitos hexadecimales. Por ejemplo 00:1e:c2:ff:78:ad.</p> </li> <li> <p>Los primeros 3 pares de hexadecimales hacen referencia al fabricante (OUI).</p> </li> <li> <p>Lo \u00faltimos 3 pares de hexadecimales hacen referencia al dispositivo.</p> </li> <li> <p>Existen p\u00e1ginas que nos indican una MAC a que empresa pertenece.</p> <p>\ud83d\udca5https://www.wireshark.org/tools/oui-lookup.html</p> </li> </ul> <p>Tipos de direcciones MAC.</p> <p>\ud83d\udca5 Unicast: Son direccionas MAC que van dirigidas a un dispositivo en concreto. </p> <p>\ud83d\udca5 Broadcast: Es una direcci\u00f3n MAC especial (ff:ff:ff:ff:ff:ff) que indica que se debe enviar a todos los dispositivos.</p> <p>\ud83d\udca5 Multicast: La trama se env\u00eda a un grupo de dispositivos. Comienzan con el OUI 01:00:5e.</p>"},{"location":"1_ConocimientosBasicos.html#trama-ethernet","title":"Trama Ethernet:","text":"<p>Ethernet es uno de los protocolos m\u00e1s habituales en la capa 2. El objetivo es hacer hincapi\u00e9 en que cada protocolo tiene sus cabeceras, cada uno con una raz\u00f3n de ser. Comprender en profundidad un protocolo nos puede ayudar a defendernos o a pensar en posibles ataques a realizar.</p> <ul> <li> <p>Pre\u00e1mbulo: Sirve para saber cu\u00e1ndo empieza y acaba una trama. Si recibe la secuencia 10101010 quiere decir que comienza una trama, si recibe la secuencia 10101011 es que acaba la trama.</p> </li> <li> <p>Dest.Addr/Source Addr: Son las direcciones MAC del destinatario y del origen. Se pone primero el destino porque algunos equipos de red al leer el destino env\u00edan directamente la trama para ser m\u00e1s r\u00e1pidos.</p> </li> <li> <p>Type: Tipo de protocolo de capa 3 encapsulado.</p> </li> <li> <p>Data: Datos que transporta.</p> </li> <li> <p>FCS: Para la detecci\u00f3n de errores durante el transporte.</p> </li> </ul>"},{"location":"1_ConocimientosBasicos.html#hubs-o-concentradores","title":"HUBs o Concentradores.","text":"<p>Son equipos obsoletos que debemos evitar.</p> <ul> <li> <p>F\u00edsicamente son muy parecidos a los switches/conmutadores.</p> </li> <li> <p>Su principal problema es que cuando reciben una trama lo env\u00edan a todos los puertos excepto por aquel por donde ha recibido la trama. Por lo que se genera tr\u00e1fico redundante y adem\u00e1s todo el mundo ser\u00eda capaz de recoger el tr\u00e1fico de los dem\u00e1s poniendo las tarjetas de red en modo promiscuo.</p> </li> <li> <p>El modo promiscuo no es m\u00e1s que decirle  a tu adaptador de red que capture tambi\u00e9n el tr\u00e1fico cuya MAC de destino no sea la suya.</p> </li> <li> <p>Adem\u00e1s solo tiene un mismo dominio de colisi\u00f3n, esto quiere decir que si la computadora A env\u00eda una trama a la vez que el PC B, se producir\u00e1 una colisi\u00f3n y tendr\u00e1n que volver a reenviar las tramas otra vez hasta que no se produzca una colisi\u00f3n.</p> </li> </ul> <p>Por supuesto el dominio de broadcast es compartido, por lo que si un equipo env\u00eda una mensaje broadcast lo reciben todos.</p>"},{"location":"1_ConocimientosBasicos.html#switches","title":"Switches","text":"<ul> <li> <p>Un mensaje Unicast solo se env\u00eda al puerto donde se encuentre el destinatario. Es por tanto m\u00e1s seguro que un HUB.</p> </li> <li> <p>Un mensaje Broadcast se env\u00eda por todos los puertos, al no ser que haya sido segmentado mediante VLANs.</p> </li> <li> <p>Existe un dominio de colisi\u00f3n por puerto, es decir, que si el PC A env\u00eda una trama y el PC B env\u00eda otra, al estar en puertos diferentes no se produce una colisi\u00f3n. Por lo tanto tiene much\u00edsimo mejor rendimiento que un hub.</p> </li> <li> <p>La conmutaci\u00f3n (capa 2) es m\u00e1s r\u00e1pida que el enrutamiento de los routers (capa 3).</p> </li> <li> <p>Existen switches gestionables y no gestionables.</p> <p>\ud83d\udca5 Para la ciberseguridad siempre es recomendable hacer uso de switches gestionables.</p> </li> <li> <p>Existen switches L3, que tienen funcionalidades de router, aunque habitualmente no soportan tantos protocolos/funcionalidades como un router.</p> </li> </ul> <p>\u00bfQu\u00e9 es la tabla CAM (Content Addressable Memory)?</p> <p>La tabla CAM (el nombre puede cambiar dependiendo del fabricante), es una tabla donde el switch almacena las MAC que conoce y el puerto por donde las conoci\u00f3.</p> <p>El tipo de direcci\u00f3n es din\u00e1mica o est\u00e1tica. </p> <ul> <li> <p>Din\u00e1mica es aprendida por el switch al recibir una petici\u00f3n.</p> </li> <li> <p>Est\u00e1tica es que ha sido configurada a mano por un administrador.</p> </li> </ul> <p>\u00bfQu\u00e9 pasa si se llena la tabla CAM?</p> <p>La tabla CAM tiene una memoria asignada, especialmente en equipos antiguos o baratos esta memoria no es muy grande. Cuando se llena y no puede almacenar m\u00e1s entradas el switch env\u00eda la trama recibida a todos los puertos, a la vez que elimina las entradas m\u00e1s antiguas e inserta las nuevas.</p> <p>CAM overflow attack</p> <p></p> Es un ataque que llena la tabla CAM con MACs falsas constantemente, de esta forma el switch comienza a mandar el tr\u00e1fico del resto de equipos reales como si fuera broadcast.  <p>\u00bfQu\u00e9 pasa cuando un switch recibe una trama?</p>"},{"location":"1_ConocimientosBasicos.html#protocolo-arp-address-resolution-protocol","title":"Protocolo ARP (Address Resolution Protocol).","text":"<p>Es un protocolo cuyo objetivo es averiguar la direcci\u00f3n MAC de una IP. </p> <p>Cualquier host (ordenador, tablet, m\u00f3vil, servidor, \u2026) necesita tanto de la MAC como de la IP para comunicarse con otros hosts. Para ello dispone de una tabla ARP donde tiene un listado de las IPs/MACs que conoce.</p> <p>Imaginemos que queremos llegar a una IP, pero no sabemos su MAC \u00bfqu\u00e9 rellenamos en el campo direcci\u00f3n destino de nuestra trama?</p> <p>Ejemplo:</p> <p>1. El \u201cPC A\u201d quiere comunicarse con el equipo 192.168.5.14 (PC B) pero no sabe su MAC.  Utiliza el protocolo ARP para enviar un mensaje Broadcast (ARP Request) preguntando quien tiene asignada la IP 192.168.5.14.</p> <ol> <li> <p>Aquel equipo que tenga asignada dicha IP hace dos cosas:</p> <p>a.  Se guarda en su tabla ARP la direcci\u00f3n y MAC del solicitante.</p> <p>b.  Env\u00eda un mensaje ARP reply al solicitante inform\u00e1ndole de su MAC.</p> </li> </ol> <ol> <li>El PC A recibe el ARP reply y se anota en su tabla ARP la IP y la MAC del PC B. Ya pueden comunicarse con normalidad.</li> </ol> <p>Ejemplo de captura de tr\u00e1fico de un ARP request y un ARP reply.</p> Ejemplo, el 192.168.0.1 pregunta por la MAC del 192.168.0.11. <p>RARP</p> <p></p> El protocolo RARP (Reverse Address Resolution Protocol) es un protocol que permite averiguar una IP a partir de una MAC.  <p>\u00bfHace falta un router para que dos PCs se vean entre s\u00ed?</p> <p>No, no es necesario siempre y cuando est\u00e9n en la misma red. </p> <p>Mediante el protocolo ARP podemos averiguar por d\u00f3nde hay que enviar el paquete.</p> <p>Redes Diferentes</p> <p></p> Cuando queramos acceder a otra red diferente s\u00ed ser\u00e1 necesario un router.  <p>Tras hacer un ping de uno de los equipos al otro extremo, podemos observar que el switch almacena las MACs de ambos (el que manda el arp-request y el que contesta con el arp-reply).</p> <p>Depende de la memoria de los switches pueden almacenar m\u00e1s o menos MACs.</p> <p>Como podemos ver, el switch que usamos en el laboratorio puede almacenar muchas MACs, no obstante no todos los switches son as\u00ed.</p>"},{"location":"1_ConocimientosBasicos.html#tormenta-de-broadcast-bucles-de-red","title":"Tormenta de Broadcast / Bucles de red.","text":"<p>\u00bfQu\u00e9 pasa cuando un switch recibe una trama broadcast?</p> <p>Que redirige esa trama por todos los puertos excepto por aquel por el que recibi\u00f3 la trama.</p> <p>Ejemplo</p> <p>Tenemos un switch con 3 puertos: A, B y C.</p> <p>El puerto A est\u00e1 conectado a un PC.</p> <p>El puerto B y C est\u00e1n interconectados entre s\u00ed.</p> <p>1.  El equipo A env\u00eda un mensaje broadcast.</p> <p>2.  El switch reenv\u00eda dicho mensaje por los puertos B y C.</p> <p>3.  El switch recibe un broadcast del puerto B y lo reenv\u00eda por A y C.</p> <pre><code>i.  C reenv\u00eda el broadcast recibido a A y B.\n\n    ii. B reenv\u00eda el broadcast a A y C\n\n        iii.C reenv\u00eda el broadcast a A y B\n\n            iv. \u2026.\n</code></pre> <p>4.  A la vez recibe del puerto C el mismo broadcast y lo reenv\u00eda a A y B.</p> <pre><code>i.  B reenv\u00eda el broadcast recibido a A y C.\n\n    ii. C reenv\u00eda el broadcast a A y B\n\n      iii.  B reenv\u00eda el broadcast a A y C.\n\n          iv.   \u2026.\n</code></pre> <p>Lo que sucede es que en pocos segundos la red se inunda de mensajes broadcast, lo que colapsa de inmediato la red.</p> <p>Las tramas Ethernet de capa 2 no soportan ning\u00fan campo TTL (Time To Live), por lo que no saben si una trama ha estado durante mucho tiempo en la red saltando de switch en switch. Lo que no permite crear una pol\u00edtica que elimine tramas cuando hayan estado ya un tiempo en nuestra electr\u00f3nica de capa 2. Es decir, el bucle de red no se arregla hasta que elimines el bucle.</p>"},{"location":"20_NGFW.html","title":"NGFW","text":""},{"location":"20_NGFW.html#ngfw-next-generation-firewall","title":"NGFW (Next Generation Firewall).","text":"<p>Los firewall NGFW tienen funcionalidades de hasta capa 7, mientras que los firewall tradicionales sol\u00edan tener limitaciones en la capa de transporte.</p> <p>Los NGFW pueden bloquear por ejemplo por aplicaci\u00f3n mientras que los firewall tradicionales estaban limitados a bloquear por IP/Puerto/Protocolo.</p>"},{"location":"20_NGFW.html#funcionalidades","title":"Funcionalidades.","text":"<ul> <li> <p>Clasificaci\u00f3n e inspecci\u00f3n de protocolos de capa de aplicaci\u00f3n.</p> </li> <li> <p>Filtrado basado en listas negras y categor\u00edas. </p> </li> <li> <p>Detecci\u00f3n y prevenci\u00f3n de intrusos (IDS).</p> </li> <li> <p>Inspecci\u00f3n de tr\u00e1fico cifrado https (HTTPS Inspection).</p> </li> <li> <p>Antivirus.</p> </li> <li> <p>Configuraci\u00f3n autom\u00e1tica de Proxy (WPAD).</p> </li> <li> <p>Control de acceso por MAC.</p> </li> <li> <p>...</p> </li> </ul>"},{"location":"20_NGFW.html#fabricantes","title":"Fabricantes.","text":"<p>Existen varios fabricantes que tienen firewalls NGFW:</p> <ul> <li> <p>PaloAlto.</p> </li> <li> <p>Fortinet.</p> </li> <li> <p>Sophos.</p> </li> <li> <p>CheckPoint.</p> </li> <li> <p>WatchGuard.</p> </li> <li> <p>OPNsense (libre).</p> </li> </ul>"},{"location":"20_NGFW.html#practica-opnsense","title":"Pr\u00e1ctica OPNsense.","text":""},{"location":"20_NGFW.html#esquema-de-laboratorio","title":"Esquema de Laboratorio.","text":"<p>Importante que la vtnet0 sea la que est\u00e9 conectada a la WAN y la vtnet1 a la LAN.</p>"},{"location":"20_NGFW.html#acceso","title":"Acceso.","text":"<p>Se puede acceder desde la LAN (KALI Linux) a la IP 192.168.200.1 a trav\u00e9s de un navegador con las credenciales root / opnsense</p> <p>Es recomendable cambiar la resoluci\u00f3n del KALI a la misma que la m\u00e1quina anfitriona.</p> <p>Antes de empezar aseg\u00farate que eres capaz de navegar desde el KALI Linux</p>"},{"location":"20_NGFW.html#cortar-acceso-a-web-httphttps-por-ip","title":"Cortar acceso a web (HTTP/HTTPS) por IP.","text":"<p>Ahora vamos a ver c\u00f3mo crear una regla que deniegue el acceso a un servicio de Internet, como por ejemplo el acceso http y https a www.leagueoflegends.com.</p> <p>Pregunta 1</p> <p>Realiza una consulta dns (con nslookup desde Windows o host/dig desde Linux) desde la m\u00e1quina cliente para consultar la IP o direcciones IP de www.leagueoflegends.com. Adjunta una captura con las direcciones IP que devuelve el comando de b\u00fasqueda dns.</p> <ul> <li>Una vez hemos obtenido las direcciones IP, crearemos un alias con el nombre LOL_COM, de forma que podamos referenciarlo desde las reglas sin tener que repetir las direcciones IP cada vez en varias reglas. </li> </ul> <p>Para ello vamos a Cortafuegos \u27a1\ufe0f Aliases \u27a1\ufe0f \u2795 y configuramos los siguientes par\u00e1metros:</p> <p>Nombre: LOL_COM (por ejemplo, es descriptivo)</p> <p>Escribir: Host(s)</p> <p>Contenido: (escribimos las IP, pulsando tabulador despu\u00e9s de cada una)</p> <p>Descripci\u00f3n: Direcciones IP de www.leagueoflegends.com</p> <ul> <li>Ahora creamos un alias para los servicios HTTP y HTTPS.</li> </ul> <p>AVISO</p> <p>Los cambios no se aplican autom\u00e1ticamente debemos pulsar sobre el bot\u00f3n rojo Aplicar.</p> <ul> <li>A continuaci\u00f3n vamos Cortafuegos \u27a1\ufe0f Reglas \u27a1\ufe0f LAN y creamos una nueva regla para cortar el acceso HTTP y HTTPS a las IPs de www.leagueoflegends.com.:</li> </ul> <p>Pregunta 2</p> <p>\u00bfPor qu\u00e9 sigues pudiendo acceder a la web desde el cliente? PISTA: El orden importa.</p> <p>Solventa el problema y comprueba que efectivamente la p\u00e1gina est\u00e1 bloqueada para el cliente.</p> <p>Pregunta 3</p> <p>Intenta realizar un ping a la IP del dominio. \u00bfFunciona? \u00bfPor qu\u00e9?</p>"},{"location":"20_NGFW.html#cortar-servicios","title":"Cortar servicios.","text":"<p>A continuaci\u00f3n vamos a aplicar una pol\u00edtica restrictiva de seguridad a los clientes de la LAN, en la que s\u00f3lo se va a permitir que se pueda navegar por Internet (http y https) y lanzar pings. El resto de servicios se van a denegar (ftp, ssh, pop3, smtp, etc.).</p> <p>Pregunta 4</p> <p>A partir de las explicaciones anteriores, crea una regla para permitir el tr\u00e1fico HTTP y HTTPS hacia cualquier destino desde la LAN y otra que permita el ICMP (ping y traceroute) hacia cualquier destino. Ambas reglas debes crearlas detr\u00e1s de la regla que deniega navegar por www.leagueoflegends.com. Adjunta pantallazo de todas las reglas.</p> <p>Pregunta 5</p> <p>Crea otra regla para el servicio DNS (UDP y TCP) pero \u00fanicamente que cuyo destino sea el propio firewall.</p> <p>Recuerda que el firewall se asigna asimismo como servidor DNS a los clientes mediante DHCP.</p> <p>As\u00ed evitamos que puedan usar DNS externos a la organizaci\u00f3n o que alguien se instale un servicio DNS dentro de nuestra LAN.</p> <p>Pregunta 6</p> <p>Deshabilitaa la regla que permite todo el tr\u00e1fico desde la LAN hacia cualquier destino. Para ello, ed\u00edtala y marca Deshabilitar esta regla.</p> <p>RECUERDA APLICAR LOS CAMBIOS!!!!</p> <p>Para comprobar que no funcionan otros servicios como el ftp  puedes probar a lanzar el comando ftp ftp.rediris.es en un terminal y ver si te deja conectar.</p>"},{"location":"20_NGFW.html#bloquear-acceso-a-la-web-por-dominio","title":"Bloquear acceso a la web por dominio.","text":"<p>Denegar el servicio de un dominio bloqueando la IP tiene mayormente dos desventajas:</p> <ul> <li> <p>En una misma IP pueden alojarse varios dominios (ViewDNS).</p> </li> <li> <p>Si el d\u00eda de ma\u00f1ana por cualquier motivo el dominio cambia de IP nuestro bloqueo dejar\u00eda de ser efectivo.</p> </li> </ul> <p>Por tanto en esta secci\u00f3n vamos a bloquear el dominio sobreescribiendo la petici\u00f3n DNS.</p> <p>Servicio \u27a1\ufe0f Unbound DNS \u27a1\ufe0f Sobrescribir</p>"},{"location":"20_NGFW.html#https-inspection","title":"HTTP/S Inspection.","text":"<p>OPNproxy plugin.</p> <p>https://docs.opnsense.org/manual/how-tos/proxytransparent.html</p> <p>Si cualquiera se hace con la clave privada del proxy puede descifrar todo.</p>"},{"location":"21_ARP.html","title":"ARP","text":""},{"location":"21_ARP.html#arp","title":"ARP.","text":""},{"location":"21_ARP.html#caracteristicas","title":"Caracter\u00edsticas.","text":"<ul> <li> <p>La funci\u00f3n del protocolo ARP es la de averiguar la MAC de un equipo dado su direccionamiento IP.</p> </li> <li> <p>Protocolo de capa 2: Los routers no retransmiten las tramas ARP a otras redes \u27a1\ufe0f Un equipo, no puede averiguar a trav\u00e9s de ARP la MAC de otro equipo en una red diferente.</p> </li> </ul> \u00bfPor qu\u00e9 necesito la MAC de una IP? <p>\ud83d\udca5 Los switches son equipos de capa 2, es decir, no entienden de IP, por lo que para interconectar dos equipos necesita saber en qu\u00e9 puerto est\u00e1 asociado la MAC destino.</p> <p>\ud83d\udca5 Para enviar un paquete (CAPA 3), se debe rellenar los campos de MAC origen y MAC destino de la capa 2 (trama).</p> <p>Proxy ARP</p> <p>La funcionalidad Proxy ARP permite que el router transmita las tramas ARP entre redes diferentes</p> <p>No es aconsejable activarlo si no es necesario</p>"},{"location":"21_ARP.html#funcionamiento","title":"Funcionamiento.","text":""},{"location":"21_ARP.html#si-quiero-enviar-un-paquete-a-un-equipo-de-mi-misma-red-que-procedimiento-sigo","title":"\u00bfSi quiero enviar un paquete a un equipo de mi misma red que procedimiento sigo?","text":"<p>1\ufe0f\u20e3 Env\u00edo un ARP request a todo el mundo, preguntando por la MAC de la IP destino (de mi red).</p> Ejemplo, el 192.168.0.1 pregunta por la MAC del 192.168.0.11. <p>2\ufe0f\u20e3 El switch recibe dicho ARP request y:</p> <ul> <li> <p>Se apunta en su Tabla CAM (MAC \u2013 Puerto) que en mi puerto se puede encontrar mi MAC (eficiencia en futuros reenv\u00edos).</p> </li> <li> <p>El switch reenv\u00eda el ARP request al resto de puertos (excepto al m\u00edo).</p> </li> </ul> Ejemplo Tabla CAM de un switch. <p>3\ufe0f\u20e3 Aquel que tenga esa IP configurada contesta con un ARP reply indicando que dicha IP tiene la MAC X.</p> <p>4\ufe0f\u20e3 El switch recibe ese ARP reply, aprovecha para apuntarse que en ese puerto existe esa MAC (eficiencia en futuros reenv\u00edos) y reenv\u00eda el ARP reply.</p> Ejemplo, el 192.168.0.11 tiene la  MAC 90:2b:34:df:bc:41. <p>5\ufe0f\u20e3 Ahora mi equipo ya puede apuntarse en su tabla ARP que dicha IP tiene esa MAC y enviar mis paquetes. </p> <p>IMPORTANTE</p> <p>Para futuros env\u00edos como ya tengo su MAC en mi tabla ARP ya no tengo que volver a realizar el protocolo ARP.</p>"},{"location":"21_ARP.html#si-quiero-enviar-un-paquete-a-un-equipo-de-otra-red","title":"\u00bfSi quiero enviar un paquete a un equipo de otra red?","text":"<p>En este caso, al ser un equipo de otra red, el procedimiento es exactamente igual pero la MAC que se intenta averiguar es el de mi puerta de enlace.</p> Ejemplo tabla ARP de un host (ordenador). <p>Una vez el paquete llega a la puerta de enlace \u00e9l ya lo enruta por las redes que fuera necesario, haciendo ARP en cada red de forma independiente.</p> <p>IMPORTANTE</p> <p>Una vez pasa la puerta de enlace y entra en otra red, la MAC Origen cambia y dejaremos de ser nosotros, si no que ser\u00e1 la puerta de enlace.</p>"},{"location":"22_Spoofing.html","title":"ARP Spoofing","text":""},{"location":"22_Spoofing.html#arp-spoofing","title":"ARP Spoofing.","text":""},{"location":"22_Spoofing.html#objetivo","title":"OBJETIVO.","text":"<ul> <li>Interceptar el tr\u00e1fico de terceros \u27a1\ufe0f Ataque MITM (Man In The Middle). </li> </ul>"},{"location":"22_Spoofing.html#estrategia","title":"ESTRATEGIA.","text":"<p>Enviaremos paquetes ARP reply, indicando que la IP de la v\u00edctima tiene asociada nuestra MAC, las m\u00e1quinas que reciban este paquete actualizar\u00e1n su tabla ARP con nuestra MAC, por lo que cuando vayan a mandar un paquete a la v\u00edctima nos lo enviar\u00e1n a nosotros. </p> <p>S\u00f3lo funciona a nivel LAN, puesto que los routers no reenv\u00edan o retransmiten los paquetes de capa 2 del protocolo ARP. </p> \u00bfY si tuvi\u00e9ramos el Proxy ARP habilitado? <p>En ese caso podr\u00edamos realizar este ataque entre redes diferentes</p>"},{"location":"22_Spoofing.html#procedimiento","title":"PROCEDIMIENTO.","text":"<p>1\ufe0f\u20e3 Abrimos la aplicaci\u00f3n ettercap de Kali Linux.</p> <p>2\ufe0f\u20e3 Escaneamos en busca de v\u00edctimas.</p> <p>3\ufe0f\u20e3 Seleccionamos la v\u00edctima por la que nos haremos pasar. Si no a\u00f1adimos una segunda v\u00edctima recogeremos todo el tr\u00e1fico que le vaya a llegar a la primera v\u00edctima, si a\u00f1adimos una, recogeremos todo el tr\u00e1fico que le llegue a la primera y la segunda (comunicaci\u00f3n completa). Habitualmente la segunda v\u00edctima podr\u00eda ser la puerta de enlace.</p> <p>4\ufe0f\u20e3 Confirmamos el ataque:</p> <p>5\ufe0f\u20e3 Una vez realizado el ataque abre el wireshark en la m\u00e1quina Kali y podr\u00e1s ver que eres capaz de capturar el tr\u00e1fico entre las v\u00edctimas.</p>"},{"location":"22_Spoofing.html#video-explicativos","title":"V\u00eddeo Explicativos.","text":""},{"location":"22_Spoofing.html#video-1","title":"V\u00eddeo 1.","text":""},{"location":"22_Spoofing.html#video-2","title":"V\u00eddeo 2.","text":""},{"location":"23_DHCP.html","title":"DHCP","text":""},{"location":"23_DHCP.html#dhcp","title":"DHCP.","text":"<ul> <li> <p>Permite la asignaci\u00f3n autom\u00e1tica de direccionamiento IP/m\u00e1scara/puerta de enlace/servidores DNS.</p> </li> <li> <p>Puertos:</p> </li> </ul> <p>\ud83d\udca5 67/UDP (servidor).</p> <p>\ud83d\udca5 68/UDP (cliente).</p> <ul> <li>Basado en el protocol \u201cBOOTP\u201d.</li> </ul> <p>\ud83d\udca5 En wireshark podremos filtrar por \u201cbootp\u201d o \u201cdhcp\u201d para buscar informaci\u00f3n de estos protocolos.</p>"},{"location":"23_DHCP.html#mensajes","title":"Mensajes:","text":"DHCP_DISCOVER <p>El cliente, el cual no tiene IP, manda un mensaje de broadcast (255.255.255.255) con origen (0.0.0.0). El puerto origen 68 (cliente), el puerto destino 67 (servidor).</p> DHCP_OFFER <p>El mensaje es recibido por todos los equipos de la red, pero s\u00f3lo el servidor est\u00e1 escuchando en el puerto 67 (UDP), por lo que ser\u00e1 \u00e9ste quien conteste con una oferta, indicando la IP que le ofrece configurarse.</p> <ol> <li> <p>El servidor inserta en su tabla de asignaciones de forma temporal (15 \u2013 60 segundos) la oferta mandada. Es decir, que si en ese tiempo el cliente no confirma la oferta, se libera esa IP de la tabla de asignaci\u00f3n.</p> </li> <li> <p>Ejemplo del contenido OFFER:</p> </li> </ol> <p></p> <ol> <li>El mensaje OFFER se env\u00eda directamente a la IP destino 192.168.0.10, pero el cliente a\u00fan no tiene configurada esa IP \u00bfC\u00f3mo le llega el mensaje? \u27a1\ufe0f El servidor tiene su MAC por lo que el paquete le llegar\u00e1 al cliente (se encuentran en la misma red), adem\u00e1s lo env\u00eda al puerto 68 del cliente, el cual est\u00e1 esperando respuesta tras enviar el DISCOVERY.</li> </ol> <p>DHCP SPOOFING</p> <p>Al ser un mensaje broadcast por parte del cliente lo hace, a priori, muy f\u00e1cil hacerse pasar por un servidor DHCP falso.</p> DHCP_REQUEST <p>El cliente responde al servidor si est\u00e1 o no de acuerdo con dicha oferta.</p> ACK <p>El servidor confirma el cambio en su tabla de asignaciones y manda un ACK para confirmarle dicho cambio al cliente.</p> <p>La asignaci\u00f3n ser\u00e1 funcional durante un Lease Time configurado en el servidor. Tras este tiempo se producir\u00e1 una renovaci\u00f3n.</p> <p>El cliente al recibir el ACK se configura el direccionamiento en su tarjeta.</p>"},{"location":"23_DHCP.html#servidor-dhcp-relay","title":"Servidor DHCP Relay.","text":"<p>En principio un servicio DHCP asigna direccionamiento IP a equipos dentro de su misma red.</p> <p>BROADCAST</p> <p>El tr\u00e1fico broadcast no se retransmite por los routers, por lo que no pasa de una red a otra.</p> <p>Si necesitamos asignar direccionamiento a equipos en redes diferentes necesitamos configurar TODOS los routers intermedios como DHCP Relay, para que cuando reciban un mensaje DISCOVER lo reenv\u00eden al servidor DHCP que se encuentra en otra red, y lo mismo en sentido contrario con el OFFER y el resto de mensajes.</p>"},{"location":"23_DHCP.html#ejemplo","title":"Ejemplo.","text":"<p>En el siguiente ejemplo hay un DHCP Relay configurado en las VLANS 40 y 50 y s\u00f3lo en el puerto Gi1/05 (el te1/0/3 est\u00e1 configurado pero inactivo). </p> <p>Cuando reciba un mensaje con destino 255.255.255.255 DHCP DISCOVER (Puerto 67), lo reenv\u00eda al servidor DHCP 124.167.1.1 (el 124.200.1.1 no est\u00e1 funcional al estar inactivo el puerto te1/0/3).</p> <p>En caso de que para llegar a dichos servidores DHCP tenga que pasar por otros routers, dichos routers intermedios tambi\u00e9n tendr\u00e1n que tener configurado dicho servicio DHCP Relay.</p>"},{"location":"23_DHCP.html#video-explicativo","title":"V\u00eddeo Explicativo.","text":""},{"location":"24_DHCP_Starvation.html","title":"Starvation","text":""},{"location":"24_DHCP_Starvation.html#dhcp-starvation","title":"DHCP Starvation.","text":""},{"location":"24_DHCP_Starvation.html#objetivo","title":"OBJETIVO.","text":"<p>Agotar el n\u00famero de IPs (pool) que puede asignar el servidor DHCP. </p>"},{"location":"24_DHCP_Starvation.html#estrategia","title":"ESTRATEGIA.","text":"<p>Lanzaremos m\u00faltiples peticiones DHCP DISCOVERY, teniendo cada una de ellas una MAC origen diferente (MAC spoofing), para que piense que cada DHCP DISCOVERY lo est\u00e1 mandando un cliente nuevo. </p> <p>1\ufe0f\u20e3 En caso de no tenerlo, instalamos el paquete Yersinia.</p> <pre><code>apt-get install yersinia\n</code></pre> <p>2\ufe0f\u20e3 Ejecutar en modo gr\u00e1fico:</p> <pre><code>yersinia \u2013G\n</code></pre> <p>3\ufe0f\u20e3 En el bot\u00f3n Edit Interfaces aseguraos de que est\u00e1 marcada la interfaz LAN de vuestro Kali.</p> <p>4\ufe0f\u20e3 Ahora en el bot\u00f3n Launch Attack marcamos la opci\u00f3n de enviar paquetes DISCOVER.</p> <p>5\ufe0f\u20e3 C\u00f3mo pod\u00e9is ver se est\u00e1n creando m\u00faltiples paquetes de DHCP Discovery, cada uno con una MAC falsa distinta:</p> <p>6\ufe0f\u20e3 Podemos ver en el router Mikrotik como se han reservado todo el pool de IPs para DHCP y por tanto nuevos clientes no podr\u00edan conectarse.</p>"},{"location":"24_DHCP_Starvation.html#video-explicativo","title":"V\u00eddeo Explicativo.","text":""},{"location":"25_Bypass.html","title":"Bypass","text":""},{"location":"25_Bypass.html#bypass","title":"Bypass.","text":""},{"location":"25_Bypass.html#escenario","title":"Escenario.","text":""},{"location":"25_Bypass.html#empresa","title":"Empresa","text":"<ul> <li> <p>Tenemos una red Interna 192.168.0.X/24 que est\u00e1 detr\u00e1s de un NAT y adem\u00e1s el router corta las conexiones SSH, por lo que no se puede conectar a servidores ssh. </p> </li> <li> <p>No tenemos control del router, \u00fanicamente del ordenador.</p> </li> </ul>"},{"location":"25_Bypass.html#casa","title":"Casa","text":"<ul> <li> <p>Por otro lado tenemos otra red interna 192.168.100.100/24 que tambi\u00e9n est\u00e1 detr\u00e1s de una NAT.</p> </li> <li> <p>En este caso s\u00ed tenemos control del router.</p> </li> </ul>"},{"location":"25_Bypass.html#objetivo","title":"Objetivo.","text":"<p>Establecer una conexi\u00f3n SSH desde el equipo de la izquierda con el de la derecha. Teniendo en cuenta que el router Mikrotik1 tendr\u00e1 unas reglas que cortan las conexiones SSH.</p>"},{"location":"25_Bypass.html#estrategia","title":"Estrategia.","text":"<p>Dado que hay otros protocolos que no est\u00e1n cortados, como por ejemplo DNS, HTTP, HTTPS o ICMP se pueden aprovechar para establecer un t\u00fanel entre los extremos usando estos protocolos. Posteriormente, dentro del t\u00fanel establecemos la conexi\u00f3n SSH. Es decir, que el firewall va a ver que hay una conexi\u00f3n ICMP, pero realmente dentro de esa conexi\u00f3n ICMP hay una sesi\u00f3n SSH.</p> <p>Una cabecera ICMP tiene la siguiente forma, donde podemos ver que tiene un campo de ICMP Data, que es donde nosotros vamos establecer el t\u00fanel.</p> <p>\u00bfQu\u00e9 quiere decir establecer un t\u00fanel?</p> <p>Dentro de la cabecera ICMP Data vamos a insertar otra cabecera IP (T\u00fanel) con otro direccionamiento (IPs del t\u00fanel) y lo que ser\u00edan los datos (ICMP Data) va a ser todo el tr\u00e1fico ssh que vamos a intercambiar.</p> <p>Es decir, nuestro router solo va a leer la cabecera IP verde y lo va a enrutar. El firewall va a ver que es tr\u00e1fico ICMP pero no va a  ver m\u00e1s all\u00e1, si tuviera que analizar todos los datos de todos los paquetes no podr\u00eda dar abasto.</p> <p>Cuando el paquete llegue al destino final, este equipo s\u00ed sabr\u00e1 que tiene que desencapsular el tr\u00e1fico ICMP Data para ver los datos reales, en este caso una conexi\u00f3n ssh.</p>"},{"location":"25_Bypass.html#configuraciones-iniciales","title":"Configuraciones Iniciales.","text":""},{"location":"25_Bypass.html#configuracion-del-direccionamiento-y-del-nat","title":"Configuraci\u00f3n del direccionamiento y del NAT.","text":"<p>Antes de nada f\u00edjate bien en los direccionamientos de cada equipo.</p> <ul> <li>Configuramos las interfaces y activamos un source NAT.</li> </ul> <ul> <li>Para configurar el otro router ser\u00eda exactamente igual, \u00fanicamente variar\u00edan las direcciones IP.</li> </ul>"},{"location":"25_Bypass.html#configurar-los-equipos-cliente-y-servidor","title":"Configurar los equipos Cliente y Servidor.","text":"<ul> <li> <p>Establecer una IP est\u00e1tica en ambos equipos.</p> </li> <li> <p>Establecer un DNS est\u00e1tico, por ejemplo 8.8.8.8.</p> </li> </ul>"},{"location":"25_Bypass.html#comprobacion-del-correcto-funcionamiento-del-nat","title":"Comprobaci\u00f3n del correcto funcionamiento del NAT.","text":"<ul> <li>Hacemos ping desde \u201cServidor\u201d, el que est\u00e1 a la derecha, debemos ser capaces de llegar al router del otro extremo a trav\u00e9s de la red \u201cInternet\u201d.</li> </ul> <ul> <li>Una vez hecho el ping podemos comprobar en el router \u201cCasa\u201d (derecha) que ha realizado el NAT.</li> </ul> <ul> <li> <p>Podemos realizar la misma operativa en el lado contrario, cambiando la IP del ping, para ver que tambi\u00e9n es correcta la configuraci\u00f3n del NAT.</p> </li> <li> <p>Desde el \u201cServidor\u201d no deber\u00edamos ser capaces de llegar por ICMP a la red privada de \u201cCliente\u201d, es decir, no llegamos la IP 192.168.0.100, pues es una red interna (LAN) ajena a la nuestra. Obviamente el cliente tampoco debe ser capaz de alcanzar la red privada del Servidor.</p> </li> </ul>"},{"location":"25_Bypass.html#configuracion-del-dmz-en-el-router-de-la-derecha-casa","title":"Configuraci\u00f3n del DMZ en el router de la derecha (Casa).","text":"<ul> <li>Comprobar correcto funcionamiento estableciendo una sesi\u00f3n ssh desde \u201cCliente\u201d hasta \u201cServidor\u201d. </li> </ul> <pre><code>ssh usuario@85.85.85.2 \n</code></pre> <p>Hacemos el ssh a la IP p\u00fablica porque el equipo est\u00e1 detr\u00e1s de un NAT y no alcanzar\u00edamos la IP p\u00fablica \u27a1\ufe0f Al tener un DMZ reenv\u00eda todos el tr\u00e1fico de los puertos conocidos a la IP interna.</p> <p>AVISO</p> <p>Recuerda antes activar el servicio ssh que viene desactivado por defecto en Kali</p> <pre><code>systemctl start ssh\n</code></pre>"},{"location":"25_Bypass.html#anadir-filtros-de-seguridad-en-el-router-de-la-izquierda-empresa","title":"A\u00f1adir filtros de seguridad en el router de la izquierda (\u201cEmpresa\u201d).","text":"<ul> <li>Vamos a cortar el tr\u00e1fico SSH tanto externo como interno.</li> </ul> <ul> <li>Realizamos la comprobaci\u00f3n y vemos que ya no establece conexi\u00f3n.</li> </ul> <pre><code>#Hacer la prueba desde el cliente de nuevo...\nssh usuario@85.85.85.2 \n</code></pre>"},{"location":"25_Bypass.html#realizacion-del-bypass","title":"Realizaci\u00f3n del Bypass.","text":""},{"location":"25_Bypass.html#configurar-el-tunelizador","title":"Configurar el tunelizador.","text":"<p>Primeramente tenemos que tener descargado el siguiente programa en ambas m\u00e1quinas:</p> <pre><code>wget https://sourceforge.net/projects/hanstunnel/files/source/hans-1.1.tar.gz/download\n</code></pre> <p>Descomprimimos y compilamos el Makefile.</p> <pre><code>tar -xf hans-1.1.tar.gz\ncd hans1-1\nmake\n</code></pre>"},{"location":"25_Bypass.html#servidor","title":"Servidor.","text":"<ul> <li> <p>-s: Para indicar que va a ser el servidor y la red que se establece en el t\u00fanel.</p> </li> <li> <p>-p: Contrase\u00f1a para establecer el t\u00fanel.</p> </li> </ul>"},{"location":"25_Bypass.html#cliente","title":"Cliente.","text":"<ul> <li> <p>-c: La IP del servidor, usaremos la IP p\u00fablica del router que tiene configurada a su vez un DMZ.</p> </li> <li> <p>-p: La contrase\u00f1a del t\u00fanel.</p> </li> </ul> <p>Comprobamos que hay conectividad a trav\u00e9s del t\u00fanel.</p> <pre><code>ping 10.0.0.1\n</code></pre> <p>Establecer conexi\u00f3n SSH a trav\u00e9s del t\u00fanel.</p> <p>Obviamente la conexi\u00f3n la hacemos desde el cliente hasta el servidor.</p>"},{"location":"25_Bypass.html#mitigacion","title":"Mitigaci\u00f3n.","text":"<p>Hemos visto que estamos estableciendo un t\u00fanel a trav\u00e9s de ICMP, por tanto vamos a probar a cortar el ICMP en el router de la empresa.</p> <p>Comprobamos desde \u201cCliente\u201d que ya no contestan a ping:</p> <pre><code>ping 85.85.85.2\n</code></pre> <p>Ahora intentamos establecer el t\u00fanel.</p> <ul> <li>Primero ejecutamos hans en el \u201cServidor\u201d</li> </ul> <pre><code>./hans -s 10.0.0.0 -p mipassword\n</code></pre> <ul> <li>A continuaci\u00f3n en el \u201cCliente\u201d</li> </ul> <pre><code>./hans -c 85.85.85.2 -p mipassword\n</code></pre> <ul> <li>Comprobamos que en el lado de \u201cCliente\u201d no se ha podido establecer el t\u00fanel.</li> </ul> <p>AVISO</p> <p>No obstante, al igual que hemos hecho un \u201cSSH over ICMP\u201d tambi\u00e9n podemos hacerlo sobre \u201cDNS\u201d por ejemplo, protocolo que es m\u00e1s dif\u00edcil de cortar.</p>"},{"location":"25_Bypass.html#https-y-dns-inspection","title":"HTTPS y DNS Inspection.","text":"<p>Por tanto la \u00fanica soluci\u00f3n ser\u00eda tener un firewall que fuera capaz de investigar todos los datos, pero eso es algo complicado con la gran cantidad de tr\u00e1fico, adem\u00e1s no ser\u00eda \u00e9tico y mucho tr\u00e1fico vendr\u00eda cifrado, por lo que tendr\u00edas que ser capaz de descifrarlo y volverlo a cifrar antes de salir a Internet (HTTPS INSPECTION).</p> <p>Aqu\u00ed tienes informaci\u00f3n sobre HTTPS Inspection y DNS Inspection.</p> <p>Informaci\u00f3n sobre HTTPS Inspection.</p> <p>Informaci\u00f3n sobre configuraci\u00f3n en clientes.</p> <p>Informaci\u00f3n sobre DNS Inspection.</p>"},{"location":"25_Bypass.html#video-explicativo","title":"V\u00eddeo Explicativo.","text":""},{"location":"2_ComandosCisco.html","title":"Comandos B\u00e1sicos","text":""},{"location":"2_ComandosCisco.html#comandos-basicos-cisco","title":"Comandos b\u00e1sicos Cisco.","text":""},{"location":"2_ComandosCisco.html#niveles-de-configuracion","title":"Niveles de configuraci\u00f3n.","text":"<p>En Cisco existen varios niveles de configuraci\u00f3n.</p> <ul> <li> <p>Modo Usuario.</p> <p>\ud83d\udca5 Modo lectura que nos permite consultar informaci\u00f3n o estado del equipo.</p> </li> </ul> <ul> <li> <p>Modo Privilegiado. </p> <p>\ud83d\udca5 Es un modo que permite ver la configuraci\u00f3n del equipo y acceder al modo configuraci\u00f3n.</p> <p>\ud83d\udca5 Se accede a este modo mediante el comando \u201cenable\u201d.</p> </li> </ul> <ul> <li> <p>*Modo configuraci\u00f3n. </p> <p>\ud83d\udca5   Es el modo que nos permite realizar cambios. </p> <p>\ud83d\udca5 Es importante tener en cuenta que en Cisco los cambios se aplican al instante.</p> <p>\ud83d\udca5 Se accede desde  el modo enable, mediante el comando \u201cconfigure terminal\u201d</p> </li> </ul>"},{"location":"2_ComandosCisco.html#autocompletado-y-autoayuda","title":"Autocompletado y Autoayuda","text":"<ul> <li>En el terminal podemos hacer uso del \u201c?\u201d para ver que par\u00e1metros u opciones tiene cada comando.</li> </ul> <ul> <li> <p>Podemos hacer uso del \u201ctabulador\u201d para autocompletar un comando.</p> </li> <li> <p>No es necesario completar el comando para que se ejecute. Por ejemplo en vez de enable podemos ejecutar  \u201cen\u201d, en vez de configure terminal \u201cconf t\u201d, en vez de write usar \u201cwr\u201d.</p> </li> </ul>"},{"location":"2_ComandosCisco.html#configurar-interfaces","title":"Configurar Interfaces.","text":"<p>Cada fabricante nombra sus interfaces de diferente forma. En el caso de Cisco los m\u00e1s habituales son los siguientes:</p> <ul> <li> <p>Fa: FastEthernet (100Mbps)</p> </li> <li> <p>Gi: GigaEthernet (1Gbps).</p> </li> <li> <p>Te: TenGigabitEthernet (10Gbps).</p> </li> </ul> <p>Muchos equipos de red son ampliables por m\u00f3dulos, es decir, que podemos tener un switch de 12 puertos y un hueco para insertarle otro m\u00f3dulo de 12 puertos. Otros equipos son stackables, se pueden unir entre si y funciona como un mismo equipo. </p> <p>Pues bien, las interfaces nos dan informaci\u00f3n de donde se encuentra el puerto dentro del equipo. </p> <p>Por ejemplo:</p> <p>\ud83d\udca5 Gi0/0  --&gt; Indica que la interfaz es la primera del primer m\u00f3dulo.</p> <p>\ud83d\udca5 Gi1/0/3 --&gt; Puede indicar el tercer puerto, del primer m\u00f3dulo, del segundo switch en stack.</p> <p>Configuraci\u00f3n.</p> <p>Dentro de la configuraci\u00f3n se pueden acceder a diferentes subapartados, habitualmente protocolos o interfaces. </p> <p>En la siguiente captura nos metemos en la interfaz Gi0/0 (GigaEthernet 0/0), le estamos poniendo un nombre (descripci\u00f3n), lo estamos levantando administrativamente (no shutdown) y configurandola para que pase todas las vlans (switchport trunk + switchport mode trunk).</p> <p>Dentro de una interfaz nos podemos mover a otra, simplemente volviendo a hacer uso del comando \u201cinterface Gi0/X\u201d=}.</p> <p>Se pueden configurar muchas interfaces a la vez haciendo uso de {==\u201cinterface range Gi0/0-3\u201d. Con este estamos configurando 4 interfaces a la vez: Gi0/0, Gi0/1, Gi0/2, Gi0/3.</p>"},{"location":"2_ComandosCisco.html#configurar-acceso-ssh","title":"Configurar Acceso SSH.","text":"<p>Telnet no es un protocolo seguro, por lo que configuraremos SSH siempre.</p> <p>1.  Generar un hostname.</p> <p>2.  Generamos un nombre de dominio.</p> <p>3.  Los pasos anteriores son necesarios para generamos el par de claves RSA. Las claves deben ser como m\u00ednimo de 2048 bits. </p> <p>4.  Una vez tengamos las claves ya podemos activar el protocolo SSH para la gesti\u00f3n remota de nuestros equipos de forma segura.</p> <p>5.  En el caso de los equipos cisco, y es similar en otros equipos existe un n\u00famero limitado de sesiones simult\u00e1neas que se pueden abrir sobre un mismo equipo. En el caso del ejemplo existen 16 terminales virtuales (vty). Vamos a indicarle al equipo que la forma de acceder a estos terminales virtuales es mediante el uso del protocolo SSH.</p> <p>6.  Finalmente debemos crear los usuarios. </p> <p>AVISO</p> <p>Con privilege indica qu\u00e9 acciones podr\u00e1 realizar este usuario, es decir, modificar configuraci\u00f3n, solo lectura, entrar en modo enable, etc... </p> <p>Con secret se establece la contrase\u00f1a del usuario. Si en vez de secret us\u00e1is la palabra password, no se cifran las contrase\u00f1as.</p> <p>Ahora un ejemplo usando password en vez de secret.</p> <p>Tras hacer un \u201cshow running-config\u201d o \u201csh run\u201d.</p> <p>7.  Por seguridad vamos a crear una contrase\u00f1a de \u201cenable\u201d esto es una contrase\u00f1a para cuando quiera acceder a dicho modo, el cual nos sirve para ver y modificar la configuraci\u00f3n.</p> <p>Recordad, de forma habitual, guardar los cambios.</p>"},{"location":"2_ComandosCisco.html#mostrar-configuracion","title":"Mostrar Configuraci\u00f3n.","text":"<p>Los equipos Cisco tienen dos memorias, una vol\u00e1til (NVRAM) y otra no vol\u00e1til (memoria flash).</p> <p>Cuando realizamos un cambio en la configuraci\u00f3n, este se aplica y dicha configuraci\u00f3n se almacena en la NVRAM. Es decir, en caso de reiniciar el equipo perder\u00edamos esos cambios realizados. A  esta configuraci\u00f3n se le llama \u201cRunning Configuration\u201d.</p> <p>Cuando el equipo Cisco arranca coge la informaci\u00f3n de la memoria flash (no vol\u00e1til). A esta configuraci\u00f3n se le conoce como \u201cStartup Configuration\u201d. </p>"},{"location":"2_ComandosCisco.html#guardar-cambios","title":"Guardar Cambios.","text":"<p>Si queremos que unos cambios persistan a un reinicio debemos copiar la \u201cRunning Config\u201d a la \u201cStartup Config\u201d, es decir, pasarlo de la NVRAM a la memoria flash. Para ello usamos el comando \u201cwrite\u201d o \u201cwr\u201d.</p>"},{"location":"2_ComandosCisco.html#resumen","title":"Resumen","text":"Comando  Funci\u00f3n  <code>enable</code> Acceder al modo administrador. <code>configura terminal</code> Entrar al CLI para modificar configuraci\u00f3n. <code>show running-config</code> Ver la configuraci\u00f3n actual. <code>show interfaces description</code> Informaci\u00f3n de las interfaces. <code>wr</code> Guardar cambios."},{"location":"3_CAM_Overflow.html","title":"PoC CAM Overflow","text":""},{"location":"3_CAM_Overflow.html#practica-ataque-cam-overflow","title":"Pr\u00e1ctica ataque CAM Overflow.","text":"<p>Vamos a realizar un ataque sobre un switch y pasarle MACs generadas aleatoriamente, con el fin de llenar su tabla CAM y generar mensajes broadcast en la red. No es necesario que consigamos el overflow. Si realmente queremos hacer el overflow es muy recomendable usar un switch que no pueda almacenar gran cantidad de MACs.</p>"},{"location":"3_CAM_Overflow.html#instrucciones","title":"Instrucciones","text":"<p>Se deben adjuntar capturas del proceso.</p> <ol> <li> <p>Crea un dise\u00f1o tal que as\u00ed.</p> <p>a.  Net: Es una red de Management.</p> <p>b.  Switch: Es un switch Cisco.</p> <p>c.  Linux: Es un Linux con imagen Kali 2021.</p> </li> </ol> <ol> <li> <p>Desde el Kali descarga el script de python \u201ccam_overflow.py\u201d. Pod\u00e9is encontrarlo en github o en el aules del curso.</p> </li> <li> <p>Una vez descargado elimina la red de Management para que no afecte a tu casa/aula el ataque.</p> </li> </ol> <ol> <li>Da permisos de ejecuci\u00f3n al script y lanza el ataque. Por defecto est\u00e1 en 10000 paquetes.</li> </ol> <ol> <li>Metete en el switch  y c\u00e1mbiale el hostname por uno tuyo para verificar que es tu equipo.</li> </ol> <pre><code>enable\nconfigure terminal\nhostname TU_NOMBRE\nend\nwrite\n</code></pre> <ol> <li>Metete en el switch y comprueba que se han insertado MACs ficticias, para ello usa el comando:</li> </ol> <pre><code>show mac address-table\n</code></pre>"},{"location":"3_CAM_Overflow.html#preguntas","title":"Preguntas","text":"<ol> <li> <p>\u00bfPara qu\u00e9 sirve la librer\u00eda de python scapy?</p> </li> <li> <p>Entra dentro del c\u00f3digo del script y comenta brevemente lo que crees que est\u00e1 haciendo l\u00ednea por l\u00ednea.</p> </li> <li> <p>\u00bfQu\u00e9 informaci\u00f3n almacena la tabla CAM de un switch?</p> </li> <li> <p>En un switch Cisco \u00bfcon qu\u00e9 comando puedo saber cu\u00e1nto tiempo se almacena una MAC en la tabla CAM? \u00bfy con cu\u00e1l puedo limpiar todas las entradas de la tabla CAM?</p> </li> <li> <p>Busca informaci\u00f3n de qu\u00e9 son las plantillas sdm de cisco y c\u00f3mo pueden afectar a la tabla CAM.</p> </li> </ol>"},{"location":"4_ConocimientosL3.html","title":"Conocimientos B\u00e1sicos L3","text":""},{"location":"4_ConocimientosL3.html#conceptos-basicos-de-la-capa-de-red","title":"Conceptos b\u00e1sicos de la capa de red.","text":""},{"location":"4_ConocimientosL3.html#router-vs-switch-l3","title":"Router vs Switch L3.","text":"<p>La capa de red est\u00e1 compuesta principalmente por los routers, aunque tambi\u00e9n existen switches que tienen capacidades de capa 3, suelen conocerse como switches L3 (level 3). Las diferencias entre ambas suelen ser los siguientes:</p> <ul> <li> <p>Los switches L3 tienen m\u00e1s puertos que los routers.</p> </li> <li> <p>Los routers soportan tablas de rutas m\u00e1s grandes. Muy pocos switches L3 soportan BGP full routing (todas las rutas de Internet).</p> </li> <li> <p>Los routers soportan muchos m\u00e1s protocolos de enrutamiento o de capa 3.</p> </li> <li> <p>Los routers suelen tener m\u00e1s capacidades de inspecci\u00f3n de tr\u00e1fico o m\u00e1s variedades de reglas de seguridad que un switch L3. </p> </li> </ul>"},{"location":"4_ConocimientosL3.html#direccionamiento","title":"Direccionamiento.","text":"<p>El principal elemento que configuramos en un router son las direcciones IP. </p> <ul> <li> <p>Son equivalentes a la direcci\u00f3n de un domicilio, nos da informaci\u00f3n de c\u00f3mo alcanzar el destino con el que queremos comunicarnos. </p> </li> <li> <p>Existen direcciones IP privadas y p\u00fablicas.</p> </li> </ul> <p>\u00bfPor qu\u00e9 existen IPs privadas y p\u00fablicas?</p> <p>Una direcci\u00f3n IP est\u00e1 compuesto por 4 grupos de 8 bits, separados por un \u201c.\u201d.</p> <p>Desde el \u201c00000000.00000000.00000000.00000000\u201d al \u201c11111111.11111111.11111111. 11111111\u201d. Si esto lo pasamos a decimal, para mejor comprensi\u00f3n las direcciones van desde el \u201c0.0.0.0\u201d al \u201c255.255.255.255\u201d. </p> <p>Si pensamos por un lado en todas las combinaciones posibles de IPs y por otro lado todos los dispositivos que existen en el mundo que tienen conexi\u00f3n a Internet: routers, m\u00f3viles, ordenadores, port\u00e1tiles, firewalls, relojes, electrodom\u00e9sticos inteligentes, c\u00e1maras, sem\u00e1foros, \u2026  \u00bfqui\u00e9n cre\u00e9is que gana?</p> <ul> <li> <p>Las direcciones p\u00fablicas son aquellas que pueden navegar por Internet. S\u00f3lo pueden ser asignadas a un dispositivo a la vez, es decir, dos dispositivos no pueden estar conectados a Internet con la misma IP p\u00fablica.</p> </li> <li> <p>Las direcciones privadas por el contrario no permiten navegar por Internet, pero s\u00ed pueden repetirse indefinidamente en redes independientes.</p> </li> </ul> <p>Por ejemplo yo puedo tener una red privada interna en mi empresa y otra empresa independiente puede hacer uso del mismo direccionamiento privado. En cambio, el router de la primera empresa tendr\u00e1 asignado una IP p\u00fablica para navegar por Internet, y esa direcci\u00f3n no puede ser usada a la vez por la otra empresa, deber\u00e1 tener asignada otra diferente.</p> <p>Viendo el siguiente diagrama de red.</p> <ul> <li>\u00bfQu\u00e9 es una red WAN y una LAN?</li> </ul> RESPUESTA <p>La LAN es nuestra red interna que alberga todos nuestros equipos/dispositivos y suelen tener configurada una IP privada.</p> <p>La WAN es la conexi\u00f3n que interconecta con nuestro ISP (Proovedor de Servicio de Internet), suele estar configurada en la boca del router y tener asignada una IP p\u00fablica. Esta red interconecta con las redes externas (Internet).</p> <ul> <li>\u00bfLas interfaces que conectan con la WAN deber\u00e1n tener IP p\u00fablica o privada?</li> </ul> RESPUESTA <p>Deber\u00e1n tener una IP p\u00fablica configurada. Normalmente esta IP pertenece al ISP.</p> <ul> <li>\u00bfQui\u00e9n asigna la IP de la interfaz WAN la propia empresa o un ISP (Internet Service Provider)?</li> </ul> RESPUESTA <p>Normalmente el ISP.</p> <ul> <li>\u00bfPueden tener el mismo direccionamiento en las interfaces WAN/LAN?</li> </ul> RESPUESTA <p>No. Una misma interfaz puede tener m\u00faltiples IPs asignadas, pero nunca la misma IP, independientemente que sea en una WAN o una LAN.</p> <ul> <li>\u00bfLas IPs de las interfaces de la red interna (LAN) deber\u00edan ser privadas o p\u00fablicas?</li> </ul> RESPUESTA <p>Pueden ser tanto p\u00fablicas como privadas, pero lo normal y correcto es usar direccionamiento privado.</p> <ul> <li>\u00bfCada empresa puede tener exactamente el mismo direccionamiento en uso?</li> </ul> RESPUESTA <p>En su red interna (LAN) s\u00ed, en la parte WAN que es la que se publica a Internet cada direccionamiento debe ser \u00fanico.</p> <ul> <li>\u00bfQui\u00e9n asigna el direccionamiento interno, la propia empresa o el ISP?</li> </ul> RESPUESTA <p>La propia empresa.</p> <ul> <li>\u00bfQui\u00e9n le asigna el direccionamiento a las ISP, por ejemplo a Telef\u00f3nica?</li> </ul> RESPUESTA <p>Existe una organizaci\u00f3n llamada IANA que se encarga en delegar en ciertas empresas la administraci\u00f3n del direccionamiento IP, existe una empresa por cada continente.</p> <p>Por ejemplo en Europa es RIPE quien se encarga de dicha tarea.</p> <ul> <li>\u00bfPara qu\u00e9 servir\u00eda el protocolo NAT en estas situaciones?</li> </ul> RESPUESTA <p>Nos permite que todos los equipos de nuestra red LAN con IPs privadas naveguen por Internet usando una \u00fanica direcci\u00f3n IP p\u00fablica.</p> <p>\u00bfCu\u00e1les son las direcciones p\u00fablicas y cu\u00e1les las privadas?</p> <p>Direccionamiento Privado.</p> <ul> <li> <p>Clase A: 10.0.0.0 \u2014 10.255.255.255</p> </li> <li> <p>Clase B: 172.16.0.0 \u2014 172.31.255.255 </p> </li> <li> <p>Clase C: 192.168.0.0 \u2014 192.168.255.255</p> </li> </ul> <p>Direccionamiento Reservado.</p> <p>Existe un grupo de redes que no son ni p\u00fablicas ni privadas, son reservadas para ciertos. Las m\u00e1s conocidas son:</p> <ul> <li> <p>127.0.0.0/8: Son direcciones de loopback de los hosts.</p> </li> <li> <p>169.254.0.0/12: Son  direccionamiento de enlace local para cuando no se especifican IPs.</p> </li> <li> <p>224.0.0.0/4: Reservado para direccionamiento multicast.</p> </li> <li> <p>255.255.255.255: Direcci\u00f3n de broadcast.</p> </li> </ul> <p>Existen algunas redes m\u00e1s reservadas, por ejemplo para experimentaci\u00f3n, pero estas son las m\u00e1s habituales.</p> <p>Redes p\u00fablicas:</p> <p>Son el resto de redes, que no son ni privadas ni reservadas.</p> <p>Las IPs p\u00fablicas pertenecen habitualmente a ISPs (Telef\u00f3nica, Vodafone, NTT, Level3) o a proveedores de contenido (Facebook, Google, Netflix, Akamai    \u2026).  Aunque este direccionamiento est\u00e1 asignado a las empresas, realmente es gestionado por organizaciones externas, una organizaci\u00f3n por cada continente. Por ejemplo en Europa la organizaci\u00f3n que se ocupa de asignar el direccionamiento y su gesti\u00f3n administrativa es RIPE. Por tanto es de conocimiento p\u00fablico a qu\u00e9 empresa pertenece a qu\u00e9 direccionamiento, incluso podemos saber geogr\u00e1ficamente d\u00f3nde se encuentra dicho direccionamiento.</p> <ul> <li> <p>AFRINIC (Africa) http://www.afrinic.net/ whois.afrinic.net</p> </li> <li> <p>APNIC (Asia Pacific) http://www.apnic.net/ whois.apnic.net</p> </li> <li> <p>ARIN (Northern America) http://www.arin.net/ whois.arin.net</p> </li> <li> <p>LACNIC (Latin America and the Carribean) http://www.lacnic.net/ whois.lacnic.net</p> </li> </ul>"},{"location":"4_ConocimientosL3.html#tablas-de-rutas","title":"Tablas de Rutas.","text":"<p>Hemos visto que los routers trabajan con IPs, pero cu\u00e1l es su funci\u00f3n.</p> <p>Su funci\u00f3n es la de poder recibir un paquete y saber cu\u00e1l es el mejor camino, dentro de sus redes, para que \u00e9ste llegue a su destino. Para ello hace uso de una tabla de rutas.  La informaci\u00f3n b\u00e1sica de una tabla de rutas se compone de lo siguiente:</p> <ul> <li> <p>Red que queremos alcanzar.</p> </li> <li> <p>Next-Hop, es decir a qu\u00e9 siguiente router le tenemos que enviar el paquete hasta llegar al destino.</p> </li> </ul> <p>M\u00e1s adelante veremos que hay m\u00e1s informaci\u00f3n en la tabla de rutas como el protocolo por el que se ha conocido la red, la m\u00e9trica, la distancia administrativa, la interfaz de salida\u2026</p> <p>Ejemplo</p> <p>Tabla de ruta del Router A (arriba).</p> Red a Alcanzar  Next-Hop  <code>192.168.10.0/24</code> Conectada Directamente. <code>192.168.20.0/24</code> 192.168.10.2. <code>192.168.30.0/24</code> Conectada Directamente. <code>192.168.40.0/24</code> 192.168.30.2. <code>192.168.50.0/24</code> 192.168.10.2. <code>192.168.60.0/24</code> 192.168.30.2."},{"location":"4_ConocimientosL3.html#repaso","title":"Repaso.","text":"<ul> <li>\u00bfPuede haber 2 entradas en nuestra tabla de rutas para la misma red? </li> </ul> RESPUESTA <p>S\u00ed, para ello se usan las distancias administrativas y las m\u00e9tricas, que veremos m\u00e1s adelante.</p> <ul> <li>\u00bfQu\u00e9 significa que la red est\u00e1 conectada directamente? </li> </ul> RESPUESTA <p>Significa que podemos entregarle el paquete al destinatario directamente puesto que se encuentra en nuestra red. \u00bfC\u00f3mo sabemos exactamente d\u00f3nde se encuentra dentro de nuestra red? Mediante el protocolo ARP averiguamos su MAC y el switch ya se encarga de pasarle el paquete.</p> <ul> <li>\u00bfQu\u00e9 es una ruta por defecto? </li> </ul> RESPUESTA <p>Una ruta por defecto sirve para en caso de recibir un paquete con un destino que no se encuentra en nuestra tabla de rutas enviarla por esta entrada. De esta forma las tablas de rutas se acortan bastante y ganamos en eficiencia. Se suele expresar como la red 0.0.0.0/0 es decir 0.0.0.0 0.0.0.0</p> <ul> <li>\u00bfPuede un paquete IP entrar en bucle como vimos en la tormenta de broadcast? </li> </ul> RESPUESTA <p>No, los paquetes IP tienen un campo llamado TTL (Time To Live), dicho campo se reduce en uno cada vez que pasa por un router, cuando llega a 0 el paquete se elimina.</p> <ul> <li>\u00bfSi ocurriera una tormenta de broadcast en la red 192.168.50.0/24 afectar\u00eda a los servicios en la red 192.168.20.0/24? </li> </ul> RESPUESTA <p>No, porque los routers no propagan el tr\u00e1fico broadcast, de tal forma que el problema se delimita a la red 192.168.50.0/24.</p> <ul> <li>\u00bfC\u00f3mo asigno un direccionamiento en mi router? </li> </ul> RESPUESTA <p>A cada interfaz o subinterfaz del router se le debe asignar una direcci\u00f3n. Pueden convivir varias direcciones dentro de la misma interfaz, una principal y el resto secundarias. </p> <ul> <li>\u00bfC\u00f3mo se rellenan la tabla de rutas? </li> </ul> RESPUESTA <p>La tabla de rutas se puede rellenar mediante entradas est\u00e1ticas insertadas por un administrador o mediante la configuraci\u00f3n de protocolos de enrutamiento din\u00e1mico. Los protocolos de enrutamiento din\u00e1mico (BGP, ISIS, OSPF, EIGRP, RIP) tienen como base la comunicaci\u00f3n entre los diferentes routers para transferirse informaci\u00f3n de sus tablas de rutas.</p>"},{"location":"5_TeoriaVLAN.html","title":"Teor\u00eda VLAN","text":""},{"location":"5_TeoriaVLAN.html#vlan","title":"VLAN.","text":"<p>Las VLAN o Virtual LAN permiten crear redes virtuales dentro una misma red f\u00edsica. Es decir, dentro de un mismo cableado, un mismo puerto y mismos equipos de red coexistir\u00e1n diferentes redes.</p>"},{"location":"5_TeoriaVLAN.html#ventajas","title":"Ventajas.","text":"<ul> <li> <p>Segmentamos los dominios de broadcast, es decir, el broadcast de una red virtual no se propagar\u00e1 a la otra red virtual.</p> </li> <li> <p>Podemos aplicar filtros a redes virtuales de forma independiente, pudiendo darle diferentes tipos de permisos o accesos a cada una.</p> </li> <li> <p>Nos permite una mejor organizaci\u00f3n y administraci\u00f3n.</p> </li> <li> <p>Es m\u00e1s f\u00e1cil acotar los problemas dependiendo de a que VLAN est\u00e9 afectando.</p> </li> <li> <p>Tiene un ahorro econ\u00f3mico pues usando los mismos equipos podemos segmentar la red.</p> </li> </ul>"},{"location":"5_TeoriaVLAN.html#tipos-de-enlaces","title":"Tipos de enlaces.","text":"<ul> <li> <p>Acceso: Solo pasa una \u00fanica VLAN. Habitualmente conecta con hosts/clientes.</p> </li> <li> <p>Troncal: Pasan varias VLANs por el mismo enlace/interfaz. </p> </li> </ul> <p>INFO</p> <p>\u00bfSi pasan varias VLANs por la misma interfaz como sabe el equipo cada trama a qu\u00e9 VLAN pertenece?</p> <p>El est\u00e1ndar 802.1Q se le asigna una etiqueta a la trama, que es b\u00e1sicamente un n\u00famero. </p> <p>Por ejemplo si es la VLAN 47 y pasa por un enlace troncal se le a\u00f1ade una etiqueta con el n\u00famero 47.</p>"},{"location":"5_TeoriaVLAN.html#tipos-de-vlans","title":"Tipos de VLANs.","text":"<ul> <li> <p>Datos: Son las VLANs habituales.</p> </li> <li> <p>Administraci\u00f3n: Son VLANs donde solo deber\u00eda ir tr\u00e1fico de gesti\u00f3n de los equipos, si es posible deber\u00eda ir por puertos independientes al de los datos, de tal forma que si hay un problema con el tr\u00e1fico de clientes no perderemos el acceso a nuestros equipos.</p> </li> <li> <p>Nativa: Se usa para diferencia una VLAN sin etiqueta dentro de un enlace troncal. Se usa mayormente para gestionar equipos que no soportan el est\u00e1ndar dot1q. Solo puede haber una vlan nativa por cada enlace troncal.</p> </li> </ul>"},{"location":"5_TeoriaVLAN.html#ejemplo","title":"Ejemplo:","text":"<p>\ud83d\udca5   Tenemos 3 VLANs: 10,20 y 30.</p> <p>\ud83d\udca5   Cada VLAN tiene una red diferente:</p> <pre><code>    VLAN 10 --&gt; 172.17.10.0/24.\n\n    VLAN 20 --&gt; 172.17.20.0/24.\n\n    VLAN 30 --&gt; 172.17.30.0/24.\n</code></pre> <p>\ud83d\udca5 Los puertos que conectan con PCs solo tienen que pasar una \u00fanica VLAN, por lo que la interfaz se configura como access.</p> <p>\ud83d\udca5   Los puertos que interconectan entre los switches deber\u00e1n dejar pasar varias VLANs, por lo que ir\u00e1n en modo trunk o ser\u00e1n enlaces troncales.</p> <ul> <li>\u00bfPueden dos equipos dentro de la misma VLAN comunicarse?</li> </ul> RESPUESTA <p>S\u00ed.</p> <ul> <li>\u00bfPueden dos equipos de diferentes VLANs comunicarse? En caso negativo qu\u00e9 ser\u00eda necesario.</li> </ul> RESPUESTA <p>No, necesitar\u00edan un router que enrutara el tr\u00e1fico entre VLANs.</p>"},{"location":"5_TeoriaVLAN.html#roas-router-on-a-stick","title":"ROAS (Router On A Stick).","text":"<p>Para que dos equipos en VLANs diferentes puedan comunicarse deber\u00e1 haber un router que sea capaz de entender el direccionamiento IP \u00bfPor qu\u00e9?</p> RESPUESTA <p>Los switches solo entienden de MACs (capa 2), no leen la cabecera de IP origen/destino.</p> <p>\u00bfPero por qu\u00e9 no pueden aprender las MACs de los equipos en VLANs diferentes mediante ARP?</p> <p>Porque las VLANs segmentan el dominio de broadcast, es decir, un broadcast ARP para averiguar una MAC de una IP que se encuentra en otra VLAN nunca alcanzar\u00e1 su destino.</p> <p>INFO</p> <p>En la capa 2 (Layer 2) se a\u00f1ade una cabecera y una cola. Los equipos de capa 2 s\u00f3lo se centran en esta cabecera y capa, por lo que no miran las cabeceras IP, TCP, aplicaci\u00f3n, etc.</p> <p>\u00bfQu\u00e9 hay dentro de esta cabecera de capa 2? Pues dicha cabecera puede ser diferente dependiendo del protocolo usado, por ejemplo en el 802.1Q se a\u00f1ade una etiqueta, pero la trama habitual suele seguir el protocolo Ethernet que es el siguiente.</p> <p>Por tanto para que varias VLANs se vean entre si debemos utilizar un router. </p> <p>\u00bfNecesitamos un puerto del router para cada VLAN? Podr\u00edamos hacerlo de dicha forma pero ser\u00eda un gasto econ\u00f3mico in\u00fatil, pues podemos hacer exactamente lo mismo a trav\u00e9s de un \u00fanico puerto, de ah\u00ed el concepto de ROAS (Router On A Stick).</p>"},{"location":"5_TeoriaVLAN.html#ejemplo-de-configuracion-de-vlans-en-un-switch","title":"Ejemplo de configuraci\u00f3n de VLANs en un Switch.","text":"<p>INFO</p> <p>Recordad que para entrar en modo configuraci\u00f3n, primero hay que entrar en modo enable:</p> <p></p> <ol> <li>Crear la VLAN.</li> </ol> COMANDO <p></p> <ol> <li>Darle Nombre a la VLAN.</li> </ol> COMANDO <p></p> <ol> <li>Comprobar que lo has creado bien.</li> </ol> COMANDO <p></p> <ol> <li>Configurar un puerto en Access.</li> </ol> COMANDO <p></p> <ol> <li>Configurar un puerto en trunk con ciertas vlans.</li> </ol> COMANDO <p></p> <ol> <li>A\u00f1adir una vlan a un puerto en trunk.</li> </ol> COMANDO <p></p> <ol> <li>Eliminar una vlan de un puerto en trunk.</li> </ol> COMANDO <p></p> <ol> <li>A\u00f1adir una vlan nativa en un puerto en trunk.</li> </ol> COMANDO <p></p> <ol> <li>Borrar una VLAN del sistema.</li> </ol> COMANDO <p></p>"},{"location":"6_DHCP.html","title":"DHCP","text":""},{"location":"6_DHCP.html#dhcp","title":"DHCP.","text":"<ul> <li> <p>Permite la asignaci\u00f3n autom\u00e1tica de direccionamiento IP/m\u00e1scara/puerta de enlace/servidores DNS.</p> </li> <li> <p>Puertos:</p> <p>\ud83d\udca5 67/UDP (servidor)</p> <p>\ud83d\udca5 68/UDP (cliente)</p> </li> <li> <p>Basado en el protocol \u201cBOOTP\u201d.</p> </li> <li> <p>En wireshark podremos filtrar por \u201cbootp\u201d o \u201cdhcp\u201d para buscar informaci\u00f3n de estos protocolos.</p> </li> </ul>"},{"location":"6_DHCP.html#mensajes-del-protocolo","title":"Mensajes del protocolo.","text":"<ol> <li> <p>DISCOVER: El cliente, el cual no tiene IP, manda un mensaje de broadcast (255.255.255.255) con origen (0.0.0.0). El puerto origen 68 (cliente), el puerto destino 67 (servidor).</p> </li> <li> <p>OFFER: El mensaje es recibido por todos los equipos de la red, pero s\u00f3lo el servidor est\u00e1 escuchando en el puerto 67 (UDP), por lo que ser\u00e1 \u00e9ste quien conteste con una oferta, indicando la IP que le ofrece configurarse.</p> <p>a.  El servidor inserta en su tabla de asignaciones de forma temporal (15 \u2013 60 segundos) la oferta mandada. Es decir, que si en ese tiempo el cliente no confirma la oferta, se libera esa IP de la tabla de asignaci\u00f3n.</p> <p>b.  Ejemplo del contenido OFFER:</p> </li> </ol> <p>INFO</p> <p>El mensaje OFFER se env\u00eda directamente a la IP destino 192.168.0.10, pero el cliente a\u00fan no tiene configurada esa IP \u00bfC\u00f3mo le llega el mensaje?</p> RESPUESTA <p>El servidor tiene su MAC por lo que el paquete le llegar\u00e1 al cliente (se encuentran en la misma red), adem\u00e1s lo env\u00eda al puerto 68 del cliente, el cual est\u00e1 esperando respuesta tras enviar el DISCOVERY.</p> <p>Al ser un mensaje broadcast por parte del cliente lo hace, a priori, muy f\u00e1cil hacerse pasar por un servidor DHCP falso, pues todos los dispositivos en la red sabr\u00e1n que est\u00e1 buscando un servidor DHCP</p> <ol> <li> <p>REQUEST: El cliente al sopesa la oferta e indica si est\u00e1 de acuerdo con dicha oferta.</p> </li> <li> <p>ACK: El servidor confirma el cambio en su tabla de asignaciones y confirma el cambio.</p> <p>a.  Una vez confirmado el cambio en la tabla de asignaciones estar\u00e1 ah\u00ed durante el tiempo estimado en el Lease Time del servidor.</p> <p>b.  El cliente al recibir el ACK se configura el direccionamiento en su tarjeta.</p> </li> </ol>"},{"location":"6_DHCP.html#servidor-dhcp-relay","title":"Servidor DHCP Relay.","text":"<ul> <li> <p>En principio un servicio DHCP asigna direccionamiento IP a equipos dentro de su misma red.</p> </li> <li> <p>Si necesitamos asignar direccionamiento a equipos en redes diferentes necesitamos configurar TODOS los routers intermedios como DHCP Relay, para que cuando reciban un mensaje DISCOVER lo reenv\u00eden al servidor DHCP que se encuentra en otra red, y lo mismo en sentido contrario con el OFFER y el resto de mensajes.</p> </li> </ul>"},{"location":"6_DHCP.html#ejemplo","title":"Ejemplo:","text":"<p>En el siguiente ejemplo hay:</p> <ul> <li> <p>Un DHCP Relay configurado en las VLANS 40 y 50</p> </li> <li> <p>S\u00f3lo en el puertos Gi1/05 (el te1/0/3 est\u00e1 configurado pero inactivo).</p> </li> <li> <p>Los servidores configurados son 124.167.1.1 y 124.200.1.1.</p> </li> </ul> <p>Por tanto cuando reciba un mensaje con destino 255.255.255.255 al puerto 67, lo reenv\u00eda al servidor DHCP 124.167.1.1 y 124.200.1.1.</p> <p>CUIDADO</p> <p>En caso de que para llegar a dichos servidores DHCP tenga que pasar por otros routers, dichos routers intermedios tambi\u00e9n tendr\u00e1n que tener configurado dicho servicio DHCP Relay.</p>"},{"location":"7_ConceptosL4.html","title":"Conceptos B\u00e1sicos L4","text":""},{"location":"7_ConceptosL4.html#principales-protocolos-capa-de-transporte-capa-4","title":"Principales Protocolos Capa de Transporte (capa 4).","text":"<p>Los protocolos de capa 4 suelen hacer referencia a los puertos de red. </p> <p>Un puerto de red no es m\u00e1s que un identificador de la aplicaci\u00f3n (capa 5) para la que va dirigida el mensaje.</p> <p>Ejemplo 1</p> <p>Si un servidor web recibe un mensaje al puerto 80, el sistema operativo sabe que ese mensaje lo tiene que entregar al servicio web (no confundir con el navegador web).</p> <p>Ejemplo 2</p> <p>Si un navegador manda un mensaje con origen puerto 3333, esa informaci\u00f3n queda registrada (conexi\u00f3n establecida), m\u00e1s adelante cuando ese equipo reciba un mensaje del servidor web al puerto 3333 sabr\u00e1 que es informaci\u00f3n para el navegador, pues tiene una conexi\u00f3n previa establecida.</p>"},{"location":"7_ConceptosL4.html#tcp-transmission-control-protocol","title":"TCP (Transmission Control Protocol).","text":"<ul> <li> <p>Orientado a conexi\u00f3n. Por tanto es obligatorio establecer una conexi\u00f3n entre los mensajes a partir de una serie de mensajes y a su vez mensajes de desconexi\u00f3n.</p> </li> <li> <p>Los paquetes vienen numerados y por tanto se pueden reordenar. Es decir, si el paquete 10 llega antes que el paquete 8, el protocolo TCP es capaz de reordenarlo. Siempre y cuando esos paquetes pertenezcan a la misma ventana.</p> </li> <li> <p>Se comprueba que se reciben todos los paquetes, si por ejemplo no se recibe el paquete 10 y s\u00ed se han recibido los paquetes 11, 12 y 13, habr\u00e1 que finalmente volverlos a reenviar todos.</p> </li> </ul>"},{"location":"7_ConceptosL4.html#mensajes-de-conexion","title":"Mensajes de conexi\u00f3n.","text":""},{"location":"7_ConceptosL4.html#mensajes-de-desconexion","title":"Mensajes de desconexi\u00f3n.","text":""},{"location":"7_ConceptosL4.html#protocolos-habituales-que-usan-tcp","title":"Protocolos habituales que usan TCP:","text":"<ul> <li> <p>HTTP/HTTPS (80/443).</p> </li> <li> <p>SMTP (25).</p> </li> <li> <p>FTP (20 + 21).</p> </li> <li> <p>TELNET (23).</p> </li> <li> <p>SSH (22).</p> </li> </ul>"},{"location":"7_ConceptosL4.html#udp-user-datagram-protocol","title":"UDP (User Datagram Protocol).","text":"<ul> <li> <p>Protocolo no orientado a conexi\u00f3n. No es necesario establecer una conexi\u00f3n para comenzar a enviar datos, es decir, puedes directamente comenzar a enviar datos.</p> </li> <li> <p>Los paquetes pueden llegar desordenados, pues no van numerados.</p> </li> <li> <p>No es necesario confirmar la recepci\u00f3n de los paquetes. Si se pierde un paquete no pasa nada.</p> </li> <li> <p>Se suele usar este protocolo en todos aquellos casos donde la posible p\u00e9rdida de datos sea un mal menor a que haya m\u00e1s latencia.</p> <p>Ejemplo: Telefon\u00eda (VoIP), Juegos Online o IPTV.</p> <p>Ejemplo: Es preferible que haya una pixelaci\u00f3n a que se corte el v\u00eddeo. En cambio en una web es preferible esperar un segundo m\u00e1s y que est\u00e9 todo el contenido.</p> </li> </ul> <p>DNS</p> <p>El ejemplo m\u00e1s raro que usa UDP es el protocolo DNS, esto se debe a que las solicitudes DNS son peque\u00f1as y se pueden enviar en un mismo datagrama y adem\u00e1s tambi\u00e9n se puede llevar un control de errores desde la capa de aplicaci\u00f3n. Porsupuesto apremia una r\u00e1pida respuesta sin establecer conexi\u00f3n pues son servidores que reciben millones de peticiones.</p>"},{"location":"8_NAT.html","title":"NAT","text":""},{"location":"8_NAT.html#nat-network-address-translation","title":"NAT (Network Address Translation).","text":"<p>Aproximadamente existen 3706452992 direcciones p\u00fablicas IPv4 que pueden usarse para navegar por Internet. Si cada dispositivo conectado a Internet usara una de estas direcciones no habr\u00eda direcciones suficientes.</p> <p>Por ello existen 2 soluciones principales:</p> <ul> <li> <p>IPv6</p> </li> <li> <p>NAT</p> </li> </ul>"},{"location":"8_NAT.html#tipos-de-nat","title":"Tipos de NAT.","text":""},{"location":"8_NAT.html#nat-estatico","title":"NAT est\u00e1tico.","text":"<p>Es una traducci\u00f3n de una IP interna a una IP externa. No ahorra IPs, lo \u00fanico que hace es enmascarar la IP original que hace la petici\u00f3n.</p>"},{"location":"8_NAT.html#nat-dinamico","title":"NAT din\u00e1mico.","text":"<p>Dada una bolsa de IPs externas vamos asignando de forma din\u00e1mica traducciones a las IPs internas que los soliciten. El ahorro de IPs es m\u00ednimo y nulo si el n\u00famero de IPs externas es igual a de internas.</p>"},{"location":"8_NAT.html#nat-por-puertos-pat","title":"NAT por puertos (PAT).","text":"<p>Una IP tiene un total de 65535 puertos. NAT PAT va asignando puertos a cada conexi\u00f3n interna que se solicite, de esta forma con una \u00fanica IP se consigue dar servicios a m\u00faltiples IPs, hasta un total de 65535 conexiones por IP externa, aunque una IP interna hace uso de cientos de conexiones diferentes.</p>"},{"location":"8_NAT.html#cgnat","title":"CGNAT.","text":"<p>En este caso es el operador el que gestiona el NAT de sus clientes de forma centralizada y no el router de cada cliente. Es m\u00e1s eficiente que el NAT PAT. El problema es que el cliente pierde la libertad de poder abrir sus puertos para iniciar un servicio.</p>"},{"location":"8_NAT.html#nat64","title":"NAT64.","text":"<p>Es un NAT que permite comunicar equipos con IPv6 navegar como si tuvieran asignados IPv4.</p>"},{"location":"8_NAT.html#limitaciones","title":"Limitaciones.","text":"<p>A medida que vamos navegando esta tabla NAT del router crece.</p> <p>Esto gnera una serie de limitaciones:</p> <ul> <li> <p>En este caso toda nuestra LAN est\u00e1 siendo traducida a una IP de la WAN relacionada con sus puertos, pero hay un n\u00famero de puertos finitos que pueden asociarse a una IP, en caso de que se llenen empezar\u00eda a dar problemas. La soluci\u00f3n ser\u00eda asignar un rango de IPs para la traducci\u00f3n en la WAN, esto solo pasar\u00eda si tuvieramos una red LAN muy grande que est\u00e1 siendo traducida.</p> </li> <li> <p>Existe tambi\u00e9n un m\u00e1ximo de memoria destinado a almacenar IPs traducidas, si esto se llena tambi\u00e9n existe un problema. La soluci\u00f3n ser\u00eda limpiar la tabla NAT o bajar el tiempo que se almacena una conexi\u00f3n en memoria.</p> </li> </ul> <p>\u00bfHay alguna forma para las operadoras de sacar m\u00e1s rendimiento a las direcciones IP p\u00fablicas en relaci\u00f3n al n\u00famero de clientes que tiene? </p> RESPUESTA <p>S\u00ed, usando CGNAT.</p> <ul> <li>\u00bfQu\u00e9 problema puedo tener detr\u00e1s de un NAT si quiero levantar un servicio para mis clientes? \u00bfCu\u00e1l es la soluci\u00f3n? \u00bfY si estoy detr\u00e1s de un CGNAT?</li> </ul> RESPUESTA <p>Si estoy detr\u00e1s de un NAT el problema es que desde el exterior no se puede iniciar una comunicaci\u00f3n, siempre se tiene que iniciar la comunicaci\u00f3n desde dentro, por lo que si tenemos un servidor en un NAT no podr\u00eda ser accedido por los clientes.</p> <p>La soluci\u00f3n es \"abrir los puertos\" en el router. Esto no es m\u00e1s que decirle por ejemplo que todo lo que le llegue a la IP p\u00fablica en el puerto X, por ejemplo el 443, que lo redirija a la IP privada de nuestro servidor.</p> <p>Si estamos detr\u00e1s de un CGNAT no podr\u00edamos abrir puertos y nuestra \u00fanica soluci\u00f3n ser\u00eda llamar a nuestro ISP para que nos sacara del CGNAT.</p>"},{"location":"9_EnrutamientoDinamico.html","title":"Enrutamiento Din\u00e1mico","text":""},{"location":"9_EnrutamientoDinamico.html#protocolos-de-enrutamiento-dinamico","title":"Protocolos de enrutamiento din\u00e1mico.","text":"<p>Objetivos.</p> <ul> <li> <p>Descubrir autom\u00e1ticamente las diferentes rutas que puede haber para llegar a un destino.</p> </li> <li> <p>Elegir la mejor ruta hacia el destino llegado el caso, por ejemplo aquel m\u00e1s r\u00e1pido, menos saturado, etc.</p> </li> <li> <p>Si cae un camino el protocolo de enrutamiento din\u00e1mico lo detecta y descarta dicho camino.</p> </li> </ul> <p>\u00bfC\u00f3mo funcionan los protocolos de enrutamiento din\u00e1mico?</p> <p>Los protocolos de enrutamiento trabajan con las tablas de rutas y por tanto se configuran en los routers. Los routers a los que se le configura el protocolo establecen una comunicaci\u00f3n entre s\u00ed, esto les permite intercambiarse la tabla de rutas o estados de ciertos caminos que pueden haber sufrido una aver\u00eda.</p> <p>\u00bfQu\u00e9 es el Tiempo de conversi\u00f3n?</p> <p>La convergencia se produce cuando todos los routers que conforman el protocolo de enrutamiento din\u00e1mico tienen toda la informaci\u00f3n completa. Mayormente es enviar la informaci\u00f3n de su tabla de rutas, recibir la informaci\u00f3n del resto, a\u00f1adirla y establecer cu\u00e1l es la mejor ruta activa en ese momento para cada destino.</p> <p>La red no es operativa hasta que el protocolo de enrutamiento din\u00e1mico en cuesti\u00f3n haya convergido. Es decir, si sufrimos una aver\u00eda grande y el protocolo de enrutamiento din\u00e1mico cae, una vez restablecido la conexi\u00f3n debemos esperar a que el protocolo de enrutamiento converja completamente para volver a tener conectividad, obviamente este tiempo tambi\u00e9n depende del n\u00famero de rutas que se compartan.</p> <p>En orden de velocidad de convergencia de los protocolos de enrutamiento din\u00e1mico encontrar\u00edamos: ISIS, EIGRP, OSPF y BGP.</p> <p>Protocolos de enrtutamiento din\u00e1mico interno (IGP) y externo (EGP).</p> <p>IGP:</p> <ul> <li> <p>Sirven para comunicarse con routers dentro de tu red.</p> </li> <li> <p>No podemos anunciar rutas a Internet a trav\u00e9s de estos protocolos. </p> </li> <li> <p>Habitualmente propagan las redes privadas de una empresa.</p> </li> <li> <p>ISIS, OSPF e EIGRP son los m\u00e1s usados, especialmente OSPF e EIGRP.</p> </li> </ul> <p>EGP:</p> <ul> <li> <p>Son aquellos protocolos que permiten anunciar rutas entre AS (Sistemas Aut\u00f3nomos) diferentes.</p> </li> <li> <p>Permiten anunciar rutas a Internet.</p> </li> <li> <p>El protocolo usado actualmente es BGP.</p> </li> </ul> <p>Sistema Aut\u00f3nomo</p> <p>Un AS es una entidad bajo la cual existen una o varias redes. Se puede ver como un identificador para una empresa.</p>"},{"location":"9_EnrutamientoDinamico.html#ospf","title":"OSPF.","text":"<p>Se elige un router maestro, conocido como \u201cDR o router designado\u201d, adem\u00e1s se elige un router de backup o BDR.</p> <p>La informaci\u00f3n con las rutas de cada router se conocen como LSA.</p> <p>El DR es el encargado de enviarle el LSA de todo el conjunto de routers al resto de vecinos asociados al protocolo, esto se hace mediante la IP reservada multicast 224.0.0.5.</p> <p>Un vecino env\u00eda su LSA \u00fanicamente al DR y BDR y \u00e9stos ser\u00e1n los que se encargar\u00e1n a posteriori de envi\u00e1rselo a los dem\u00e1s. Esto permite un mejor control de que todos los routers tengan la misma tabla rutas en todo momento, pero por el contrario el DR sufre m\u00e1s carga de trabajo que el resto de routers, por lo que se recomienda que sea un equipo potente.</p>"},{"location":"9_EnrutamientoDinamico.html#ejemplo-del-dr-enviando-los-lsa","title":"Ejemplo del DR enviando los LSA.","text":""},{"location":"9_EnrutamientoDinamico.html#ejemplo-de-un-vecino-mandando-su-lsa","title":"Ejemplo de un vecino mandando su LSA.","text":""},{"location":"9_EnrutamientoDinamico.html#ejemplo-de-configuracion-basica","title":"Ejemplo de configuraci\u00f3n b\u00e1sica.","text":"<p>Configuramos la interfaz/subinterfaz</p> <pre><code>interface FastEthernet0/0.5\n encapsulation dot1Q 5\n ip address 192.168.5.1 255.255.255.0\n ip ospf authentication-key salva\n ip ospf dead-interval 5\n ip ospf hello-interval 1\n ip ospf priority 255\n</code></pre> <ul> <li> <p>ip ospf authentication-key salva: Contrase\u00f1a para que no cualquier router conectado a la red pueda asociarse al protocolo y tener nuestra table de rutas.</p> </li> <li> <p>ip ospf dead-interval X: Segundos tras los cual si no contesta un vecino se le da por muerto y se anulan las rutas que pasan por \u00e9l. Por defecto 40 segundos.</p> </li> <li> <p>ip ospf hello-interval X: Segundos tras los que manda un saludo a sus vecinos con el fin de comprobar si ha habido alguna aver\u00eda. Por defecto su valor es 10 segundos.</p> </li> <li> <p>ip ospf priority X: Prioridad de cada router para ser el router designado (DR), el router designado de reserva (BDR) o un simple nodo. Si la prioridad es 0 jam\u00e1s podr\u00e1 ser el router designado. A mayor n\u00famero mayor prioridad (255).</p> </li> </ul> <p>Para que el protocolo levante todos los routers configurados deben tener los mismos intervalos y la misma contrase\u00f1a.</p> <p>Configuramos el proceso OSPF.</p> <pre><code>router ospf 123\n router-id 192.168.5.1\n redistribute connected subnets\n network 192.168.5.0 0.0.0.255 area 1\n</code></pre> <ul> <li> <p>router-id: Es la IP con la que el router se identificar\u00e1 con sus vecinos. Normalmente es la IP que tiene asignada en la interfaz/subinterfaz donde hemos configurado el proceso.</p> </li> <li> <p>redistribute connected subnets: Indica que va a redistribuir todas las redes y subredes que conozca que est\u00e9n conectadas directamente.</p> </li> <li> <p>network 192.168.5.0 0.0.0.255 area 1: Activa el proceso OSPF en las interfaces donde tenga esa red configurada. </p> </li> </ul>"},{"location":"A_CiscoACL.html","title":"ACL","text":""},{"location":"A_CiscoACL.html#cisco-acl","title":"Cisco ACL.","text":"<p>El funcionamiento es exactamente igual en cualquier fabricante.</p> <p>Lo \u00fanico a tener en cuenta es que en Cisco existen dos tipos de ACL:</p> <ul> <li> <p>ACL standard.</p> <p>\ud83d\udca5   No llevan nombre, se pueden numerar del 1-99 o del 1300-1999.</p> <p>\ud83d\udca5 Solo permite filtrar por IP origen.</p> </li> <li> <p>ACL extendidas.</p> <p>\ud83d\udca5   Pueden llevar nombres o un n\u00famero entre 100-199 o 2000-2699.</p> <p>\ud83d\udca5   Puede filtrar por origen/destino.</p> <p>\ud83d\udca5   Puede filtrar por protocolo / puerto de conexiones espec\u00edficas.</p> <p>\ud83d\udca5   Es m\u00e1s f\u00e1cil editar las ACL extendidas.</p> </li> </ul> <p>ACL STANDARD</p> <p>Por norma general no tiene mucho sentido usar ACL standard al no ser que sea algo extremadamente sencillo y que no vaya a cambiar en el tiempo.</p>"},{"location":"A_CiscoACL.html#configuracion-acl-standard","title":"Configuraci\u00f3n ACL Standard:","text":"access-list X [deny | permit | remark ] [ network | any | host ] [ log ] <ul> <li> <p>X: Hace referencia al n\u00famero identificativo de la ACL.</p> </li> <li> <p>[ deny | permit |remark ]: Indica que har\u00e1 si encuentra una ocurrencia (match), si lo permite o lo deniega. En el caso de remark es simplemente un comentario informativo, por ejemplo para indicar que hace la l\u00ednea de la ACL.</p> </li> <li> <p>[ network | any | host ]: A qui\u00e9n afecta dicha ACL, a una red de equipos, a cualquiera o a un host. </p> <p>\ud83d\udca5 Network siempre va asociado de una wildcard (m\u00e1scara inversa).</p> <p> </p> <p> </p> <p>\ud83d\udca5 Any: Simplemente afecta a cualquiera.</p> <p> </p> <p>\ud83d\udca5 Host: Afecta un equipo en concreto.</p> <p> </p> </li> <li> <p>Log: Simplemente registra cada vez que hay un match debido a esa regla en concreto. No es muy recomendable al no ser que sea algo muy importante de lo que queramos visibilidad. El problema es que consume CPU y memoria.</p> </li> </ul>"},{"location":"A_CiscoACL.html#configuracion-basica-acl-extendida","title":"Configuraci\u00f3n B\u00e1sica ACL Extendida.","text":"ip access-list extended [ NOMBRE | N\u00daMERO ] [ permit | deny | remark ] protocol [ host | network | any ] [ host | network | any ] [ eq puerto ]"},{"location":"A_CiscoACL.html#ejemplo-1","title":"Ejemplo 1.","text":""},{"location":"A_CiscoACL.html#ejemplo-2","title":"Ejemplo 2.","text":"<pre><code>ip access-list extended ACL-PROTECT-OUT\n deny   tcp any any fragments\n deny   udp any any fragments\n deny   icmp any any fragments\n deny   ip any any fragments\n deny   tcp any any eq www\n deny   udp any any eq domain\n deny   tcp any any eq domain\n permit ip any any\n</code></pre>"},{"location":"A_CiscoACL.html#ejemplo-2_1","title":"Ejemplo 2.","text":"<pre><code>ip access-list extended ACL_PROTECT\n deny   tcp any any fragments\n deny   udp any any fragments\n deny   icmp any any fragments\n deny   ip any any fragments\n permit icmp 192.168.123.0 0.0.0.255 any echo\n permit ip 192.168.123.0 0.0.0.255 any\n permit ip 84.232.0.0 0.0.0.255 any\n permit ip 77.123.0.0 0.0.0.255 any\n deny   ip any any\n</code></pre>"},{"location":"A_CiscoACL.html#aplicar-el-filtro-en-los-puertos","title":"Aplicar el filtro en los puertos.","text":"<p>Una vez creado los filtros es necesarios aplicarlos en las interfaces.</p> <p>IN/OUT</p> <p>Es muy importante ser consciente de que los filtros se pueden aplicar para el tr\u00e1fico saliente o entrante.</p> <pre><code>interface FastEthernet0/0\n description LAN\nip address 84.232.0.1 255.255.255.0\n ip access-group ACL-PROTECT in\n ip access-group ACL-PROTECT-OUT out\n</code></pre>"},{"location":"A_CiscoACL.html#modoficar-una-acl","title":"Modoficar una ACL.","text":"<p>Podemos comprobar que se le asigna un n\u00famero a cada l\u00ednea del filtro ACL.</p> <p>Por tanto podemos a\u00f1adir reglas entre dichos n\u00fameros.</p> <p>Para comprobar que se ha a\u00f1adido la nueva regla dentro del filtro.</p> <p>MODIFICAR ACL</p> <p>Tambi\u00e9n se puede modificar o susituir una regla ya creada.</p> <p>Para eliminar una l\u00ednea basta con hacer \"no X\", donde X es la l\u00ednea a elimninar.</p>"},{"location":"A_ComandosCisco2.html","title":"Comandos Router","text":""},{"location":"A_ComandosCisco2.html#comandos-basicos-cisco-router","title":"Comandos b\u00e1sicos Cisco Router.","text":""},{"location":"A_ComandosCisco2.html#entrar-en-modo-enable-y-posteriormente-en-configuracion","title":"Entrar en modo enable y posteriormente en configuraci\u00f3n","text":""},{"location":"A_ComandosCisco2.html#cambia-el-nombre-del-router","title":"Cambia el nombre del router.","text":""},{"location":"A_ComandosCisco2.html#levantar-las-interfaces-que-vayamos-a-usar","title":"Levantar las interfaces que vayamos a usar.","text":""},{"location":"A_ComandosCisco2.html#darle-una-descripcion-a-la-interfaz","title":"Darle una descripci\u00f3n a la interfaz.","text":""},{"location":"A_ComandosCisco2.html#hay-vlans","title":"\u00bfHay VLANS?","text":"<pre><code>a. S\u00ed --&gt; Necesito subinterfaces.\n\nb. No --&gt; Lo configuro todo en la interfaz.\n</code></pre>"},{"location":"A_ComandosCisco2.html#configurar-la-ip-estatica-en-una-interfaz","title":"Configurar la IP est\u00e1tica en una interfaz","text":""},{"location":"A_ComandosCisco2.html#configurar-una-ip-dinamica-por-dhcp-en-una-interfaz","title":"Configurar una IP din\u00e1mica por DHCP en una interfaz.","text":""},{"location":"A_ComandosCisco2.html#configurar-una-subinterfaz","title":"Configurar una subinterfaz.","text":"<p>Habitualmente que el n\u00famero de la subinterfaz coincida con la VLAN que representa. Se puede poner una descripci\u00f3n por subinterfaz</p>"},{"location":"A_ComandosCisco2.html#configurar-rutas-estaticas","title":"Configurar rutas est\u00e1ticas.","text":"<p>El next-hop tiene que ser una IP que conozca de una red conectada directamente.</p> <p>Hay dos formas de establecer la ruta, indirecta o directa. Pod\u00e9is escoger la que quer\u00e1is.</p>"},{"location":"A_ComandosCisco2.html#configurar-ruta-por-defecto","title":"Configurar ruta por defecto.","text":""},{"location":"A_ComandosCisco2.html#ver-la-tabla-de-rutas","title":"Ver la tabla de rutas.","text":""},{"location":"A_ComandosNAT.html","title":"Comandos NAT","text":""},{"location":"A_ComandosNAT.html#comandos-nat","title":"Comandos NAT.","text":"<p>Dado el siguiente esquema vamos a configurar el router para que el PC pueda navegar usando una IP privada \"NATEADA\".</p>"},{"location":"A_ComandosNAT.html#configurar-las-interfaces","title":"Configurar las interfaces.","text":"<p>Levantar las interfaces.</p> <p>Por defecto un router viene con las interfaces administrativamente apagadas o tiradas (admin down). </p> <p>Por lo que vamos a proceder a levantarlas, tanto la Fa0/0 como la Fa1/0.</p> <pre><code>int Fa0/0\nno shutdown \n\nint Fa1/0\nno shutdown\n</code></pre> <p>Configurar la IP de las interfaces</p> <pre><code>int Fa0/0\ndescription WAN\nip address dhcp\n\nint Fa1/0\ndescription LAN\nip address 10.0.0.1 255.255.255.0\n</code></pre>"},{"location":"A_ComandosNAT.html#configurar-nat","title":"Configurar NAT.","text":"<p>La idea es que las IPs de nuestra LAN (10.0.0.0/24), salgan por la WAN enmascarada o traducida como una 192.168.1.X/24 (En un caso real ser\u00eda una red p\u00fablica).</p> <p>Generamos un pool</p> <p>En primer lugar vamos a generar un \u201cpool\u201d o un grupo de IPs, en el caso de Cisco lo vamos a hacerlo a trav\u00e9s de una lista de acceso. </p> <p>Toda IP origen que cumpla esta regla se meter\u00e1 dentro del NAT para su traducci\u00f3n. En este caso coincide con cualquier IP dentro de la 10.0.0.0/24 que tenemos configurada en nuestra LAN.</p> <pre><code>access-list 1 permit 10.0.0.0 0.0.0.255\n</code></pre> <p>WILDCARD</p> <p>El 0.0.0.255 se conoce como wildcard y selecciona aquellos bits que coincidan con 0s, es decir, en el ejemplo todo lo que empiece por 10.0.0.X tendr\u00e1 una coincidencia.</p> <p>Configurar Traducci\u00f3n PAT</p> <p>Deberemos decirle cu\u00e1les ser\u00e1n las IPs que vayan a traducirse (10.0.0.0/24) y por cuales se van a traducir (la configurada en nuestra WAN).</p> <p>Las IPs que van a ser traducidas normalmente se conocen como \u201cInside local\u201d (10.0.0.0/24) y las IPs por las que van a ser traducidas y que van a ser visibles del exterior son \u201cGlobal local\u201d (WAN).</p> <p>Recordemos que \u201csource list 1\u201d hace referencia a la lista de acceso creado en el paso anterior y la interfaz F0/0 es nuestra interfaz WAN.</p> <pre><code>ip nat inside source 1 interface Fa0/0 overload\n</code></pre> <p>Configurar NAT dentro de las interfaces</p> <p>Ahora vamos a especificar el papel de cada interfaz dentro del NAT. </p> <p>Recordamos que inside son las IPs que se van a traducir (habitualmente nuestra LAN) y el nat outside es la IP por la que se traducen (habitualmente nuestra WAN).</p> <pre><code>int Fa0/0\nip nat outside\n\nint Fa1/0\nip nat inside\n</code></pre>"},{"location":"A_ComandosNAT.html#comprobaciones","title":"Comprobaciones.","text":"<p>Lanzar un ping</p> <p>Desde el PC probaremos a lanzar un ping, por ejemplo al 8.8.8.8</p> <p>Comprobar traducciones</p> <p>Desde el router podemos comprobar que se est\u00e1n haciendo traducciones.</p>"},{"location":"A_Configuraci%C3%B3nMikrotik.html","title":"Configuraci\u00f3n B\u00e1sica","text":""},{"location":"A_Configuraci%C3%B3nMikrotik.html#mikrotik-hardening","title":"Mikrotik Hardening.","text":"<p>Vamos a ver las pol\u00edticas de seguridad m\u00e1s habituales que podemos configurar en los equipos de red (hardening). Practicaremos con el mikrotik y posteriormente buscaremos opciones para otros fabricantes.</p>"},{"location":"A_Configuraci%C3%B3nMikrotik.html#mantener-el-mikrotik-actualizado","title":"Mantener el Mikrotik actualizado.","text":""},{"location":"A_Configuraci%C3%B3nMikrotik.html#crear-un-nuevo-usuario-administrador","title":"Crear un nuevo usuario administrador:","text":"<p>1. Crear un nuevo usuario/contrase\u00f1a administrador (full).</p> <p>2.  Si es posible delimitar una red de mantenimiento. La gesti\u00f3n del equipo solo se podr\u00e1realizar desde un equipo con IP de dicha red.</p> <p>3.  Borrar o desactivar el anterior administrador (por defecto).</p>"},{"location":"A_Configuraci%C3%B3nMikrotik.html#deshabilitar-servicios-que-no-usaremos","title":"Deshabilitar servicios que no usaremos.","text":"<p>1. Si solo vamos a hacer uso de una gesti\u00f3n a trav\u00e9s de \u201cssh\u201d y \u201cwinbox\u201d no tiene sentido tener habilitados otros servicios. Por supuesto servicios como \u201ctelnet\u201d, \u201cftp\u201d o \u201cwww\u201d deber\u00edan ser directamente evitados.</p> <p>2. Cambiar los puertos habituales (ssh:22 y winbox: 8921).</p> <p>3. Filtrar por red de \u201cmantenimiento\u201d.</p> <p>Acordaros que si cambiamos el puerto, desde el cliente tenemos que indic\u00e1rselo</p> <p>4. En el caso de Mikrotik (no es habitual en otros fabricantes), se puede acceder a trav\u00e9s de la MAC. Para ello tiene unos servicios (MAC Server), que por norma general se deben desactivar por seguridad:</p>"},{"location":"A_Configuraci%C3%B3nMikrotik.html#deshabilitar-protocolos","title":"Deshabilitar Protocolos.","text":"<p>Existen algunos protocolos, habitualmente propietarios, que permiten descubrir o hacerte una idea de los equipos existentes en la red. Esto tambi\u00e9n puede dar informaci\u00f3n a los atacantes, adem\u00e1s de que muchas veces  estos protocolos no tienen ning\u00fan uso por parte de los administradores. En el caso de Mikrotik es \u201cNeighbor Discovery\u201d, en el caso de Cisco existe CDP (Cisco Discovery Protocol).</p>"},{"location":"A_Configuraci%C3%B3nMikrotik.html#desactivar-las-interfaces-que-no-vayan-a-usarse","title":"Desactivar las interfaces que no vayan a usarse.","text":""},{"location":"A_Configuraci%C3%B3nMikrotik.html#reglas-de-firewall-para-el-plano-de-control-chain-input","title":"Reglas de Firewall para el plano de control (chain: input).","text":"<p>Permitir pasar las conexiones ya establecidas/relacionada. Es decir, cada vez que una conexi\u00f3n con el router se establece s\u00ed se compara con las reglas de tu firewall, pero una vez la conexi\u00f3n ya est\u00e9 establecida (TCP) ya no contrastamos con ninguna regla. Esta decisi\u00f3n alivia la carga del firewall. Es importante que la regla est\u00e9 situada arriba del todo para que no mire el resto de normas.</p> <p>Una conexi\u00f3n relacionada es un tr\u00e1fico relacionado a una configuraci\u00f3n ya establecida, por ejemplo el tr\u00e1fico FTP relacionado con la sesi\u00f3n FTP establecida.</p> <pre><code>add action=accept chain=input connection-state=established,related\n</code></pre> <p>Permitir que solo tr\u00e1fico originado desde la red de mantenimiento vaya a ser atendida por el router. Para ello es recomendable crear un Address-list con los rangos de mantenimiento.</p> add action=accept chain=input src-address-list=Mantenimiento <p>Warning</p> <p>Es importante al final bloquear el resto de tr\u00e1fico. En ciertos frabricantes esta regla viene impl\u00edcita, pero no es una mala pr\u00e1ctica.</p> <p></p>add action=drop chain=input"},{"location":"A_Configuraci%C3%B3nMikrotik.html#reglas-de-firewall-para-el-plano-de-datos-chain-forward","title":"Reglas de Firewall para el plano de datos (chain: forward).","text":"<p>Al igual que hac\u00edamos, la primera regla con el fin de aliviar la carga del firewall es permitir pasar las conexiones ya establecidas. La acci\u00f3n \u201cfasttrack-connection\u201d es una opci\u00f3n especial de Mikrotik para detectar de forma r\u00e1pida que tr\u00e1fico procede de una conexi\u00f3n ya establecida correctamente.</p> <pre><code>add action=fasttrack-connection chain=forward connection-state=established,related\nadd action=accept chain=forward connection-state=established,related\n</code></pre> <p>Por otro lado bloqueamos las conexiones TCP inv\u00e1lidas (ataque TCP), estas conexiones son aquellas donde se intenta enviar tr\u00e1fico sin haber establecido previamente una conexi\u00f3n. Como una conexi\u00f3n inv\u00e1lida es posible que se deba a un ataque, le habilitamos el log=yes para que lo deje registrado, adem\u00e1s lo marcamos con la etiqueta \u201cinvalid\u201d. </p> <pre><code>add action=drop chain=forward connection-state=invalid log=yes log-prefix=invalid\n</code></pre> <p>Bloquear tr\u00e1fico que salga de nuestra LAN hacia la WAN cuya IP de destino sea una IP no v\u00e1lida en Internet (por ejemplo una IP privada).</p> <pre><code>add action=drop chain=forward dst-address-list=not_in_internet in-interface=bridge1 outinterface=ether1 log=yes log-prefix=!public_from_LAN\n</code></pre> <p>Tip</p> <p>Para el ejemplo anterior se hace uso de un address-list llamada \"not_in_internet\" que acoge todas las redes privadas y reservadas.  </p> <p>Si nuestra LAN se encuentra tras un NAT, bloquearemos cualquier tr\u00e1fico que tenga como destino las IPs sin NATEAR desde fuera de nuestra red (WAN).</p> <pre><code>add action=drop chain=forward connection-nat-state=!dstnat connection-state=new ininterface=ether1 log=yes log-prefix=!NAT\n</code></pre> <p>Bloquear todo el tr\u00e1fico que venga desde nuestra WAN con IP origen una IP no v\u00e1lida en Internet.</p> <pre><code>add action=drop chain=forward in-interface=ether1 src-address-list=not_in_internet log=yes log-prefix=!public\n</code></pre> <p>Para limitar el efecto de IP spoofing, podemos crear un filtro donde solo permitamos tr\u00e1fico desde nuestra LAN con IP origen de las redes que tenemos en ella asignadas.</p> <pre><code>add action=drop chain=forward in-interface=bridge1 src-address-list=LAN log=yes logprefix=LAN_!LAN\n</code></pre> <p>Si dentro de nuestra red no existe, o no deber\u00eda existir ning\u00fan servicio DNS o web, podr\u00eda ser una buena pol\u00edtica cortar el tr\u00e1fico entrante a nuestra red para los puertos 53 y 80. De esta forma evitamos que si por alguna casualidad alguien levanta un servicio DNS en nuestra red (sin nuestro conocimiento) \u00e9ste pueda ser atacado.</p> <p>Hemos aplicado estas reglas en el apartado de RAW por motivos de eficiencia, ya que en este apartado podemos crear filtros prerouting, es decir se ejecutan antes de comparar la tabla de rutas y saber porque interfaz deben ir dirigidos.</p>"},{"location":"A_Configuraci%C3%B3nMikrotik.html#anexo","title":"Anexo.","text":"<p>Pod\u00e9is crear los address-list o los filtros a trav\u00e9s de ssh copiando y pegando:</p> <pre><code>/ip firewall address-list\nadd address=0.0.0.0/8 comment=RFC6890 list=not_in_internet\nadd address=172.16.0.0/12 comment=RFC6890 list=not_in_internet\nadd address=192.168.0.0/16 comment=RFC6890 list=not_in_internet\nadd address=10.0.0.0/8 comment=RFC6890 list=not_in_internet\nadd address=169.254.0.0/16 comment=RFC6890 list=not_in_internet\nadd address=127.0.0.0/8 comment=RFC6890 list=not_in_internet\nadd address=224.0.0.0/4 comment=Multicast list=not_in_internet\nadd address=198.18.0.0/15 comment=RFC6890 list=not_in_internet\nadd address=192.0.0.0/24 comment=RFC6890 list=not_in_internet\nadd address=192.0.2.0/24 comment=RFC6890 list=not_in_internet\nadd address=198.51.100.0/24 comment=RFC6890 list=not_in_internet\nadd address=203.0.113.0/24 comment=RFC6890 list=not_in_internet\nadd address=100.64.0.0/10 comment=RFC6890 list=not_in_internet\nadd address=240.0.0.0/4 comment=RFC6890 list=not_in_internet\nadd address=192.88.99.0/24 comment=\"6to4 relay Anycast [RFC 3068]\"\nlist=not_in_internet\n</code></pre>"},{"location":"A_Configurar_PPTP.html","title":"PPTP","text":""},{"location":"A_Configurar_PPTP.html#servidor-pptp","title":"Servidor PPTP.","text":"<p>Vamos a configurar un servicio VPN PPTP en un equipo Mikrotik.</p>"},{"location":"A_Configurar_PPTP.html#crear-el-pool-para-clientes-vpn","title":"Crear el pool para clientes VPN.","text":"<p>Primero debemos a\u00f1adir un POOL, es decir, un rango de direcciones, que se asignar\u00e1 a la gente que se conecte a trav\u00e9s de la VPN. Este rango de IPs (pool) debe ser de la misma LAN a la que se va a acceder. </p> <ol> <li> <p>Para configurarlo vamos a \u201cIP\u201d \u27a1\ufe0f \u201cpool\u201d</p> </li> <li> <p>Limitaremos el pool del DHCP desde la IP .100 a la IP .254. (192.168.88.100-192.168.88.254).</p> </li> <li> <p>El servicio PPTP tendr\u00e1 un pool desde la .10 a la .99 (192.168.88.10-192.168.88.99).</p> </li> </ol>"},{"location":"A_Configurar_PPTP.html#configurar-ppp","title":"Configurar PPP.","text":"<p>Una vez creado el rango de direcciones que se asignaran a los clientes que se conecten crearemos un perfile PPP. Configuramos PPP porque PPTP usa el protocolo PPP tunelizado. El local address y remote address es que rango de ips se puede asignar al cliente que se conecta, es decir, el pool que hemos creado. </p> <ol> <li> <p>Vamos al men\u00fa \u201cPPP\u201d \u27a1\ufe0f \u201cProfiles\u201d \u27a1\ufe0f \u201cAdd\u201d (signo del \u201c+\u201d).</p> </li> <li> <p>Tanto el local address como el remote address son los rangos que se asignaran al cliente que se conecta, por tanto usaremos el pool que creamos en el punto anterior.</p> </li> </ol>"},{"location":"A_Configurar_PPTP.html#crear-usuarios","title":"Crear usuarios.","text":"<p>A continuaci\u00f3n crearemos un usuario y su contrase\u00f1a.</p> <ol> <li> <p>\u201cPPP\u201d \u27a1\ufe0f \u201cSecrets\u201d \u27a1\ufe0f \u201cA\u00f1adir\u201d (\u201c+\u201d).</p> </li> <li> <p>En primer lugar vamos a usar una contrase\u00f1a d\u00e9bil, por ejemplo \u201csalva\u201d.</p> </li> <li> <p>Importante que el perfil que se le asigne sea el del punto anterior.</p> </li> </ol>"},{"location":"A_Configurar_PPTP.html#activar-servicio","title":"Activar servicio.","text":"<p>Activamos el servidor.</p> <ol> <li> <p>\u201cPPP\u201d \u27a1\ufe0f \u201cInteface\u201d \u27a1\ufe0f \u201cPesta\u00f1a PPTP Server\u201d.</p> </li> <li> <p>Para activarlo debemos pinchar en \u201cEnabled\u201d.</p> </li> </ol>"},{"location":"A_Configurar_PPTP.html#configurar-firewall","title":"Configurar Firewall.","text":"<p>A continuaci\u00f3n comprobamos que el firewall permita conexiones PPTP.</p> <ol> <li> <p>Vamos al men\u00fa \u201cFirewall\u201d \u27a1\ufe0f \u201cFirewall Rules\u201d</p> </li> <li> <p>A\u00f1adimos en la pesta\u00f1a \u201cGeneral\u201d que se va a permitir la entrada (input) del protocolo TCP al puerto 1723 (por defecto usado en PPTP). Si hubi\u00e9ramos cambiado el puerto por defecto de PPTP, obviamente deber\u00edamos modificar aqu\u00ed tambi\u00e9n.</p> </li> <li> <p>Ahora en la pesta\u00f1a \u201cAction\u201d de esta misma ventana vamos a indicar que cuando detecte este flujo de datos lo va a permitir (accept).</p> </li> <li> <p>De forma habitual, se debe colocar esta regla siempre por encima (con mayor prioridad), que una regla que deniegue este tr\u00e1fico.</p> </li> </ol>"},{"location":"A_Configurar_PPTP.html#cambiar-los-puertos","title":"Cambiar los puertos.","text":"<p>En caso de querer cambiar los puertos del servicio PPTP, que no lo vamos a hacer en esta pr\u00e1ctica:</p> <ol> <li>\u201cFirewall\u201d \u27a1\ufe0f \u201cService Ports\u201d y doble click sobre el protocolo pptp.</li> </ol>"},{"location":"A_Configurar_PPTP.html#problemas-de-conexion-interna","title":"Problemas de conexi\u00f3n interna.","text":"<p>Una vez conectado, si no puedes hacer ping desde fuera a los equipos de dentro es posible que se deba a que no funciona el protocolo ARP, debemos activar proxy-arp en la interfaz local (LAN). </p> <ol> <li>Para ello vamos a \u201cInterfaces\u201d \u27a1\ufe0f \u201cbridge\u201d y activamos proxy-arp como se muestra en la imagen.</li> </ol> <p>Comprobaci\u00f3n.</p> <p>Finalmente podemos a probar a conectarnos desde un cliente, por ejemplo Windows. </p> <p>Una vez conectado en el apartado \u201cPPP\u201d \u27a1\ufe0f \u201cActive connections\u201d deber\u00eda verse los clientes activados y las IPs asignadas.</p>"},{"location":"A_IPSec.html","title":"L2TP/IPSec","text":""},{"location":"A_IPSec.html#configuracion-client-to-site-vpn-l2tpipsec","title":"Configuraci\u00f3n Client-to-Site VPN L2TP/IPsec.","text":""},{"location":"A_IPSec.html#pool-y-profile","title":"POOL y PROFILE.","text":"<p>Al igual que en la pr\u00e1ctica de PPTP vamos a crear un POOL y un PROFILE. </p> <ul> <li> <p>POOL \u27a1\ufe0f Es un rango de IPs que ser\u00e1n asignados a los clientes que se vayan conectando a la VPN. Si no se crea se debe asignar una IP de forma manual cliente por cliente.</p> </li> <li> <p>PROFILE \u27a1\ufe0f La configuraci\u00f3n de red que va a tener cada cliente que se conecte (puerta de enlace, limitaciones de anchos de banda, reglas que se le pueden aplicar, etc).</p> </li> <li> <p>Local Address \u27a1\ufe0f Es la IP que har\u00e1 de puerta de enlace dentreo de la LAN. Normalmente es la IP configurada en la parte LAN del router de la empresa (Site), en este ejemplo del propio Mikrotik. </p> </li> <li> <p>Remote Address \u27a1\ufe0f Apunta al pool, el cual es una secci\u00f3n de IPs libres de la LAN.</p> </li> </ul> <p>AVISO</p> <p>Importante que el pool no se solape con el del DHCP.</p>"},{"location":"A_IPSec.html#activar-servicio-l2tp","title":"Activar servicio L2TP.","text":"<ul> <li> <p>Secret \u27a1\ufe0f Es la contrase\u00f1a compartida (PSK).</p> </li> <li> <p>Default Profile \u27a1\ufe0f El perfil que hemos creado en el punto anterior.</p> </li> </ul> <p>SERVICIO</p> <p>En caso de tener otro servicio activo como puede ser PPTP, lo podemos desactivar.</p> <p>AUTENTIFICACI\u00d3N</p> <p>La autentificaci\u00f3n dejamos s\u00f3lo la mschap2 que ya vimos que no era segura, aunque realmente la seguridad la aportar\u00e1 IPSec.</p>"},{"location":"A_IPSec.html#personalizar-las-propuestas-de-ipsec","title":"Personalizar las propuestas de IPSec.","text":"<p>Al activar el servicio L2TP con IPSec requerido se configura autom\u00e1ticamente un perfil IPSec, se puede ver en el apartado IP \u27a1\ufe0f IPSec. </p> <p>Dentro de la subsecci\u00f3n Profile podemos ver que algoritmos de encriptaci\u00f3n se eligen para la Fase 1 de IPSec.</p> <p>Dentro de la pesta\u00f1a Proposals vemos los algoritmos de autenticaci\u00f3n que se permitir\u00e1n durante la Fase 2 de IPSec.</p> <p>PROPUESTAS</p> <p>En ambos casos de Fase 1 y Fase 2 se refiere a todos los protocolos de seguridad que se van a permitir, es decir, cuando un cliente conecte con el servidor VPN \u00e9ste le informar\u00e1 de todos los protocolos de seguridad que soporta.</p>"},{"location":"A_IPSec.html#crear-usuarios","title":"Crear Usuarios.","text":"<ul> <li> <p>Password \u27a1\ufe0f No confundir con la contrase\u00f1a compartida (PSK), deber\u00eda ser diferente.</p> </li> <li> <p>Profile \u27a1\ufe0f Es el perfil L2TP que le vamos a poner, en este caso el del primer punto en el manual de configuraci\u00f3n. Al haber establecido un \"Default Profile\" en el punto anterior en caso de dejarlo vac\u00edo se asignar\u00eda \u00e9ste.</p> </li> <li> <p>Service \u27a1\ufe0f Indica en qu\u00e9 tipos de servicios va a estar disponible este usuario.</p> </li> </ul>"},{"location":"A_IPSec.html#conectividad-lan","title":"Conectividad LAN.","text":"<p>En caso de que no haya conectividad entre equipos de la misma LAN a trav\u00e9s de la VPN deberemos configurar el \"proxy-arp\" en la parte LAN de la red, siguiente el ejemplo la parte LAN ser\u00eda el \"Bridge\" del router, que no es m\u00e1s que un conjunto de interfaces que act\u00faan como un switch dentro de una red. </p> <p>Warning</p> <p>Si no fuese necesario que hubiese conectividad entre equipos de la misma red desde un cliente VPN es  mejor dejarlo desactivado pues puede dar pie a cierto tipo de ataques.</p>"},{"location":"A_IPSec.html#firewall","title":"Firewall.","text":"<p>Es importante permitir en el firewall las peticiones L2TP/IPsec.</p>"},{"location":"A_IPSec.html#permitir-la-conexion-con-el-servidor-vpn","title":"Permitir la conexi\u00f3n con el servidor VPN.","text":"<p>Vamos a permitir las conexiones desde el exterior con el router que tengan que ver con el servicio L2TP + IPSec mediante UDP.</p> <ul> <li> <p>Input \u27a1\ufe0f Permitimos el tr\u00e1fico entrante que va dirigido al propio firewall.</p> </li> <li> <p>Puertos \u27a1\ufe0f Permitimos el tr\u00e1fico de entrada que vaya dirigido a los puertos 1701 (L2TP), 500 (ISAKMP) y 4500 (NAT-Transversal).</p> </li> </ul>"},{"location":"A_IPSec.html#permitir-ipsec","title":"Permitir IPSec","text":"<p>La segunda regla permitir\u00e1 el protocolo IPSec con ESP.</p>"},{"location":"A_ProblemasEVE.html","title":"Problemas Simulador","text":""},{"location":"A_ProblemasEVE.html#problemas-habituales-con-el-simulador","title":"Problemas habituales con el simulador.","text":""},{"location":"A_ProblemasEVE.html#sin-conexion-a-internet","title":"Sin conexi\u00f3n a Internet","text":"<p>Si al arrancar la m\u00e1quina se queda en un estado con el logo y pulsando F2 vemos que el error est\u00e1 en la tarjeta de red debemos hacer lo siguiente.</p> <p>Por ejemplo en caso de trabajar con un port\u00e1til no ser\u00e1 la misma configuraci\u00f3n si estamos usando nuestra red inal\u00e1mbrica o la al\u00e1mbrica. </p> <p>En la siguiente captura se ve c\u00f3mo podemos elegir la tarjeta de red inal\u00e1mbrica o la Ethernet.</p> <p>RED INAL\u00c1MBRICA</p> <p></p> En algunos casos es necesario usar la red cableada al dar problemas con los drivers de la red inal\u00e1mbrica."},{"location":"A_ProblemasEVE.html#kali-no-aplica-los-cambios-de-red","title":"Kali no aplica los cambios de red.","text":"<p>1. Comprobar nuestra direcci\u00f3n IP con el comando \u201cip a\u201d</p> <p>2.  Si hacemos una configuraci\u00f3n en la red, debemos reiniciar el servicio para que coja los cambios. Para ello lo m\u00e1s sencillo es desactivar y activar la red.</p>"},{"location":"A_ProblemasEVE.html#error-intel-vt-xept-o-amd-vrvi-al-abrir-la-maquina","title":"Error Intel VT-x/EPT o AMD-V/RVI al abrir la m\u00e1quina.","text":"<p>Si el simulador muestra este error al arrancar la m\u00e1quina, deberemos cerciorarnos de: </p> <p>1. Comprobar que est\u00e1 activada la opci\u00f3n en el VMWARE Player.</p> <p>2. Primero deberemos desactivar la integridad de memoria.</p> <p>Integridad de Memoria</p> <p></p> A veces tras una actualizaci\u00f3n de seguridad de Windows debemos activar y desactivarla de nuevo.  <p>3. Desactivar del men\u00fa de caracter\u00edsticas de Windows el HyperV.</p> <p>Acto seguido, abrimos un powershell como administradores del sistema (bot\u00f3n derecho) y ejecutamos:</p> <p>4. Deshabilitar Virtualization-Based Security (VBS).</p> <p>Acceder al Editor de Pol\u00edticas de Grupo: Windows + R y ejecutar gpedit.msc.</p> <p>Navegar hasta la opci\u00f3n de \"Turn on Virtualization Based Security\" y deshabilitarla.</p> <p>Finalmente reiniciar.</p> <p>5. Comprobar que la virtualizaci\u00f3n est\u00e1 activada en la BIOS.</p>"},{"location":"A_ProblemasEVE.html#el-simulador-no-carga-la-web","title":"El simulador no carga la web.","text":"<p>Esto es posiblemente a que no hemos apagado el simulador de forma adecuada (shutdown \u2013h now) y hemos apagado o directamente o congelando la m\u00e1quina.</p> <p>Ante este problema hay que reconstruir la base de datos. Para ello ejecutar este comando.</p> <pre><code>unl_wrapper -a restoredb ; grep -q default_time_zone /etc/mysql/mysql.conf.d/mysqld.cnf || echo \"default_time_zone='+00:00'\" &gt;&gt; /etc/mysql/mysql.conf.d/mysqld.cnf ; systemctl restart mysql\n</code></pre>"},{"location":"A_Site_Site_IPSec_RSA.html","title":"IPSec Site-to-Site","text":""},{"location":"A_Site_Site_IPSec_RSA.html#ipsec-site-to-site","title":"IPSec Site-to-Site.","text":""},{"location":"A_Site_Site_IPSec_RSA.html#objetivo","title":"Objetivo.","text":"<p>Crear 2 conexiones IPSec IKEv2 con certificados RSA. </p> <p>Las redes estar\u00e1n separadas por un router Cisco que simular\u00e1 lo que ser\u00eda Internet.\u00e7</p> <p>La finalidad es que los equipos Linux se vean entre ellos sin tener el router Cisco ninguna ruta sobre sus redes, adem\u00e1s se ver\u00e1 con un traceroute que el salto es directo sin pasar por el Cisco (Internet).</p> <p>GESTI\u00d3N</p> <p>La red de mantenimiento se usar\u00e1 \u00fanicamente para poder gestionar los equipos Mikrotik.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#configuracion-del-router-cisco","title":"Configuraci\u00f3n del Router Cisco.","text":"<ul> <li> <p>Levanta las interfaces \u27a1\ufe0f \"no shutdown\".</p> </li> <li> <p>Configura una IP de la red en cada interfaz \u27a1\ufe0f \"ip address IP M\u00c1SCARA\".</p> </li> <li> <p>Guarda los cambios \u27a1\ufe0f \"write\".</p> </li> </ul>"},{"location":"A_Site_Site_IPSec_RSA.html#configuracion-mikrotik","title":"Configuraci\u00f3n Mikrotik.","text":"<p>Establecer IP est\u00e1tica en interfaz que conecta con el Cisco</p> <p>Activar el dhcp client en el ether 2 para gesti\u00f3n por winbox.</p> <p>Asignar una IP al puerto LAN (eth3) y al puerto WAN (eth1). Recordad que el puerto eth2 es solo de gesti\u00f3n para que podamos llevar a cabo la configuraci\u00f3n.</p> <p>A\u00f1adir rutas a los routers para que los peers del t\u00fanel IPSec se puedan ver, es decir, que la red 192.168.100.0 y la 192.168.200.0 se vean.</p> <p>Conectividad</p> <p>Comprobar desde los equipos Linux (tinyLinux) que no llega el ping entre los hosts (192.168.88.2 y 192.168.89.2).</p>"},{"location":"A_Site_Site_IPSec_RSA.html#creacion-de-los-certificados-rsa","title":"Creaci\u00f3n de los Certificados (RSA).","text":"<p>Certificados y Firmas</p> <p>Vamos a generar y firmar todos los certificados desde un \u00fanico Mikrotik, de esta forma ahorramos tiempo.</p> <p>En una situaci\u00f3n real se podr\u00eda generar los certificados en cada router y que lo firmase la CA.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#crear-los-siguientes-certificados-en-el-mikrotik-a","title":"Crear los siguientes certificados en el Mikrotik A.","text":"<ul> <li> <p>Certificado firmado del CA (Autoridad Certificadora).</p> </li> <li> <p>Certificado y firma por nuestro propio CA para un Mikrotik A.</p> </li> <li> <p>Certificado y firma por nuestro propio  CA para el otro Mikrotik B.</p> </li> </ul>"},{"location":"A_Site_Site_IPSec_RSA.html#exportar-los-certificados","title":"Exportar los certificados.","text":"<ul> <li> <p>Certificado CA (no es necesario la firma).</p> </li> <li> <p>Certificado y clave del MikrotikB.  Para ello ser\u00e1 necesario asociarle una passphrase/contrase\u00f1a.</p> </li> </ul> <p>C\u00f3mo Exportar</p> <p>Para exportar los certificados debemos hacer bot\u00f3n derecho sobre el propio certificado \u27a1\ufe0f Export. </p> <p>En el caso que queramos tambi\u00e9n exportar la clave rellenaremos el passphrase.</p> <p></p> <p>Posteriormente deberemos ir a Files y sacar los 3 ficheros que hemos exportado (el certificado del CA, el certificado para el mikrotik B y la clave del certificado para el mikrotik B). </p> <p>Puedes seleccionar y arrastrar los certificados al escritorio.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#importar-los-certificados-en-el-mikrotik-b","title":"Importar los certificados en el Mikrotik B.","text":"<ul> <li> <p>Abre \u201cFiles\u201d y arrastra los ficheros desde el escritorio.</p> </li> <li> <p>Abre System \u27a1\ufe0f Certificates y pulsa sobre import.</p> </li> </ul> <p>En el caso del certificado del Mikrotik B y de su clave deberemos insertar el passphrase.</p> <p>IMPORTANTE QUE TODOS LOS CERTIFICADOS APAREZCAN CON LA SIGLA \u201cT\u201d DE TRUSTED. </p> <p>PODEMOS MODIFICARLO HACIENDO DOBLE CLICK SOBRE ELLOS Y MARCANDO LA OPCI\u00d3N.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#creacion-de-la-conexion-ipsec","title":"Creaci\u00f3n de la conexi\u00f3n IPSec.","text":"<p>Nos vamos a IP  \u27a1\ufe0f IPSec. Dentro de la ventana iremos configurando las diferentes pesta\u00f1as:</p>"},{"location":"A_Site_Site_IPSec_RSA.html#profiles","title":"Profiles.","text":"<p>Hace referencia a las opciones posibles para establecer el t\u00fanel de la FASE 1 de IKE.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#peer","title":"Peer.","text":"<p>Identifica la IP del otro extremo, es decir, si estamos configurando el Mikrotik A ser\u00e1 la IP del Mikrotik B.</p> <p>Debe ser una IP accesible. En nuestro caso ser\u00e1n las IPs f\u00edsicas de la WAN que conectan con Internet.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#identity","title":"Identity.","text":"<p>Indicamos en esta secci\u00f3n qu\u00e9 certificados usaremos para aunteticarnos.</p> <p>En el ejemplo estamos configurando el router de \"Valencia\" y presentaremos el certificado de Valencia al Peer \"Alicante\".</p>"},{"location":"A_Site_Site_IPSec_RSA.html#proposal","title":"Proposal.","text":"<p>Aqu\u00ed se indica los protocolos criptogr\u00e1ficos de la FASE 2 de IKE.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#policies","title":"Policies.","text":"<p>Indicamos qu\u00e9 redes se van a compartir y si vamos a usar modo t\u00fanel o transporte.</p> <p>La red source ser\u00e1 la LAN a la que tendr\u00e1n acceso a trav\u00e9s de la VPN del router que estamos configurando.</p> <p>La red destination ser\u00e1 la LAN a la que se tendr\u00e1 acceso del otro extremo.</p> <p>Tambi\u00e9n indicaremos que protocolos de cifrado usaremos.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#comprobaciones","title":"Comprobaciones.","text":"<p>Una vez realizado en ambos extremos podremos comprobar en el apartado de Policies que el t\u00fanel est\u00e1 establecido.</p> <p>Comprobamos desde los hosts que ahora s\u00ed que hay conexi\u00f3n.</p> <p>En el traceroute no deber\u00eda aparecer el router Cisco, debe parecer como si estuvieramos en la misma red y la conexi\u00f3n fuese directa.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#video-de-ejemplo","title":"V\u00eddeo de Ejemplo.","text":""},{"location":"A_Site_Site_IPSec_RSA.html#conexion-site-to-site-con-nat","title":"Conexi\u00f3n Site-to-Site con NAT.","text":"<p>En caso de que las LANs tengan un NAT, tendremos que cambiar la configuraci\u00f3n del router/firewall para que el tr\u00e1fico VPN no sea traducido (NATeado).</p> <p>Vamos a crear un ambiente m\u00e1s realista y generar la LAN detr\u00e1s de un NAT.</p>"},{"location":"A_Site_Site_IPSec_RSA.html#crear-el-nat-en-las-lans","title":"Crear el NAT en las LANs.","text":"<p>Para crear un Source NAT, como el que podemos tener en una casa debemos ejecutar en ambos routers Mikrotik una regla:</p> <p>IP \u27a1\ufe0f Firewall \u27a1\ufe0f NAT \u27a1\ufe0f Add:</p> <ul> <li> <p>Chain: src-nat </p> </li> <li> <p>Action: masquerade (para que haga traducci\u00f3n PAT es decir por puertos).</p> </li> <li> <p>Out Interface: ether1 (es la interfaz WAN).</p> </li> </ul>"},{"location":"A_Site_Site_IPSec_RSA.html#permitir-trafico-entre-las-redes","title":"Permitir tr\u00e1fico entre las redes.","text":"<p>La idea es permitir el tr\u00e1fico a trav\u00e9s de la VPN, para ello crearemos una regla que si detecta que el tr\u00e1fico viene de la VPN \u00e9sta comunicaci\u00f3n se har\u00e1 sin NAT.</p> <p>Tabla RAW</p> <p>Es una tabla donde podemos ver el tr\u00e1fico de paquetes antes de que hayan realizado el seguimiento de la conexi\u00f3n. </p> <p>Suele usarse para cortar un DDoS de forma m\u00e1s eficiente puesto que al no haberse realizado el seguimiento de la conexi\u00f3n a\u00fan alivia la carga de la CPU.</p> <p>Tracking</p> <p>Un seguimiento de la conexi\u00f3n es cuando sabemos que dos ordenadores han establecido una conexi\u00f3n TCP y est\u00e1n pas\u00e1ndose informaci\u00f3n, al hacer un seguimiento (Tracking) registramos y analizamos los datos de \u00e9stos. </p> <p>En IP \u27a1\ufe0f Firewall \u27a1\ufe0f Connections podemos ver ese seguimiento. </p> <p>Dentro de la tabla RAW se diferencian dos tipos de tr\u00e1fico:</p> <ul> <li> <p>PREROUTING: Tr\u00e1fico que llega al router y a\u00fan no ha sido procesado a trav\u00e9s de la tabla de rutas para ver su destino.</p> </li> <li> <p>OUTPUT: Tr\u00e1fico originado por el propio router.</p> </li> </ul> <p>Vamos a a\u00f1adir dos reglas en ambos extremos para que no se realice un track de las conexiones entre las sedes IPSEC.</p> <p>IP \u27a1\ufe0f Firewall \u27a1\ufe0f Raw \u27a1\ufe0f Add:</p> <ul> <li> <p>Chain: Prerouting.</p> </li> <li> <p>Action: No track.</p> </li> <li> <p>Src Address: LAN_SEDE_A</p> </li> <li> <p>Destination: LAN_SEDE_B</p> </li> </ul> <p>Volvemos a a\u00f1adir la misma regla intercambiando los direccionamientos para el tr\u00e1fico en sentido inverso.</p> <p>Una vez hecho ya volveremos a tener conectividad a trav\u00e9s de la VPN Site-To-Site desde los extremos.</p> \u00bfQu\u00e9 problemas podr\u00eda tener esta soluci\u00f3n? <p>Al no hacer seguimiento de las conexiones que vienen a trav\u00e9s de la VPN tendr\u00edamos menos visibilidad si se produjese un ataque de esta red.</p>"},{"location":"A_Usuarios.html","title":"Usuarios EVE-NG","text":""},{"location":"A_Usuarios.html#usuarios","title":"Usuarios.","text":"Comando  Funci\u00f3n  <code>Sistema EVE-NG</code> root/eve. <code>Servicio Web EVE-NG</code> admin/eve. <code>Kali</code> usuario/usuario. <code>Mikrotik</code> admin - sin contrase\u00f1a. <code>Juniper</code> lab/lab123. <code>Windows Server</code> Administrador/Usuario1234. <code>Sophos WEB</code> admin/Usuario1234#   LAN PortA - 192.168.66.1:4444. <code>Sophos CLI</code> admin. <code>OPNsense</code> root / opnsense"}]}